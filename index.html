<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sori - Learn Korean</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
  * { box-sizing: border-box; }
  
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
    max-width: 680px; 
    margin: 0 auto; 
    padding: 12px;
    background: #faf8ff;
    min-height: 100vh;
  }
  
  h1 { 
    font-size: 24px; 
    margin: 0 0 4px 0; 
    color: #7c3aed;
    font-weight: 800;
  }
  
  .intro {
    color: #9ca3af;
    font-size: 12px;
    margin-bottom: 10px;
    line-height: 1.3;
    font-weight: 500;
  }
  
  .card { 
    border-radius: 16px; 
    padding: 16px; 
    margin: 8px 0; 
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    background: white;
  }
  
  .category-tabs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
    margin-bottom: 8px;
  }
  
  .tab-button {
    padding: 10px 14px;
    border: 2px solid #f3f4f6;
    border-radius: 14px;
    background: #f9fafb;
    color: #9ca3af;
    cursor: pointer;
    font-size: 13px;
    font-weight: 700;
    transition: all 0.2s;
  }
  
  .tab-button:hover {
    background: #f3f4f6;
  }
  
  .tab-button.active {
    background: #7c3aed;
    color: white;
    border-color: #7c3aed;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
  }
  
  .sub-filters {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 8px;
    padding: 10px;
    background: #f9fafb;
    border-radius: 10px;
  }
  
  .filter-chip {
    padding: 5px 10px;
    border-radius: 14px;
    background: white;
    border: 2px solid #e5e7eb;
    color: #6b7280;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .filter-chip:hover {
    background: #f9fafb;
  }
  
  .filter-chip.active {
    background: #7c3aed;
    color: white;
    border-color: #7c3aed;
  }
  
  .badge {
    display: inline-block;
    background: #7c3aed;
    color: white;
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 800;
    margin-bottom: 5px;
  }
  
  .context-box {
    background: #f9fafb;
    border-radius: 8px;
    padding: 6px 10px;
    margin-bottom: 10px;
    font-size: 12px;
    color: #6b7280;
    font-weight: 600;
  }
  
  .korean-section {
    background: #f9fafb;
    border-radius: 14px;
    padding: 16px 12px;
    margin: 8px 0;
  }
  
  .target-display {
    font-size: 28px;
    font-weight: 900;
    color: #1f2937;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 8px;
  }
  
  .pronunciation-hint {
    color: #9ca3af;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    letter-spacing: 0.3px;
    margin-bottom: 8px;
    font-style: italic;
  }
  
  .english-translation {
    color: #9ca3af;
    font-size: 14px;
    text-align: center;
    margin-bottom: 0;
    font-weight: 600;
    font-style: italic;
  }
  
  .pronunciation-section {
    display: none;
  }
  
  button { 
    padding: 12px 18px; 
    border: 0; 
    border-radius: 14px; 
    background: #7c3aed;
    color: white; 
    cursor: pointer; 
    font-size: 15px;
    font-weight: 800;
    width: 100%;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
    transition: all 0.2s;
  }
  
  button:hover {
    background: #6d28d9;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
  }
  
  button:disabled { 
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  button.secondary {
    background: #f9fafb;
    color: #6b7280;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }
  
  button.secondary:hover {
    background: #f3f4f6;
  }
  
  .button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    margin-top: 8px;
  }
  
  .practice-tip {
    background: #fffbeb;
    border-left: 3px solid #f59e0b;
    padding: 8px 12px;
    border-radius: 10px;
    margin-top: 8px;
    font-size: 12px;
    color: #92400e;
    line-height: 1.4;
    font-weight: 500;
  }
  
  .repetition-tracker {
    margin: 8px 0;
    padding: 10px;
    background: #f9fafb;
    border-radius: 10px;
  }
  
  .repetition-label {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 8px;
    text-align: center;
  }
  
  .repetition-dots {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-bottom: 8px;
  }
  
  .rep-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .rep-dot.completed {
    background: #7c3aed;
    border-color: #7c3aed;
    transform: scale(1.1);
  }
  
  .congratulations {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    margin: 8px 0;
    display: none;
    animation: slideIn 0.5s ease-out;
  }
  
  .congratulations.show {
    display: block;
  }
  
  .congratulations-emoji {
    font-size: 36px;
    margin-bottom: 4px;
  }
  
  .congratulations-text {
    font-size: 16px;
    font-weight: 800;
    color: #92400e;
    margin-bottom: 2px;
  }
  
  .congratulations-subtext {
    font-size: 12px;
    color: #92400e;
    font-weight: 600;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .progress {
    text-align: center;
    color: #7c3aed;
    font-size: 13px;
    font-weight: 700;
    margin-top: 8px;
  }
  
  .voice-speed {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 8px;
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
  }
  
  .voice-speed label {
    color: #7c3aed;
    font-size: 12px;
    font-weight: 600;
  }
  
  .voice-speed input { 
    width: 110px;
    cursor: pointer;
  }
  
  .voice-speed input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 5px;
    background: #e5e7eb;
    border-radius: 10px;
    outline: none;
  }
  
  .voice-speed input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #7c3aed;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .voice-speed input[type="range"]::-webkit-slider-thumb:hover {
    background: #6d28d9;
    transform: scale(1.1);
  }
  
  .voice-speed input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #7c3aed;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .voice-speed input[type="range"]::-moz-range-thumb:hover {
    background: #6d28d9;
    transform: scale(1.1);
  }
  
  .voice-speed span {
    color: #7c3aed;
    font-weight: 700;
    font-size: 12px;
    min-width: 45px;
  }
  
  .error-msg {
    background: #fee2e2;
    color: #991b1b;
    padding: 8px 12px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 11px;
    font-weight: 600;
    display: none;
  }
  
  @media (max-width: 640px) {
    body { padding: 12px; }
    h1 { font-size: 24px; }
    .card { padding: 16px; }
    .target-display { font-size: 28px; }
    .pronunciation-hint { font-size: 15px; }
    .category-tabs {
      grid-template-columns: 1fr;
    }
  }
  
  .auth-section {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
  }
  
  .auth-section:not(.hidden) {
    display: flex;
  }
  
  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
  }
  
  .header-left {
    flex: 1;
  }
  
  .header-right {
    display: flex;
    gap: 8px;
  }
  
  .login-btn {
    background: #7c3aed;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .login-btn:hover {
    background: #6d28d9;
  }
  
  .my-btn {
    background: #f9fafb;
    color: #6b7280;
    border: 2px solid #e5e7eb;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .my-btn:hover {
    background: #f3f4f6;
  }
  
  .auth-section.hidden {
    display: none;
  }
  
  .auth-card {
    background: white;
    padding: 40px;
    border-radius: 24px;
    text-align: center;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    pointer-events: auto;
  }
  
  .auth-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    font-size: 28px;
    color: #9ca3af;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    line-height: 1;
    padding: 0;
  }
  
  .auth-close:hover {
    background: #f3f4f6;
    color: #6b7280;
  }
  
  .auth-card {
    background: white;
    padding: 40px;
    border-radius: 24px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  .auth-title {
    font-size: 28px;
    font-weight: 800;
    color: #7c3aed;
    margin-bottom: 8px;
  }
  
  .auth-subtitle {
    font-size: 14px;
    color: #9ca3af;
    margin-bottom: 24px;
  }
  
  .google-login-btn {
    background: white;
    border: 2px solid #e5e7eb;
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    pointer-events: auto;
    user-select: none;
  }
  
  .google-login-btn svg {
    pointer-events: none;
  }
  
  .google-login-btn:hover {
    background: #f9fafb;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }
  
  .google-login-btn:active {
    transform: translateY(0);
    background: #f3f4f6;
  }
  
  .user-profile {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  
  .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #7c3aed;
  }
  
  .user-info {
    flex: 1;
    text-align: left;
  }
  
  .user-name {
    font-size: 13px;
    font-weight: 700;
    color: #1f2937;
  }
  
  .user-level {
    font-size: 11px;
    color: #7c3aed;
    font-weight: 600;
  }
  
  .logout-btn {
    background: #f9fafb;
    border: none;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
  }
  
  .logout-btn:hover {
    background: #f3f4f6;
  }
  
  .stats-card {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
    margin-bottom: 8px;
  }
  
  .stat-item {
    background: #f9fafb;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 18px;
    font-weight: 800;
    color: #7c3aed;
  }
  
  .stat-label {
    font-size: 10px;
    color: #6b7280;
    font-weight: 600;
    margin-top: 3px;
  }
</style>
</head>
<body>
  <!-- Auth Modal (Hidden) -->
  <div class="auth-section hidden" id="authModal" onclick="if(event.target.id==='authModal') document.getElementById('authModal').classList.add('hidden')">
    <div class="auth-card" onclick="event.stopPropagation()">
      <button class="auth-close" onclick="document.getElementById('authModal').classList.add('hidden')">×</button>
      <div class="auth-title">Welcome to Sori! 💜</div>
      <div class="auth-subtitle">Sign in to track your progress and level up</div>
      <button class="google-login-btn" id="googleLoginBtn" onclick="console.log('Button physically clicked!'); handleGoogleLogin()">
        <svg width="20" height="20" viewBox="0 0 20 20">
          <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
          <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
          <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
          <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  <!-- Header with Login/My buttons -->
  <div class="header-container">
    <div class="header-left">
      <h1>Sori - Learn Korean</h1>
      <div class="intro">Master Korean with K-Drama lines and daily conversations 💕</div>
    </div>
    <div class="header-right">
      <button class="login-btn" id="loginBtn" onclick="document.getElementById('authModal').classList.remove('hidden')">Login</button>
      <button class="my-btn" id="myBtn" onclick="handleMyButton()">My</button>
    </div>
  </div>

  <!-- User Profile (Hidden initially) -->
  <div id="userSection" style="display:none;">
    <div class="user-profile">
      <img id="userAvatar" class="user-avatar" src="" alt="User">
      <div class="user-info">
        <div class="user-name" id="userName">User Name</div>
        <div class="user-level" id="userLevel">Level 1 - Beginner</div>
      </div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
    
    <div class="card stats-card">
      <div class="stat-item">
        <div class="stat-value" id="totalDays">0</div>
        <div class="stat-label">Total Days</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="streak">0</div>
        <div class="stat-label">Streak 🔥</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="xpPoints">0</div>
        <div class="stat-label">XP Points</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="category-tabs">
      <button class="tab-button active" id="dailyBtn">💬 Daily</button>
      <button class="tab-button" id="travelBtn">✈️ Travel</button>
      <button class="tab-button" id="dramaBtn">🎭 K-Drama</button>
    </div>
    
    <div id="subFilters" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="badge" id="badge">Greeting</div>
    <div class="context-box" id="context">Conversation: First meeting</div>
    
    <div class="korean-section">
      <div class="target-display" id="korean">안녕하세요.</div>
      <div class="pronunciation-hint" id="pronunciation">annyeonghaseyo</div>
      <div class="english-translation" id="english">"Hello"</div>
    </div>
    
    <div class="repetition-tracker">
      <div class="repetition-label">🎯 Practice Count: <span id="repCount">0</span> / 5</div>
      <div class="repetition-dots" id="repDots">
        <div class="rep-dot" id="dot1"></div>
        <div class="rep-dot" id="dot2"></div>
        <div class="rep-dot" id="dot3"></div>
        <div class="rep-dot" id="dot4"></div>
        <div class="rep-dot" id="dot5"></div>
      </div>
    </div>
    
    <div class="congratulations" id="congrats">
      <div class="congratulations-emoji">🎉</div>
      <div class="congratulations-text">참 잘했어요!</div>
      <div class="congratulations-subtext">Great job! Ready for the next one?</div>
    </div>
    
    <button id="playBtn">🔊 Listen & Repeat</button>
    <div class="error-msg" id="errorMsg"></div>
    
    <div class="voice-speed">
      <label>Speed:</label>
      <input type="range" id="speed" min="0.3" max="1.0" step="0.1" value="0.75">
      <span id="speedTxt">0.75x</span>
    </div>
    
    <div class="practice-tip">
      💡 <strong>Tip:</strong> Listen carefully and repeat multiple times. Consistency is key!
    </div>
  </div>

  <div class="card">
    <div class="button-group">
      <button class="secondary" id="prevBtn">◀ Previous</button>
      <button class="secondary" id="nextBtn">▶ Next</button>
    </div>
    <div class="progress" id="prog">1 / 30</div>
  </div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBXxvK_your_api_key_here",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};

// Initialize Firebase
let auth, db, currentUser = null;
let firebaseInitialized = false;

console.log('Attempting Firebase initialization...');

try {
  if (typeof firebase !== 'undefined') {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    firebaseInitialized = true;
    console.log('✅ Firebase initialized successfully');
  } else {
    console.log('⚠️ Firebase SDK not loaded');
  }
} catch (e) {
  console.log('⚠️ Firebase initialization skipped - demo mode:', e.message);
  // This is expected if Firebase config is not set up
}

// User Management
const userState = {
  uid: null,
  name: null,
  email: null,
  photoURL: null,
  level: 1,
  xp: 0,
  totalDays: 0,
  streak: 0,
  lastVisit: null,
  practiceCount: {}
};

function calculateLevel(xp) {
  if (xp < 100) return 1;
  if (xp < 300) return 2;
  if (xp < 600) return 3;
  if (xp < 1000) return 4;
  if (xp < 1500) return 5;
  return Math.floor(xp / 300) + 1;
}

function getLevelName(level) {
  const levels = ['Beginner', 'Elementary', 'Intermediate', 'Advanced', 'Expert', 'Master'];
  return levels[Math.min(level - 1, levels.length - 1)] || 'Master';
}

async function checkAndUpdateAttendance() {
  if (!currentUser || !db) return;
  
  const today = new Date().toDateString();
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  
  if (userState.lastVisit !== today) {
    const isConsecutive = userState.lastVisit === yesterday;
    
    userState.lastVisit = today;
    userState.totalDays += 1;
    userState.streak = isConsecutive ? userState.streak + 1 : 1;
    userState.xp += 10; // Daily login bonus
    
    await db.collection('users').doc(currentUser.uid).set({
      ...userState,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    updateUserUI();
    showError('🎉 Daily check-in complete! +10 XP');
  }
}

async function loadUserData() {
  if (!currentUser || !db) return;
  
  try {
    const doc = await db.collection('users').doc(currentUser.uid).get();
    
    if (doc.exists) {
      const data = doc.data();
      userState.level = data.level || 1;
      userState.xp = data.xp || 0;
      userState.totalDays = data.totalDays || 0;
      userState.streak = data.streak || 0;
      userState.lastVisit = data.lastVisit || null;
      userState.practiceCount = data.practiceCount || {};
    } else {
      // First time user
      userState.lastVisit = new Date().toDateString();
      userState.totalDays = 1;
      userState.streak = 1;
      userState.xp = 10;
      
      await db.collection('users').doc(currentUser.uid).set({
        ...userState,
        uid: currentUser.uid,
        email: currentUser.email,
        name: currentUser.displayName,
        photoURL: currentUser.photoURL,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    await checkAndUpdateAttendance();
  } catch (error) {
    console.error('Error loading user data:', error);
  }
}

function updateUserUI() {
  document.getElementById('userName').textContent = userState.name || 'User';
  document.getElementById('userLevel').textContent = `Level ${userState.level} - ${getLevelName(userState.level)}`;
  document.getElementById('totalDays').textContent = userState.totalDays;
  document.getElementById('streak').textContent = userState.streak;
  document.getElementById('xpPoints').textContent = userState.xp;
  
  if (userState.photoURL) {
    document.getElementById('userAvatar').src = userState.photoURL;
  }
}

async function updatePracticeStats() {
  if (!currentUser || !db) return;
  
  const phraseId = st.filteredLines[st.i].k;
  userState.practiceCount[phraseId] = (userState.practiceCount[phraseId] || 0) + 5;
  userState.xp += 5; // XP for completing a phrase
  
  const newLevel = calculateLevel(userState.xp);
  if (newLevel > userState.level) {
    userState.level = newLevel;
    showError(`🎊 Level Up! You are now Level ${newLevel} - ${getLevelName(newLevel)}!`);
  }
  
  await db.collection('users').doc(currentUser.uid).update({
    xp: userState.xp,
    level: userState.level,
    practiceCount: userState.practiceCount,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  updateUserUI();
}

// Standalone functions for inline onclick handlers (must be global)
window.handleGoogleLogin = function() {
  console.log('🔘 Google login button clicked!');
  
  if (!auth) {
    console.log('⚠️ Firebase not configured');
    alert('🔧 Demo Mode - Firebase Not Configured\n\nTo enable real Google login:\n\n1. Go to firebase.google.com\n2. Create a new project\n3. Enable Google Authentication\n4. Get your config and replace firebaseConfig in the code\n\nFor now, you can test the app without login!');
    document.getElementById('authModal').classList.add('hidden');
    return;
  }
  
  console.log('✅ Firebase configured, attempting login...');
  const provider = new firebase.auth.GoogleAuthProvider();
  
  auth.signInWithPopup(provider)
    .then((result) => {
      console.log('✅ Login successful!', result.user);
      document.getElementById('authModal').classList.add('hidden');
      alert('✅ Login successful! Welcome ' + result.user.displayName);
    })
    .catch((error) => {
      console.error('❌ Login error:', error);
      alert('❌ Login failed: ' + error.message);
    });
};

window.handleMyButton = function() {
  console.log('👤 My button clicked');
  
  if (currentUser) {
    const msg = `👤 Your Profile\n\n` +
      `Name: ${userState.name}\n` +
      `Email: ${userState.email}\n` +
      `Level: ${userState.level} - ${getLevelName(userState.level)}\n` +
      `Total XP: ${userState.xp}\n` +
      `Total Days: ${userState.totalDays}\n` +
      `Current Streak: ${userState.streak} 🔥`;
    alert(msg);
  } else {
    alert('⚠️ Please login first to view your profile!');
    document.getElementById('authModal').classList.remove('hidden');
  }
};

// Auth state observer
if (auth) {
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      userState.uid = user.uid;
      userState.name = user.displayName;
      userState.email = user.email;
      userState.photoURL = user.photoURL;
      
      document.getElementById('authModal').classList.add('hidden');
      document.getElementById('userSection').style.display = 'block';
      document.getElementById('loginBtn').style.display = 'none';
      
      await loadUserData();
      updateUserUI();
    } else {
      currentUser = null;
      document.getElementById('userSection').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'block';
    }
  });
}

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ DOM loaded successfully');

  // Logout button (still needs event listener since it's in userSection which may not exist initially)
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      if (!auth) return;
      
      try {
        await auth.signOut();
        console.log('✅ Logged out successfully');
      } catch (error) {
        console.error('❌ Logout error:', error);
      }
    });
  }
  
  console.log('✅ All event listeners set up');
});

// Data arrays
const drama = [
  {t:'Goblin',c:'Kim Shin to Eun-tak',k:'너는, 내가 잃은 모든 날들이다.',e:'You are all the days I lost',p:'neoneun, naega ireun modeun naldeulida',sub:'Goblin'},
  {t:'Goblin',c:'Eun-tak reflection',k:'혼자였던 시간도, 나를 만들었어.',e:'Even my lonely days shaped me',p:'honjayotteon sigando, nareul mandeureosseo',sub:'Goblin'},
  {t:'Crash Landing on You',c:'Ri Jeong-hyeok',k:'널 좋아한 게, 잘못이었을까?',e:'Was it wrong that I liked you?',p:'neol joahan ge, jalmosieosseulkka',sub:'Crash Landing'},
  {t:'Crash Landing on You',c:'Yoon Se-ri',k:'끝이라고 생각한 순간, 다시 시작됐어.',e:'When I thought it was over it began again',p:'kkeutirago saenggakan sungan, dasi sijakdwaesseo',sub:'Crash Landing'},
  {t:'Itaewon Class',c:'Park Sae-ro-yi',k:'나는, 내 방식대로 간다.',e:'I go my own way',p:'naneun, nae bangsikdaero ganda',sub:'Itaewon'},
  {t:'SKY Castle',c:'Kang Ye-seo',k:'숨 좀 쉬게 해줘.',e:'Let me breathe, please',p:'sum jom swige haejwo',sub:'SKY Castle'},
  {t:'Descendants of the Sun',c:'Yoo Si-jin',k:'부르면 가고, 안 부르면 안 가.',e:'If you call I go if not I stay',p:'bureumyeon gago, an bureumyeon an ga',sub:'Descendants'},
  {t:'My Love from the Star',c:'Cheon Song-yi',k:'첫눈 오는 날엔, 용기가 필요해.',e:'On the first snow you need courage',p:'cheotnun oneun naren, yonggiga piryohae',sub:'My Love'},
  {t:'Mr. Sunshine',c:'Go Ae-shin',k:'슬픈 날엔, 내 어깨 빌려줄게요.',e:'On sad days you can lean on my shoulder',p:'seulpeun naren, nae eokkae billyeojulgeyo',sub:'Mr. Sunshine'},
  {t:'Reply 1988',c:'Deok-sun',k:'오늘도 파이팅!',e:'Fighting for today',p:'oneuldo paiting',sub:'Reply 1988'},
  {t:'Hospital Playlist',c:'Ik-jun',k:'밥은 꼭 챙겨 먹어.',e:'Remember to eat your meals',p:'babeun kkok chaenggyeo meogeo',sub:'Hospital'},
  {t:'Extraordinary Attorney Woo',c:'Woo Young-woo',k:'기러기, 토마토, 스위스, 인도인.',e:'Palindrome wordplay',p:'girugi, tomato, seuwiseu, indoin',sub:'Attorney Woo'},
  {t:'Twenty Five Twenty One',c:'Na Hee-do',k:'지금 이 순간이, 전부야.',e:'This moment is everything',p:'jigeum i sungani, jeonbuya',sub:'Twenty Five'},
  {t:'D.P.',c:'Jun-ho',k:'괜찮아. 버틸 수 있어.',e:'It is okay we can endure',p:'gwaenchana. beotil su isseo',sub:'D.P.'},
  {t:'Signal',c:'Detective',k:'포기하면, 거기서 끝이야.',e:'If you give up it ends there',p:'pogihamyeon, geogiseo kkeusiya',sub:'Signal'},
  {t:'Our Blues',c:'Mother',k:'천천히 해도, 괜찮아.',e:'It is okay to go slow',p:'cheoncheonhi haedo, gwaenchana',sub:'Our Blues'},
  {t:'Hometown Cha Cha Cha',c:'Hong Du-sik',k:'답은 늘, 가까이에 있어.',e:'The answer is always close by',p:'dabeun neul, gakkaie isseo',sub:'Hometown'},
  {t:'Misaeng',c:'Manager Oh',k:'작은 성실이, 큰 변화를 만든다.',e:'Small diligence makes big change',p:'jageun seongsiri, keun byeonhwareul mandeunda',sub:'Misaeng'}
];

const daily = [
  {t:'Greeting',c:'First meeting',k:'안녕하세요.',e:'Hello',p:'annyeonghaseyo',sub:'Greeting'},
  {t:'Greeting',c:'Casual hi',k:'안녕!',e:'Hi',p:'annyeong',sub:'Greeting'},
  {t:'Greeting',c:'Long time',k:'오랜만이에요!',e:'Long time no see!',p:'oraenmanieyo',sub:'Greeting'},
  {t:'Greeting',c:'How are you',k:'잘 지냈어요?',e:'Have you been well?',p:'jal jinaesseoyo',sub:'Greeting'},
  {t:'Greeting',c:'Introduction',k:'저는 민우예요.',e:'I am Minwoo',p:'jeoneun minuyeyo',sub:'Greeting'},
  {t:'Cafe',c:'Order',k:'아메리카노 한 잔, 주세요.',e:'One americano, please',p:'amerikano han jan, juseyo',sub:'Cafe'},
  {t:'Cafe',c:'Size',k:'라지로 부탁드립니다.',e:'Large, please',p:'rajiro butakdeurimnida',sub:'Cafe'},
  {t:'Cafe',c:'To go',k:'포장할게요.',e:'To go, please',p:'pojanghalgeyo',sub:'Cafe'},
  {t:'Cafe',c:'No ice',k:'얼음은 빼 주세요.',e:'No ice, please',p:'eoreumeun ppae juseyo',sub:'Cafe'},
  {t:'Cafe',c:'Compliment',k:'커피가 정말 맛있네요!',e:'The coffee is really good',p:'keopiga jeongmal masinneyo',sub:'Cafe'},
  {t:'Restaurant',c:'Table',k:'두 명이에요.',e:'Table for two',p:'du myeongieyo',sub:'Restaurant'},
  {t:'Restaurant',c:'Recommendation',k:'추천 메뉴가 있나요?',e:'Do you have a recommendation?',p:'chucheon menyuga innayo',sub:'Restaurant'},
  {t:'Restaurant',c:'Not spicy',k:'안 매운 걸로, 주세요.',e:'Not spicy, please',p:'an maeun geollo, juseyo',sub:'Restaurant'},
  {t:'Restaurant',c:'More water',k:'물 좀 더 주시겠어요?',e:'Could I get more water?',p:'mul jom deo jusigesseoyo',sub:'Restaurant'},
  {t:'Restaurant',c:'Check',k:'계산서 부탁드려요.',e:'Check, please',p:'gyesanseo butakdeuryeoyo',sub:'Restaurant'},
  {t:'Shopping',c:'Price',k:'얼마예요?',e:'How much is it?',p:'eolmayeyo',sub:'Shopping'},
  {t:'Shopping',c:'Try on',k:'입어봐도 될까요?',e:'May I try this on?',p:'ibeobwado doelkkayo',sub:'Shopping'},
  {t:'Shopping',c:'Other color',k:'다른 색, 있어요?',e:'Do you have another color?',p:'dareun saek, isseoyo',sub:'Shopping'},
  {t:'Shopping',c:'Discount',k:'할인 가능할까요?',e:'Is a discount possible?',p:'halin ganeunhalkkayo',sub:'Shopping'},
  {t:'Shopping',c:'Card payment',k:'카드로 결제할게요.',e:'I will pay by card',p:'kadeuro gyeoljehalgeyo',sub:'Shopping'},
  {t:'Health',c:'Headache',k:'머리가 아파요.',e:'I have a headache',p:'meoriga apayo',sub:'Health'},
  {t:'Health',c:'Cold medicine',k:'감기약, 있어요?',e:'Do you have cold medicine?',p:'gamgiyak, isseoyo',sub:'Health'},
  {t:'Health',c:'Allergy',k:'땅콩 알레르기가 있어요.',e:'I have a peanut allergy',p:'ttangkong allerugiga isseoyo',sub:'Health'},
  {t:'Health',c:'Where hurts',k:'어디가 아프세요?',e:'Where does it hurt?',p:'eodiga apeuseyo',sub:'Health'},
  {t:'Health',c:'After meals',k:'식후에 드세요.',e:'Take it after meals',p:'sikhue deuseyo',sub:'Health'},
  {t:'Social',c:'Compliment',k:'정말 잘하시네요!',e:'You are really good!',p:'jeongmal jalhasineyo',sub:'Social'},
  {t:'Social',c:'Movie invite',k:'같이 영화 보러 갈래요?',e:'Do you want to see a movie?',p:'gachi yeonghwa boreo gallaeyo',sub:'Social'},
  {t:'Social',c:'Decline',k:'미안하지만, 오늘은 어려워요.',e:'Sorry, but today is difficult',p:'mianhajiman, oneureun eoryeowoyo',sub:'Social'},
  {t:'Social',c:'Tomorrow',k:'내일 시간, 괜찮으세요?',e:'Are you free tomorrow?',p:'naeil sigan, gwaenchanseuseyo',sub:'Social'},
  {t:'Social',c:'Thank you',k:'도와주셔서 감사합니다.',e:'Thank you for your help',p:'dowajusyeoseo gamsahamnida',sub:'Social'}
];

const travel = [
  {t:'Airport',c:'Tourism',k:'관광하러 왔습니다.',e:'I am here for tourism',p:'gwangwanghareo wasseumnida',sub:'Airport'},
  {t:'Airport',c:'One week',k:'일주일 머물 예정입니다.',e:'I will stay for one week',p:'iljuil meomul yejeongimnida',sub:'Airport'},
  {t:'Airport',c:'Lost baggage',k:'수하물이 안 나왔어요.',e:'My baggage did not come out',p:'suhamuri an nawasseoyo',sub:'Airport'},
  {t:'Airport',c:'Airport bus',k:'공항버스는 어디에서 타요?',e:'Where do I take the airport bus?',p:'gonghang beoseuneun eodieseo tayo',sub:'Airport'},
  {t:'Airport',c:'Exchange',k:'환전은 어디서 해요?',e:'Where can I exchange money?',p:'hwanjeoneun eodiseo haeyo',sub:'Airport'},
  {t:'Hotel',c:'Check in',k:'예약했어요. 체크인 하고 싶어요.',e:'I have a reservation. I want to check in',p:'yeyakhaesseoyo. chekeuinhago sipeoyo',sub:'Hotel'},
  {t:'Hotel',c:'WiFi',k:'와이파이 비밀번호가 뭐예요?',e:'What is the WiFi password?',p:'waipai bimilbeonhoga mwoyeyo',sub:'Hotel'},
  {t:'Hotel',c:'Towels',k:'수건을 더 가져다 주세요.',e:'Please bring more towels',p:'sugeoneul deo gajyeoda juseyo',sub:'Hotel'},
  {t:'Hotel',c:'No hot water',k:'온수가 나오지 않아요.',e:'There is no hot water',p:'onsuga naoji anayo',sub:'Hotel'},
  {t:'Hotel',c:'Check out',k:'체크아웃은 몇 시예요?',e:'What time is check out?',p:'chekeuauseun myeot siyeyo',sub:'Hotel'},
  {t:'Transport',c:'Subway',k:'지하철역이 어디예요?',e:'Where is the subway station?',p:'jihacheol yeogi eodiyeyo',sub:'Transport'},
  {t:'Transport',c:'Direction',k:'이쪽으로 쭉 가세요.',e:'Go straight this way',p:'ijjogeuro jjuk gaseyo',sub:'Transport'},
  {t:'Transport',c:'Transfer',k:'여기서 갈아타야 해요.',e:'I need to transfer here',p:'yeogiseo garataya haeyo',sub:'Transport'},
  {t:'Transport',c:'Last train',k:'막차가 몇 시예요?',e:'What time is the last train?',p:'makchaga myeot siyeyo',sub:'Transport'},
  {t:'Transport',c:'Top up card',k:'교통카드 충전하고 싶어요.',e:'I want to top up my transit card',p:'gyotong kadeu chungjeonhago sipeoyo',sub:'Transport'},
  {t:'Emergency',c:'Help',k:'도와주세요!',e:'Please help me!',p:'dowajuseyo',sub:'Emergency'},
  {t:'Emergency',c:'Police',k:'경찰을 불러 주세요.',e:'Call the police, please',p:'gyeongchareul bulleo juseyo',sub:'Emergency'},
  {t:'Emergency',c:'Hospital',k:'병원에 가야 해요.',e:'I need to go to a hospital',p:'byeongwone gaya haeyo',sub:'Emergency'},
  {t:'Emergency',c:'Lost wallet',k:'지갑을 잃어버렸어요.',e:'I lost my wallet',p:'jigabeul ileobeoryeosseoyo',sub:'Emergency'},
  {t:'Emergency',c:'Lost',k:'길을 잃었어요.',e:'I am lost',p:'gireul ilheosseoyo',sub:'Emergency'}
];

const subCategories = {
  daily: ['Greeting', 'Cafe', 'Restaurant', 'Shopping', 'Health', 'Social'],
  travel: ['Airport', 'Hotel', 'Transport', 'Emergency']
};

const subIcons = {
  'Greeting': '👋', 'Cafe': '☕', 'Restaurant': '🍽️', 'Shopping': '🛍️', 
  'Health': '💊', 'Social': '👥', 'Airport': '✈️', 'Hotel': '🏨', 
  'Transport': '🚇', 'Emergency': '🆘'
};

let st = { cat:'daily', sub:null, i:0, spd:0.75, lines:daily, filteredLines:daily, repCount:0 };

function getLines() {
  let base = st.cat === 'drama' ? drama : st.cat === 'daily' ? daily : travel;
  if (st.sub) {
    return base.filter(item => item.sub === st.sub);
  }
  return base;
}

function updateSubFilters() {
  const container = document.getElementById('subFilters');
  
  if (st.cat === 'drama') {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  const cats = subCategories[st.cat] || [];
  
  container.innerHTML = '<div class="sub-filters">' +
    '<div class="filter-chip ' + (!st.sub ? 'active' : '') + '" onclick="filterSub(null)">All</div>' +
    cats.map(cat => 
      '<div class="filter-chip ' + (st.sub === cat ? 'active' : '') + '" onclick="filterSub(\'' + cat + '\')">' +
      subIcons[cat] + ' ' + cat +
      '</div>'
    ).join('') +
    '</div>';
}

function filterSub(sub) {
  st.sub = sub;
  st.i = 0;
  st.repCount = 0;
  st.filteredLines = getLines();
  updateSubFilters();
  show();
}

function updateRepetitionDisplay() {
  document.getElementById('repCount').textContent = st.repCount;
  
  for (let i = 1; i <= 5; i++) {
    const dot = document.getElementById('dot' + i);
    if (i <= st.repCount) {
      dot.classList.add('completed');
      dot.textContent = '✓';
    } else {
      dot.classList.remove('completed');
      dot.textContent = '';
    }
  }
  
  const congrats = document.getElementById('congrats');
  if (st.repCount >= 5) {
    congrats.classList.add('show');
  } else {
    congrats.classList.remove('show');
  }
}

function show() {
  st.filteredLines = getLines();
  
  if (st.filteredLines.length === 0) {
    st.filteredLines = st.cat === 'drama' ? drama : st.cat === 'daily' ? daily : travel;
    st.i = 0;
  }
  
  if (st.i >= st.filteredLines.length) st.i = 0;
  if (st.i < 0) st.i = 0;
  
  st.repCount = 0;
  
  const d = st.filteredLines[st.i];
  document.getElementById('badge').textContent = d.t;
  document.getElementById('context').textContent = 'Conversation: ' + d.c;
  document.getElementById('korean').textContent = d.k;
  document.getElementById('pronunciation').textContent = d.p;
  document.getElementById('english').textContent = '"' + d.e + '"';
  document.getElementById('prog').textContent = (st.i+1) + ' / ' + st.filteredLines.length;
  
  updateRepetitionDisplay();
}

function showError(msg) {
  const err = document.getElementById('errorMsg');
  err.textContent = msg;
  err.style.display = 'block';
  setTimeout(() => { err.style.display = 'none'; }, 5000);
}

function play() {
  const txt = st.filteredLines[st.i].k;
  
  if (!('speechSynthesis' in window)) {
    showError('⚠️ Your browser does not support text-to-speech. Try Chrome, Safari, or Edge.');
    return;
  }
  
  const synth = window.speechSynthesis;
  synth.cancel();
  
  let voices = synth.getVoices();
  if (voices.length === 0) {
    synth.onvoiceschanged = () => {
      voices = synth.getVoices();
      speakText(txt, voices);
    };
  } else {
    speakText(txt, voices);
  }
  
  // Increment repetition count when play is clicked
  if (st.repCount < 5) {
    st.repCount++;
    updateRepetitionDisplay();
    
    // Auto-advance after completing 5 repetitions
    if (st.repCount >= 5) {
      autoNext();
    }
  }
}

function speakText(txt, voices) {
  const synth = window.speechSynthesis;
  
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'ko-KR';
    u.rate = st.spd;
    u.pitch = 1.0;
    u.volume = 1.0;
    
    const koVoice = voices.find(v => 
      v.lang && (
        v.lang === 'ko-KR' || 
        v.lang === 'ko_KR' || 
        v.lang.startsWith('ko-') ||
        v.name.includes('Korean') ||
        v.name.includes('한국')
      )
    );
    
    if (koVoice) {
      u.voice = koVoice;
      console.log('Using Korean voice:', koVoice.name);
    } else {
      console.log('No Korean voice found, using default');
    }
    
    u.onerror = (e) => {
      console.error('Speech error:', e);
      showError('⚠️ Speech failed. Please try again.');
    };
    
    u.onend = () => {
      console.log('Speech completed');
    };
    
    synth.speak(u);
  }, 200);
}

function prev() {
  if (st.i > 0) { 
    st.i--;
    st.repCount = 0;
    show(); 
  }
}

function next() {
  if (st.i < st.filteredLines.length - 1) { 
    st.i++;
    st.repCount = 0;
    show(); 
  }
}

function autoNext() {
  if (st.repCount >= 5) {
    // Award XP for completing the phrase
    if (currentUser && db) {
      updatePracticeStats();
    }
    
    setTimeout(() => {
      if (st.i < st.filteredLines.length - 1) {
        next();
      } else {
        showError('🎉 You completed all phrases! Great work!');
      }
    }, 2000);
  }
}

function switchCategory(cat) {
  st.cat = cat;
  st.sub = null;
  st.i = 0;
  st.repCount = 0;
  
  document.getElementById('dramaBtn').classList.remove('active');
  document.getElementById('dailyBtn').classList.remove('active');
  document.getElementById('travelBtn').classList.remove('active');
  
  if (cat === 'drama') {
    document.getElementById('dramaBtn').classList.add('active');
  } else if (cat === 'daily') {
    document.getElementById('dailyBtn').classList.add('active');
  } else if (cat === 'travel') {
    document.getElementById('travelBtn').classList.add('active');
  }
  
  updateSubFilters();
  show();
}

// Event listeners
document.getElementById('dramaBtn').addEventListener('click', () => switchCategory('drama'));
document.getElementById('dailyBtn').addEventListener('click', () => switchCategory('daily'));
document.getElementById('travelBtn').addEventListener('click', () => switchCategory('travel'));
document.getElementById('playBtn').addEventListener('click', play);
document.getElementById('prevBtn').addEventListener('click', prev);
document.getElementById('nextBtn').addEventListener('click', next);

document.getElementById('speed').addEventListener('input', (e) => {
  st.spd = parseFloat(e.target.value);
  document.getElementById('speedTxt').textContent = st.spd + 'x';
});

// Initialize with daily category
document.getElementById('dailyBtn').classList.add('active');
updateSubFilters();
show();
</script>
</body>
</html>