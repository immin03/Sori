<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sori - Learn Korean by Sound</title>
  <meta name="theme-color" content="#7c3aed"/>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="#7c3aed" stroke="#6d28d9" stroke-width="2"/>
      <text x="16" y="40" font-family="sans-serif" font-size="22" font-weight="bold" fill="white">소</text>
    </svg>'/>

  <!-- GA -->
  <script>window.GA_ID='G-X1Q98DBKR5';</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date());
    gtag('config',window.GA_ID,{send_page_view:false});
  </script>

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      max-width:680px;margin:0 auto;padding:12px;
      background:#faf8ff;min-height:100vh;color:#1f2937;
    }
    h1{font-size:24px;margin:0 0 4px;color:#7c3aed;font-weight:800}
    .intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-btn{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:0;cursor:pointer}
    .top-btn.primary{background:#7c3aed;color:#fff}
    .card{background:#fff;border-radius:16px;padding:16px;margin:8px 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}

    /* Category picker */
    .category-bar{display:flex;align-items:center;gap:12px}
    .picker-wrap{position:relative}
    .picker-trigger{
      padding:12px 18px;border-radius:14px;background:#7c3aed;color:#fff;
      font-weight:800;border:0;cursor:pointer;min-width:200px;text-align:center
    }
    .picker-menu{
      position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .25s ease;z-index:50
    }
    .picker-menu.open{max-height:156px}
    .picker-list{max-height:150px;overflow-y:auto;padding:6px;scrollbar-width:thin}
    .picker-item{height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;
      background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none}
    .picker-item:hover,.picker-item.active{background:#7c3aed;color:#fff}
    .saved-btn{
      height:44px;padding:0 16px;border-radius:12px;background:#fff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap
    }
    .saved-btn:hover{background:#f7f2ff}

    /* Sub chips */
    .sub-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
    .sub-chip.active{background:#7c3aed;border-color:#7c3aed;color:#fff}

    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:10px}
    .icon-btn{border:none;background:transparent;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;color:#9ca3af;cursor:pointer;border-radius:8px}
    .icon-btn.active{color:#e11d48}

    .context{color:#6b7280;font-size:16px;text-align:center;margin:8px 0 0;font-weight:600}
    .kbox{background:#f9fafb;border-radius:14px;padding:16px 12px;margin:12px 0;text-align:center}
    .ko{font-size:28px;font-weight:900;color:#1f2937;margin:0 0 6px}
    .en{color:#6b7280;font-size:16px;margin:0 0 10px;font-weight:600}

    .practice{background:#f9fafb;border-radius:10px;padding:10px}
    .practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
    .dots{display:flex;gap:6px;justify-content:center;margin-bottom:8px}
    .rep-dot{width:32px;height:32px;border-radius:50%;border:2px solid #e5e7eb;background:#fff}
    .rep-dot.completed{background:#7c3aed;border-color:#7c3aed}
    button.big{width:100%;padding:12px 18px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff}
    .row{display:flex;align-items:center;justify-content:center;gap:8px;background:#f9fafb;border-radius:8px;padding:8px;margin-top:8px}

    .tip-card{margin-top:10px;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
    .tip-text{font-size:12px;color:#9f1239;font-weight:600}

    .hidden-tabs{display:none}
    .auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.45);padding:16px}
    .auth.open{display:flex}
    .auth-card{background:#fff;width:100%;max-width:360px;border-radius:18px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
    .auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
      <div class="intro">Learn Korean naturally by repeating real sounds</div>
    </div>
    <button id="loginBtn" class="top-btn primary">Login</button>
  </header>

  <!-- CATEGORY -->
  <section class="card">
    <div class="category-bar">
      <div class="picker-wrap">
        <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox">Daily</button>
        <div id="pickerMenu" class="picker-menu"><div class="picker-list"></div></div>
      </div>
      <button id="savedBtn" class="saved-btn">★ Saved</button>
    </div>

    <div class="hidden-tabs" aria-hidden="true">
      <button id="dailyBtn"  class="tab-button active">Daily</button>
      <button id="travelBtn" class="tab-button">Travel</button>
      <button id="dramaBtn"  class="tab-button">K-Drama</button>
      <button id="savedBtnHidden" class="tab-button">Saved</button>
    </div>

    <div id="subFilters" class="sub-filters"></div>
  </section>

  <!-- LESSON -->
  <section class="card">
    <div class="row-between">
      <div id="badge" class="badge">Greeting</div>
      <button id="scrapBtn" class="icon-btn" title="Save this phrase">☆</button>
    </div>
    <div id="context" class="context">"Hello"</div>

    <div class="kbox">
      <p id="korean" class="ko">안녕하세요.</p>
      <p id="english" class="en">annyeonghaseyo</p>
      <p id="pronunciation" style="display:none">annyeonghaseyo</p>
    </div>

    <div class="practice">
      <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
      <div class="dots"><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div></div>
    </div>

    <button id="playBtn" class="big">Listen & Repeat</button>
    <div class="row"><label>Speed:</label><input id="speed" type="range" min="0.3" max="1.0" step="0.1" value="0.75"/><span id="speedTxt">0.75x</span></div>
    <div class="tip-card"><div id="tipText" class="tip-text"></div></div>
  </section>

  <section class="card">
    <div class="nav"><button id="prevBtn">◀ Previous</button><button id="nextBtn">▶ Next</button></div>
    <div id="prog" class="progress">1 / 30</div>
  </section>

  <div id="authModal" class="auth">
    <div class="auth-card">
      <button id="authClose" class="auth-close">×</button>
      <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
      <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
      <button class="gbtn" onclick="window.handleGoogleLogin&&window.handleGoogleLogin()">Continue with Google</button>
    </div>
  </div>

  <!-- 데이터 연결 -->
  <script defer src="data/daily.js?v=20251017"></script>
  <script defer src="data/travel.js?v=20251017"></script>
  <script defer src="data/drama.js?v=20251017"></script>
  <script defer src="data/dataindex.js?v=20251017"></script>
  <script defer src="js/state.js?v=20251017"></script>
  <script defer src="js/tts.js?v=20251017"></script>
  <script defer src="js/app.js?v=20251017"></script>

  <!-- 하단 보조 스크립트들은 모두 DOMContentLoaded 이후 실행 -->
  <script>
  document.addEventListener('DOMContentLoaded',()=>{
    // Auth wiring
    const modal=authModal, login=loginBtn, close=authClose;
    const open=()=>modal.classList.add('open'), hide=()=>modal.classList.remove('open');
    function wireLogin(){login.textContent='Login';login.onclick=open;}
    function wireLogout(){login.textContent='Logout';login.onclick=async()=>{try{await window.SoriUser?.logout?.();}catch(e){}};}
    close.onclick=hide;modal.onclick=e=>{if(e.target===modal)hide();}
    try{firebase.auth().onAuthStateChanged(u=>{u?(hide(),wireLogout()):wireLogin();});}
    catch(e){wireLogin();}

    // Picker
    const cats=["Daily","Travel","K-Drama"], menu=pickerMenu.querySelector('.picker-list');
    menu.innerHTML=''; cats.forEach((c,i)=>{const el=document.createElement('div');el.className='picker-item'+(i==0?' active':'');el.textContent=c;
      el.onclick=()=>{menu.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active'));el.classList.add('active');pickerTrigger.textContent=c;pickerMenu.classList.remove('open');changeTip();const key=c.toLowerCase();if(key==='daily')dailyBtn.click();if(key==='travel')travelBtn.click();if(key.includes('drama'))dramaBtn.click();};
      menu.appendChild(el);
    });
    pickerTrigger.onclick=e=>{e.stopPropagation();pickerMenu.classList.toggle('open');};
    document.body.onclick=()=>pickerMenu.classList.remove('open');
    savedBtn.onclick=()=>savedBtnHidden.click();

    // Tip rotate
    const tips=[
      "Tip: Small daily reps beat big, rare sessions.",
      "Tip: Shadow the sound, not the spelling.",
      "Tip: Say it out loud — your mouth must learn too.",
      "Tip: Five clean repeats > twenty sloppy ones.",
      "Tip: Record yourself and match the rhythm.",
      "Tip: First mimic, then understand.",
      "Tip: Keep the same speed; build consistency.",
      "Tip: Close your eyes and copy the melody.",
      "Tip: Bite-sized goals. One phrase at a time.",
      "Tip: Revisit yesterday — retention makes speed."
    ];
    const tipText=document.getElementById('tipText');
    const changeTip=()=>tipText.textContent=tips[Math.floor(Math.random()*tips.length)];
    changeTip();

    // Layout fix swap
    const quote=s=>`"${String(s||'').replace(/^"+|"+$/g,'').trim()}"`;let last='';
    function swap(){
      const ko=(korean.textContent||'').trim();if(!ko||ko===last)return;last=ko;
      const en=english,pr=pronunciation,ctx=context;
      if(en&&pr&&ctx){ctx.textContent=quote(en.textContent.trim());en.textContent=pr.textContent.trim();pr.style.display='none';}
    }
    swap();
    const mo=new MutationObserver(()=>requestAnimationFrame(swap));
    mo.observe(korean,{childList:true,subtree:true});
    [nextBtn,prevBtn,dailyBtn,travelBtn,dramaBtn,savedBtnHidden].forEach(el=>el.addEventListener('click',()=>setTimeout(swap,0),true));
  });
  </script>

  <!-- 안전한 TTS patch -->
  <script>
  window.addEventListener('load',()=>{
    const ENDPOINT="https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
    const original=speechSynthesis.speak.bind(speechSynthesis);
    const shared=new Audio();let last=null;
    async function viaApi(u){try{shared.pause();}catch{}if(last){URL.revokeObjectURL(last);last=null;}
      const t=(u.text||'').trim();if(!t)throw 0;
      const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})});
      const b=await r.blob();const url=URL.createObjectURL(b);last=url;shared.src=url;await shared.play();
    }
    speechSynthesis.speak=function(u){if(/[가-힣]/.test(u.text||''))viaApi(u).catch(()=>original(u));else original(u);}
  });
  </script>
</body>
</html>
