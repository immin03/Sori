<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sori - Learn Korean by Sound</title>

  <meta name="theme-color" content="#7c3aed"/>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#7c3aed"/>
          <stop offset="1" stop-color="#6d28d9"/>
        </linearGradient>
      </defs>
      <circle cx="32" cy="32" r="30" fill="url(%23g)" stroke="%236d28d9" stroke-width="2"/>
      <path d="M42 22c0-4-4-7-10-7s-10 3-10 7c0 7 20 4 20 12 0 4-4 7-10 7s-10-3-10-7"
            fill="none" stroke="white" stroke-width="5" stroke-linecap="round"/>
    </svg>'/>

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 180">
      <defs>
        <linearGradient id="ga" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#7c3aed"/>
          <stop offset="1" stop-color="#6d28d9"/>
        </linearGradient>
      </defs>
      <rect width="180" height="180" rx="36" fill="url(%23ga)"/>
      <path d="M126 62c0-12-12-21-30-21s-30 9-30 21c0 21 60 12 60 36 0 12-12 21-30 21s-30-9-30-21"
            fill="none" stroke="white" stroke-width="14" stroke-linecap="round"/>
    </svg>'/>

  <script>
    window.GA_ID = 'G-X1Q98DBKR5';
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', window.GA_ID, { send_page_view: false });
  </script>

  <!-- Firebase compat -->
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    *{ box-sizing:border-box }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      max-width:680px;margin:0 auto;padding:12px;background:#faf8ff;min-height:100vh
    }
    h1{font-size:24px;margin:0 0 4px;color:#7c3aed;font-weight:800}
    .intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-btn{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:0;cursor:pointer}
    .top-btn.primary{background:#7c3aed;color:#fff}

    .card{background:#fff;border-radius:16px;padding:16px;margin:8px 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}

    /* Picker row */
    .row-flex{display:flex;align-items:center;gap:12px}

    /* Wheel picker */
    .picker-wrap{position:relative;width:220px;height:180px}
    .picker{position:absolute;inset:0;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;outline:none;scroll-snap-type:y mandatory}
    .picker::-webkit-scrollbar{display:none}
    .picker-item{height:44px;line-height:44px;text-align:center;border-radius:12px;margin:6px 8px;background:#f6f6ff;color:#5b5b72;font-weight:700;scroll-snap-align:center;user-select:none}
    .picker-item.active{background:#7c3aed;color:#fff;transform:scale(1.03)}
    .picker-item.spacer{background:transparent;pointer-events:none}
    .picker-focus{position:absolute;top:50%;left:6px;right:6px;height:44px;margin-top:-22px;border-radius:12px;border:2px solid rgba(124,58,237,.35);pointer-events:none}

    /* Saved fixed */
    .saved-btn{height:44px;padding:0 16px;border-radius:12px;background:#ffffff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap}
    .saved-btn:hover{background:#f7f2ff}

    /* 숨김 탭: 기존 app.js 호환용 */
    .hidden-tabs{display:none}

    /* Sub filters (chips) */
    .sub-filters{display:none;margin-top:8px;padding:8px;background:#f9fafb;border-radius:10px;gap:8px;flex-wrap:wrap}
    .sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none;line-height:1;transition:background .15s,border-color .15s,color .15s}
    .sub-chip:hover{background:#f3f4f6}
    .sub-chip.active{background:#7c3aed;border-color:#7c3aed;color:#fff}
    .sub-chip .sub-icon{font-size:14px;line-height:1;transform:translateY(.5px)}
    .sub-chip .sub-label{line-height:1}

    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:10px}

    /* Star color: red-pink */
    .icon-btn{border:none;background:transparent;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;line-height:1;color:#9ca3af;cursor:pointer;border-radius:8px}
    .icon-btn:hover{background:#f3f4f6}
    .icon-btn.active{color:#e11d48} /* was #d97706 */

    /* Context: will be re-used to show English meaning with big style */
    .context{
      background:#f9fafb;border-radius:8px;padding:6px 10px;margin-top:8px;
      color:#6b7280;font-size:12px;font-weight:600
    }
    /* When we turn it into English meaning, match .en style and remove background look */
    .context.en-mode{
      background:transparent;border-radius:0;padding:0;margin-top:8px;
      color:#6b7280;font-size:16px;font-weight:600;text-align:center
    }

    .kbox{background:#f9fafb;border-radius:14px;padding:16px 12px;margin:12px 0}
    .ko{font-size:28px;font-weight:900;color:#1f2937;text-align:center;margin:0 0 6px}
    .en{color:#6b7280;font-size:16px;text-align:center;margin:0 0 10px;font-weight:600}
    .pr{color:#9ca3af;font-size:13px;font-style:italic;text-align:center;margin:0}

    .practice{background:#f9fafb;border-radius:10px;padding:10px}
    .practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
    .dots{display:flex;gap:6px;justify-content:center;margin-bottom:8px}
    .rep-dot{width:32px;height:32px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center}
    .rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

    button.big{width:100%;padding:12px 18px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff;box-shadow:0 2px 8px rgba(124,58,237,.2)}
    button.big:hover{background:#6d28d9}
    .error{display:none;background:#fee2e2;color:#991b1b;font-size:11px;font-weight:600;padding:8px 12px;border-radius:8px;margin-top:8px}

    .row{display:flex;align-items:center;justify-content:center;gap:8px;background:#f9fafb;border-radius:8px;padding:8px;margin-top:8px}
    .row label{color:#7c3aed;font-size:12px;font-weight:600}
    .row span{color:#7c3aed;font-size:12px;font-weight:700;min-width:42px;text-align:right}

    .nav{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .secondary{background:#f9fafb;color:#6b7280;border:0;padding:12px 18px;border-radius:14px;font-weight:800}
    .secondary:hover{background:#f3f4f6}
    .progress{text-align:center;color:#7c3aed;font-size:13px;font-weight:700;margin-top:8px}

    .cong{display:none;margin:8px 0;text-align:center;background:linear-gradient(135deg,#ffe4e6 0%,#fecdd3 100%);border-radius:10px;padding:12px}
    .cong.show{display:block}

    /* Tip box: pink theme */
    .tip-card{margin-top:10px;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
    .tip-text{font-size:12px;color:#9f1239;font-weight:600}

    .auth{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:9999;padding:16px}
    .auth:not(.hidden){display:flex}
    .auth-card{background:#fff;width:100%;max-width:360px;border-radius:18px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
    .auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}

    @media (max-width:640px){
      .picker-wrap{width:100%}
      .kbox{padding:14px 10px}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
      <div class="intro">Learn Korean naturally by repeating real sounds</div>
    </div>
    <div>
      <button id="loginBtn" class="top-btn primary">Login</button>
    </div>
  </header>

  <!-- CATEGORY -->
  <section class="card">
    <div class="row-flex">
      <div class="picker-wrap">
        <div id="categoryPicker" class="picker"></div>
        <div class="picker-focus"></div>
      </div>
      <button id="savedBtn" class="saved-btn">★ Saved</button>
    </div>

    <!-- 호환용 숨김 탭 -->
    <div class="hidden-tabs" aria-hidden="true">
      <button id="dailyBtn"  class="tab-button active">Daily</button>
      <button id="travelBtn" class="tab-button">Travel</button>
      <button id="dramaBtn"  class="tab-button">K-Drama</button>
      <button id="savedBtnHidden" class="tab-button">Saved</button>
    </div>

    <div id="subFilters" class="sub-filters"></div>
  </section>

  <!-- LESSON -->
  <section class="card">
    <div class="row-between">
      <div id="badge" class="badge">Greeting</div>
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save">☆</button>
    </div>

    <!-- 여기엔 영어 뜻을 크게 넣기 위해 JS가 en-mode를 추가 -->
    <div id="context" class="context">Conversation: First meeting</div>

    <div class="kbox">
      <p id="korean" class="ko">안녕하세요.</p>
      <p id="english" class="en">"Hello"</p>
      <p id="pronunciation" class="pr">annyeonghaseyo</p>
    </div>

    <div class="practice">
      <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
      <div class="dots">
        <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
      </div>
    </div>

    <div id="congrats" class="cong">Great job!</div>

    <button id="playBtn" class="big">Listen & Repeat</button>
    <div id="errorMsg" class="error"></div>

    <div class="row">
      <label for="speed">Speed:</label>
      <input id="speed" type="range" min="0.3" max="1.0" step="0.1" value="0.75" />
      <span id="speedTxt">0.75x</span>
    </div>

    <!-- Tip: 랜덤 문구 -->
    <div id="tipBox" class="tip-card">
      <div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div>
    </div>
  </section>

  <!-- NAV -->
  <section class="card">
    <div class="nav">
      <button id="prevBtn" class="secondary">◀ Previous</button>
      <button id="nextBtn" class="secondary">▶ Next</button>
    </div>
    <div id="prog" class="progress">1 / 30</div>
  </section>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth hidden">
    <div class="auth-card">
      <button id="authClose" class="auth-close" aria-label="Close">×</button>
      <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
      <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
      <button class="gbtn" onclick="window.handleGoogleLogin && window.handleGoogleLogin()">Continue with Google</button>
    </div>
  </div>

  <!-- DATA -->
  <script defer src="data/daily.js?v=20251017"></script>
  <script defer src="data/travel.js?v=20251017"></script>
  <script defer src="data/drama.js?v=20251017"></script>
  <script defer src="data/dataindex.js?v=20251017"></script>

  <!-- APP SCRIPTS -->
  <script defer src="js/state.js?v=20251017"></script>
  <script defer src="js/tts.js?v=20251017"></script>
  <script defer src="js/app.js?v=20251017"></script>

  <!-- Header auth wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('authModal');
      const loginBtn = document.getElementById('loginBtn');

      loginBtn?.addEventListener('click', async () => {
        try {
          const u = (window.firebase?.auth && firebase.auth().currentUser) || null;
          if (u && window.SoriUser?.logout) {
            await window.SoriUser.logout();
          } else {
            modal?.classList.remove('hidden');
          }
        } catch (e) { console.warn(e); }
      });

      document.getElementById('authClose')?.addEventListener('click', () => {
        modal?.classList.add('hidden');
      });
    });
  </script>

  <!-- Wheel Picker logic + legacy compatibility -->
  <script>
    (function(){
      const CATEGORIES = ["Daily","Travel","K-Drama","Food","Shopping","Cafe","Numbers","Phrases"];

      const legacy = {
        daily:  document.getElementById('dailyBtn'),
        travel: document.getElementById('travelBtn'),
        drama:  document.getElementById('dramaBtn')
      };

      document.getElementById('savedBtn')?.addEventListener('click', () => {
        const savedHidden = document.getElementById('savedBtnHidden');
        savedHidden && savedHidden.click();
      });

      const picker = document.getElementById('categoryPicker');
      const itemHeight = 44, padItems = 3;

      function addItem(text, spacer=false){
        const el = document.createElement('div');
        el.className = 'picker-item' + (spacer ? ' spacer' : '');
        el.textContent = text;
        if(!spacer){
          el.addEventListener('click', () => {
            const idx = [...picker.children].indexOf(el);
            snapToIndex(idx);
          });
        }
        picker.appendChild(el);
      }

      function renderPicker(){
        for(let i=0;i<padItems;i++) addItem('', true);
        CATEGORIES.forEach(c => addItem(c));
        for(let i=0;i<padItems;i++) addItem('', true);

        picker.tabIndex = 0;
        snapToIndex(padItems);
        fireLegacyClick("Daily");
      }

      let scrollTimer;
      picker.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
          const index = Math.round(picker.scrollTop / itemHeight);
          snapToIndex(index);
        }, 80);
      });

      picker.addEventListener('keydown', e => {
        const cur = Math.round(picker.scrollTop / itemHeight);
        if(e.key === 'ArrowUp') snapToIndex(cur - 1);
        if(e.key === 'ArrowDown') snapToIndex(cur + 1);
      });

      function snapToIndex(i){
        const max = picker.children.length - 1;
        const clamped = Math.max(0, Math.min(max, i));
        picker.scrollTo({ top: clamped * itemHeight, behavior: 'smooth' });

        [...picker.querySelectorAll('.picker-item')].forEach(el => el.classList.remove('active'));
        const el = picker.children[clamped];
        if(el && !el.classList.contains('spacer')){
          el.classList.add('active');
          const logicalIndex = clamped - padItems;
          const selected = CATEGORIES[logicalIndex];
          if(selected) fireLegacyClick(selected);
        }
      }

      function fireLegacyClick(name){
        const key = name.toLowerCase();
        if(key === 'daily')  legacy.daily?.click();
        if(key === 'travel') legacy.travel?.click();
        if(key === 'k-drama' || key === 'kdrama' || key === 'drama') legacy.drama?.click();
        if(window.SORI && typeof window.SORI.loadCategory === 'function'){
          window.SORI.loadCategory(name);
        }
      }

      window.SORI = window.SORI || {};
      window.SORI.loadCategory = window.SORI.loadCategory || function(cat){ console.log('Selected category:', cat); };

      renderPicker();
    })();
  </script>

  <!-- Navigation rewrite (기존 코드) -->
  <script>
  (function(){
    const btn = {
      next: document.getElementById('nextBtn'),
      prev: document.getElementById('prevBtn'),
      daily: document.getElementById('dailyBtn'),
      travel: document.getElementById('travelBtn'),
      drama: document.getElementById('dramaBtn'),
    };
    const progEl  = document.getElementById('prog');
    const badgeEl = document.getElementById('badge');
    const tabs = [btn.daily, btn.travel, btn.drama].filter(Boolean);

    const CAT_KEY = { dailyBtn:'daily', travelBtn:'travel', dramaBtn:'drama' };

    function getActiveTab(){ return tabs.find(t => t.classList.contains('active')) || btn.daily; }
    function getActiveCatKey(){ return CAT_KEY[getActiveTab().id]; }

    function getProgress(){
      const m = (progEl?.textContent || '').match(/(\d+)\s*\/\s*(\d+)/);
      if(!m) return {i:1,total:1};
      return { i: parseInt(m[1],10), total: parseInt(m[2],10) };
    }

    function subOrderOf(catKey){
      const arr = (window.SORI_DATA && window.SORI_DATA[catKey]) || [];
      const order = [];
      for(const x of arr){
        const s = x?.sub || 'Default';
        if(!order.includes(s)) order.push(s);
      }
      return order;
    }

    function currentSubName(){ return (badgeEl?.textContent || '').trim(); }

    function goFirstItem(){
      const {i} = getProgress();
      for(let k=1; k<i; k++) btn.prev?.click();
      setTimeout(()=>{
        const again = getProgress().i;
        for(let k=1; k<again; k++) btn.prev?.click();
      }, 0);
    }

    function clickSubChipByName(name){
      const chips = Array.from(document.querySelectorAll('#subFilters .sub-chip'));
      const target = chips.find(c => (c.textContent || '').trim() === name)
               || chips.find(c => (c.textContent || '').includes(name));
      if(target) target.click();
    }

    function goFirstSubAndItem(){
      setTimeout(()=>{
        const firstChip = document.querySelector('#subFilters .sub-chip');
        if(firstChip) firstChip.click();
        setTimeout(goFirstItem, 0);
      }, 0);
    }

    btn.next?.addEventListener('click', function onNext(e){
      const {i, total} = getProgress();
      if(i < total) return;

      e.preventDefault();
      e.stopImmediatePropagation();

      const catKey = getActiveCatKey();
      const subs = subOrderOf(catKey);
      const curSub = currentSubName();
      const curSubIdx = Math.max(0, subs.indexOf(curSub));

      if(curSubIdx > -1 && curSubIdx < subs.length - 1){
        const nextSubName = subs[curSubIdx + 1];
        clickSubChipByName(nextSubName);
        setTimeout(goFirstItem, 0);
        return;
      }

      const curTab = getActiveTab();
      const idx = tabs.indexOf(curTab);
      const nextIdx = (idx + 1) % tabs.length;
      tabs[nextIdx].click();
      goFirstSubAndItem();
    }, true);

    tabs.forEach(t=>{
      t?.addEventListener('click', ()=>{ goFirstSubAndItem(); });
    });
  })();
  </script>

  <!-- Analytics wiring -->
  <script>
  (function(){
    function buildPath(){
      const activeTab = document.querySelector('.tab-button.active')?.id || 'dailyBtn';
      const catMap = { dailyBtn:'daily', travelBtn:'travel', dramaBtn:'kdrama', savedBtn:'saved' };
      const cat = catMap[activeTab] || 'daily';

      const sub = (document.getElementById('badge')?.textContent || 'default')
        .trim().replace(/\s+/g,'-').toLowerCase();

      const progText = document.getElementById('prog')?.textContent || '1 / 1';
      const m = progText.match(/(\d+)\s*\/\s*(\d+)/);
      const idx = m ? parseInt(m[1],10) : 1;

      return `/${cat}/${sub}/${idx}`;
    }

    function sendPV(title){
      try{
        const path = buildPath();
        gtag('event', 'page_view', {
          page_title: title || document.title,
          page_location: location.href,
          page_path: path,
          send_to: 'G-X1Q98DBKR5'
        });
      }catch(e){}
    }

    function sendSessionStart(){ try{ gtag('event', 'session_start', { send_to: 'G-X1Q98DBKR5' }); }catch(e){} }

    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(()=> { sendSessionStart(); sendPV('Sori'); }, 0);
    });

    ['dailyBtn','travelBtn','dramaBtn','savedBtnHidden'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', ()=> { setTimeout(()=> sendPV(`Sori - ${el.textContent.trim()}`), 0); });
    });

    const subFilters = document.getElementById('subFilters');
    if(subFilters){
      subFilters.addEventListener('click', (e)=>{
        const chip = e.target.closest('.sub-chip');
        if(!chip) return;
        setTimeout(()=> sendPV(`Sori - ${chip.textContent.trim()}`), 0);
      });
    }

    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    nextBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Next'), 0), true);
    prevBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Prev'), 0), true);

    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){
        setTimeout(()=> sendPV('Sori - resume'), 0);
      }
    });

    const speed = document.getElementById('speed');
    speed?.addEventListener('change', ()=>{
      gtag('event', 'change_speed', { value: speed.value, send_to: 'G-X1Q98DBKR5' });
    });
  })();
  </script>

  <!-- TTS patch -->
  <script>
  (function(){
    const ENDPOINT = "https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
    let sharedAudio = new Audio();
    let lastUrl = null;
    const originalSpeak = speechSynthesis.speak.bind(speechSynthesis);
    function isKorean(utter){ const lang=(utter.lang||"").toLowerCase(); const text=(utter.text||"").trim(); return (lang.startsWith("ko")||/[가-힣]/.test(text)); }
    function safeCall(fn,arg){ try{ typeof fn==="function" && fn(arg); }catch(e){ console.warn(e); } }
    async function playViaApi(utter){
      try{ sharedAudio.pause(); }catch(_){}
      if(lastUrl){ try{ URL.revokeObjectURL(lastUrl); }catch(_){} lastUrl=null; }
      const text=(utter.text||"").trim(); if(!text) throw new Error("empty text");
      const res=await fetch(ENDPOINT,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({ text })});
      if(!res.ok) throw new Error("TTS HTTP "+res.status);
      const blob=await res.blob();
      const url=URL.createObjectURL(blob); lastUrl=url; sharedAudio.src=url;
      safeCall(utter.onstart,new Event("start"));
      sharedAudio.onended=()=>{ safeCall(utter.onend,new Event("end")); try{ URL.revokeObjectURL(url); }catch(_){} if(lastUrl===url) lastUrl=null; };
      sharedAudio.onerror=()=>{ safeCall(utter.onerror,new Event("error")); };
      await sharedAudio.play();
    }
    speechSynthesis.speak=function(utter){
      try{
        if(!isKorean(utter)) return originalSpeak(utter);
        playViaApi(utter).catch(err=>{ console.warn("[Sori TTS] API failed, fallback:", err); originalSpeak(utter); });
        return;
      }catch(e){ console.warn("[Sori TTS] patch error, fallback:", e); return originalSpeak(utter); }
    };
    window.SoriTTSApi={ useWebSpeechOnce(utter){ originalSpeak(utter); } };
  })();
  </script>

  <!-- Layout adjustments: replace context with English, move pronunciation up; rotate tips -->
  <script>
    (function(){
      const tips = [
        "Tip: Small daily reps beat big, rare sessions.",
        "Tip: Shadow the sound, not the spelling.",
        "Tip: Say it out loud — your mouth must learn too.",
        "Tip: Five clean repeats > twenty sloppy ones.",
        "Tip: Record yourself and match the rhythm.",
        "Tip: First mimic, then understand.",
        "Tip: Keep the same speed; build consistency.",
        "Tip: Close your eyes and copy the melody.",
        "Tip: Bite-sized goals. One phrase at a time.",
        "Tip: Revisit yesterday — retention makes speed."
      ];

      function randomTip(){
        const el = document.getElementById('tipText');
        if(!el) return;
        const t = tips[Math.floor(Math.random()*tips.length)];
        el.textContent = t;
      }

      function swapLayout(){
        const ctx = document.getElementById('context');
        const en  = document.getElementById('english');
        const pr  = document.getElementById('pronunciation');

        if(!ctx || !en || !pr) return;

        // 1) context에 영어 뜻 넣고 큰 폰트 스타일 적용
        const englishText = (en.textContent || '').replace(/^"+|"+$/g,'').trim();
        if(englishText){
          ctx.textContent = englishText;
          ctx.classList.add('en-mode');
        }

        // 2) 기존 English 자리에는 발음 텍스트를 큰 폰트(en 스타일)로 표시
        const pron = (pr.textContent || '').trim();
        if(pron){
          en.textContent = pron;  // en 위치에 annyeonghaseyo
        }

        // 3) 원래 pr는 숨김
        pr.style.display = 'none';

        // 4) 랜덤 Tip 갱신
        randomTip();
      }

      // 초기 1회
      document.addEventListener('DOMContentLoaded', ()=> {
        swapLayout();
      });

      // 콘텐츠가 바뀔 때마다(Next/Prev/카테고리 전환) 재적용
      const target = document.body;
      const mo = new MutationObserver((ms)=>{
        // korean/en/pr/ctx 텍스트 변경을 감지해 재배치
        for(const m of ms){
          if(m.type === 'childList' || m.type === 'subtree' || m.type === 'characterData'){
            // 과도한 호출 방지 타이머
            clearTimeout(window.__soriSwapTimer);
            window.__soriSwapTimer = setTimeout(swapLayout, 30);
            break;
          }
        }
      });
      mo.observe(target, { childList:true, subtree:true, characterData:true });

      // Next/Prev 클릭 시에도 보장
      ['nextBtn','prevBtn','dailyBtn','travelBtn','dramaBtn','savedBtnHidden'].forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('click', ()=> setTimeout(swapLayout, 0), true);
      });
    })();
  </script>

</body>
</html>
