<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sori - Learn Korean by Sound</title>
<meta name="theme-color" content="#7c3aed"/>
<!-- Webfont for consistent capture rendering -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;800;900&display=swap" rel="stylesheet">

<!-- Favicon / Shortcut icon -->
<link rel="icon" type="image/svg+xml"
  href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="#7c3aed"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>
<link rel="shortcut icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="#7c3aed"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- PNG fallbacks for older browsers -->
<link rel="icon" type="image/png" sizes="32x32" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <circle cx="16" cy="16" r="15" fill="#7c3aed"/>
    <text x="16" y="21" font-family="Arial, Helvetica, sans-serif" font-size="14" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>
<link rel="icon" type="image/png" sizes="16x16" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <circle cx="8" cy="8" r="7" fill="#7c3aed"/>
    <text x="8" y="11" font-family="Arial, Helvetica, sans-serif" font-size="7" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- Safari pinned tab (선택) -->
<link rel="mask-icon" color="#7c3aed" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="black"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- iOS home screen icon -->
<link rel="apple-touch-icon" sizes="180x180" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 180">
    <rect width="180" height="180" rx="36" ry="36" fill="#7c3aed"/>
    <text x="90" y="118" font-family="Arial, Helvetica, sans-serif" font-size="64" font-weight="800" fill="white" text-anchor="middle">Sori</text>
  </svg>'/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Sori">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.webmanifest">

<script>window.GA_ID='G-X1Q98DBKR5';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config',window.GA_ID,{send_page_view:false});
</script>

<!-- Firebase v9 모듈 방식으로 로딩 -->

<!-- html2canvas: 카드 캡처용 -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;max-width:720px;margin:0 auto;padding:16px;background:#faf8ff;min-height:100vh;color:#111827}
h1{font-size:26px;margin:0 0 4px;color:#7c3aed;font-weight:800}
.intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.top-btn{padding:8px 14px;border-radius:12px;font-size:12px;font-weight:700;border:0;cursor:pointer}
.top-btn.primary{background:#7c3aed;color:#fff}

.card{background:#fff;border-radius:18px;padding:18px;margin:10px 0;box-shadow:0 2px 12px rgba(0,0,0,.06)}

.category-bar{display:flex;align-items:center;gap:12px}
.picker-wrap{position:relative}
.picker-trigger{padding:12px 18px;border-radius:14px;background:#7c3aed;color:#fff;font-weight:800;border:0;cursor:pointer;min-width:220px;text-align:center}
.picker-menu{position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .25s ease;z-index:50}
.picker-menu.open{max-height:220px}
.picker-list{max-height:210px;overflow-y:auto;padding:6px;scrollbar-width:thin}
.picker-item{height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none}
.picker-item:hover,.picker-item.active{background:#7c3aed;color:#fff}
.saved-btn{height:44px;padding:0 18px;border-radius:12px;background:#fff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap}
.saved-btn:hover{background:#f7f2ff}
.saved-btn.selected{background:#7c3aed;color:#fff;border-color:#7c3aed}
.picker-trigger.dim{background:#ede9fe;color:#6b21a8}

.sub-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
.sub-chip.active{background:#7c3aed;border-color:#7c3aed;color:#fff}

.row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:12px}
.icon-btn{border:none;background:transparent;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;color:#9ca3af;cursor:pointer;border-radius:8px}
.icon-btn svg{display:block}
.icon-btn.active{color:#e11d48}

#lessonCard .context,
#lessonCard .en{opacity:0; transition:opacity .12s ease;}
#lessonCard.lesson-ready .context,
#lessonCard.lesson-ready .en{opacity:1;}

.context{color:#6b7280;font-size:16px;text-align:center;margin:8px 0 0;font-weight:600}

.kbox{background:#f3f4f6;border-radius:16px;padding:18px 14px;margin:12px 0;text-align:center}
.ko{font-size:30px;font-weight:900;margin:0 0 8px}
.en{color:#6b7280;font-size:16px;margin:0 0 10px;font-weight:600}

.practice{background:#f9fafb;border-radius:12px;padding:12px}
.practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
.dots{display:flex;gap:10px;justify-content:center;margin-bottom:8px}
.rep-dot{width:30px;height:30px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;transition:.15s}
.rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

button.big{width:100%;padding:14px 20px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff}

.row{display:flex;align-items:center;justify-content:center;gap:12px;background:#f9fafb;border-radius:10px;padding:10px;margin-top:8px}
.speed-val{min-width:56px;text-align:left;font-variant-numeric:tabular-nums}
input[type="range"]{accent-color:#7c3aed;outline:0}
input[type="range"]::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-webkit-slider-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9;margin-top:-6px}
input[type="range"]::-moz-range-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9}

.tip-card{margin-top:10px;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
.tip-text{font-size:12px;color:#9f1239;font-weight:600}

/* 명사 뜻 표시 영역 스타일 */
.noun-definitions{background:#f8f9fa;border-radius:12px;padding:12px;margin:8px 0;border:1px solid #e5e7eb}
.noun-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.noun-item{display:flex;align-items:center;gap:6px;background:#fff;border-radius:8px;padding:6px 10px;border:1px solid #e5e7eb;font-size:12px;font-weight:600}
.noun-korean{color:#7c3aed;font-weight:800}
.noun-english{color:#6b7280}
.noun-roman{color:#9ca3af;font-size:11px}

.hidden-tabs{display:none}

.auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.45);padding:16px}
.auth.open{display:flex}
.auth-card{background:#fff;width:100%;max-width:380px;border-radius:20px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
.auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}
.gbtn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:10px 14px;border-radius:12px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;font-weight:700;cursor:pointer}
.gbtn:hover{border-color:#d8dbe2;box-shadow:0 2px 8px rgba(124,58,237,.15)}
.glogo{width:18px;height:18px;display:inline-block}

.navbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:nowrap}
.nav-center{min-width:130px;text-align:center;font-size:13px;color:#6b7280;font-weight:700}
.nav-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 28px;border-radius:14px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;cursor:pointer;font-weight:800;font-size:14px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
.nav-btn:hover{border-color:#d8dbe2}
.nav-btn .caret{font-size:15px;color:#7c3aed}
.nav-btn:disabled{opacity:.5;cursor:not-allowed}

@media (max-width:480px){
  .navbar{flex-wrap:wrap}
  .nav-btn{flex:1 1 calc(50% - 8px);min-width:140px}
  .nav-center{order:3;width:100%;margin-top:8px}
}

/* Congrats toast */
#congrats {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  padding: 10px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,.75);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
  z-index: 9999;
}
#congrats.show { opacity: 1; }

/* brand badge (included in capture) */
.brand-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:6px}
.brand{display:inline-flex;align-items:center;gap:8px;background:#f5f3ff;border:1.5px solid #e9defd;padding:6px 10px;border-radius:999px;color:#7c3aed;font-weight:800;font-size:12px}
.brand svg{display:block}
</style>
</head>
<body>
<header class="header">
  <div>
    <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
    <div class="intro">Learn Korean naturally by repeating real sounds</div>
  </div>
  <button id="openLogin" class="top-btn primary">Login</button>
</header>

<section class="card">
  <div class="category-bar">
    <div class="picker-wrap">
      <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox" aria-expanded="false">Daily</button>
      <div id="pickerMenu" class="picker-menu"><div class="picker-list" role="listbox"></div></div>
    </div>
    <button id="savedBtn" class="saved-btn">★ Saved</button>
  </div>

  <div class="hidden-tabs" aria-hidden="true">
    <button id="dailyBtn"    class="tab-button active">Daily</button>
    <button id="travelBtn"   class="tab-button">Travel</button>
    <button id="trendyBtn"   class="tab-button">Trendy Talk</button>
    <button id="dramaBtn"    class="tab-button">K-Drama</button>
    <button id="numbersBtn"  class="tab-button">Numbers</button>
    <button id="savedBtnHidden" class="tab-button">Saved</button>
  </div>

  <div id="subFilters" class="sub-filters"></div>
</section>

<section class="card" id="lessonCard">
  <div class="row-between">
    <div id="badge" class="badge">Love</div>

    <div style="display:flex;gap:6px;align-items:center;">
      <!-- 공유 버튼 (별표와 동일한 디자인) -->
      <button id="threadShareBtn" class="icon-btn" title="Share" aria-label="Share" type="button">
        <svg aria-hidden="true" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <!-- 바깥 네모 (좌하단 열린 박스) -->
          <path d="M4 9a3 3 0 0 1 3-3h5v2H7a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-5h2v5a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V9z"/>
          <!-- 바깥으로 나가는 화살표 (우상향) -->
          <path d="M14 3h7v7h-2V6.414l-8.293 8.293-1.414-1.414L17.586 5H14V3z"/>
        </svg>
      </button>

      <!-- 기존 별표 저장 버튼 -->
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save" style="font-size:18px;">☆</button>
    </div>
  </div>

  <div id="context" class="context">"I like you."</div>

  <div class="kbox">
    <p id="korean" class="ko">당신이 좋아요.</p>
    <p id="english" class="en">dangshini joayo</p>
    <p id="pronunciation" style="display:none">dangshini joayo</p>
  </div>

  <!-- 명사 뜻 표시 영역 -->
  <div id="nounDefinitions" class="noun-definitions" style="display:none;">
    <div class="noun-list"></div>
  </div>

  <div class="practice">
    <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
    <div class="dots">
      <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
    </div>
  </div>

  <button id="playBtn" class="big">Listen & Repeat</button>
  <div class="row">
    <label>Speed:</label>
    <input id="speed" type="range" min="0.6" max="1.0" step="0.05" value="0.80"/>
    <span id="speedTxt" class="speed-val">0.80x</span>
  </div>

  <div class="tip-card"><div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div></div>
</section>

<section class="card">
  <div class="navbar">
    <button id="prevBtn" class="nav-btn"><span class="caret">◀</span> Previous</button>
    <div id="prog" class="nav-center">1 / 45</div>
    <button id="nextBtn" class="nav-btn">Next <span class="caret">▶</span></button>
  </div>
</section>

<div id="authModal" class="auth">
  <div class="auth-card">
    <button id="authClose" class="auth-close" aria-label="Close">×</button>
    <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
    <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
    <button class="gbtn" id="googleLogin">
      <span class="glogo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><path fill="#EA4335" d="M9 7.3h8.5v3.4H9z"/><path fill="#4285F4" d="M17.6 9.2c0-.6-.1-1.2-.2-1.8H9v3.4h4.8c-.2 1-.8 1.8-1.7 2.3v1.9h2.8c1.6-1.5 2.7-3.7 2.7-5.8z"/><path fill="#FBBC05" d="M9 18c2.4 0 4.4-.8 5.9-2.2l-2.8-1.9c-.8.5-1.8.8-3.1.8-2.4 0-4.5-1.6-5.2-3.7H.9v2.3C2.4 15.9 5.4 18 9 18z"/><path fill="#34A853" d="M3.8 11c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V4.7H.9C.3 6 0 7.5 0 9s.3 3 .9 4.3L3.8 11z"/><path fill="#EB4335" d="M9 3.5c1.3 0 2.5.5 3.4 1.4l2.3-2.3C13.4.9 11.4 0 9 0 5.4 0 2.4 2.1.9 4.7L3.8 7c.7-2.1 2.8-3.5 5.2-3.5z"/></svg>
      </span>
      Continue with Google
    </button>
  </div>
</div>

<!-- data sources -->
<script defer src="data/daily.js?v=20251017"></script>
<script defer src="data/travel.js?v=20251017"></script>
<script defer src="data/drama.js?v=20251017"></script>
<script defer src="data/trendy.js?v=20251019"></script>
<script defer src="data/numbers.js?v=20251019"></script>
<script defer src="data/dataindex.js?v=20251019"></script>

<!-- app scripts -->
<script type="module" src="/js/firebase-init.js" defer></script>
<script type="module" src="/js/auth.js" defer></script>
<script defer src="js/state.js?v=20251017"></script>
<script defer src="js/tts.js?v=20251017"></script>
<script defer src="js/app.js?v=20251017"></script>

<script>
/* Sori Auth — final stable gate (popup→redirect, no alerts) */
(function () {
  const $ = (id) => document.getElementById(id);

  // DOM
  const modal = $("authModal");
  const btnOpen = $("openLogin");
  const btnClose = $("authClose");
  const btnGoogle = $("googleLogin");
  const btnScrap = $("scrapBtn");
  const btnSaved = $("savedBtn");
  const btnSavedHidden = $("savedBtnHidden");

  // modal
  const openModal  = () => modal?.classList.add("open");
  const closeModal = () => modal?.classList.remove("open");
  btnClose?.addEventListener("click", closeModal);
  modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  // state / utils
  const now = () => Date.now();
  let wired = false;
  let isLoggingOut = false;
  let suppressAutoModalUntil = 0; // 로그아웃 직후 자동 모달 방지
  let pendingAction = null;       // 로그인 성공 후 1회 재시도
  let bypassGate = false;         // 재시도 클릭이 게이트에 다시 걸리지 않게

  const hasAuth   = () => !!window.firebaseAuth;
  const user      = () => (window.firebaseAuth ? window.firebaseAuth.currentUser : null);
  const loggedIn  = () => !!user();
  const hasLoginAPI = () => !!(window.SoriUser &&
                              (window.SoriUser.loginWithPopup ||
                               window.SoriUser.loginRedirect ||
                               window.SoriUser.login));

  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitUntil(cond, {timeout=12000, step=60}={}) {
    const t0 = now();
    while (!cond()) {
      if (now()-t0 > timeout) return false;
      await wait(step);
    }
    return true;
  }

  // header button
  function paintHeaderBtn() {
    if (!btnOpen) return;
    if (loggedIn()) {
      btnOpen.textContent = "Logout";
      btnOpen.onclick = async (ev) => {
        ev?.preventDefault?.();
        ev?.stopPropagation?.();
        try {
          isLoggingOut = true;
          pendingAction = null;        // 로그아웃 시작 시 즉시 취소
          suppressAutoModalUntil = now() + 2500;
          await window.SoriUser?.logout?.();
        } finally {
          // 약간의 여유를 두고 플래그 해제
          setTimeout(()=>{ isLoggingOut = false; }, 600);
        }
      };
    } else {
      btnOpen.textContent = "Login";
      btnOpen.onclick = (ev) => {
        ev?.preventDefault?.();
        // 로그아웃 직후 같은 클릭이 여기로 들어와도 무시
        if (now() < suppressAutoModalUntil || isLoggingOut) return;
        openModal();
      };
    }
  }

  // 게이트: 로그인 안돼 있으면 모달만 띄우고 원 클릭은 차단
  function guard(el, action) {
    if (!el) return;
    el.addEventListener("click", (e) => {
      if (bypassGate || loggedIn()) return; // 재시도 or 로그인 상태면 통과
      e.stopImmediatePropagation();
      e.preventDefault();
      pendingAction = action;
      // 로그아웃 직후 자동 모달 금지
      if (now() >= suppressAutoModalUntil) openModal();
    }, true); // capture에서 먼저 막기
  }

  // 실제 리스너만 태우는 synthetic click (게이트는 건너뛰기)
  function fireClick(el) {
    if (!el) return;
    bypassGate = true;
    try {
      const evt = new MouseEvent("click", {bubbles:true, cancelable:true});
      el.dispatchEvent(evt);
    } finally {
      // 다음 틱에 해제(혹시 다른 핸들러에서 또 클릭을 만드는 경우 방지)
      setTimeout(()=>{ bypassGate = false; }, 0);
    }
  }

  guard(btnScrap, () => fireClick(btnScrap));
  guard(btnSaved, () => fireClick(btnSavedHidden));

  // Google sign-in: redirect만 사용 (COOP 경고 제거)
  async function doSignIn() {
    const ready = await waitUntil(()=> hasAuth() && hasLoginAPI());
    if (!ready) return; // 조용히 포기(다음 클릭에서 다시 시도)

    const S = window.SoriUser;
    if (S?.loginRedirect) return S.loginRedirect();  // <- 무조건 redirect
    if (S?.login)         return S.login();
  }

  btnGoogle?.addEventListener("click", (e) => {
    e?.preventDefault?.();
    doSignIn();
  });

  // auth wiring
  function onAuthChanged(u) {
    paintHeaderBtn();

    if (u) {
      // 로그인 확정
      closeModal();
      if (pendingAction) {
        const act = pendingAction; pendingAction = null;
        // currentUser 전파가 모두 끝난 뒤 1회만 재시도
        waitUntil(()=>loggedIn(), {timeout:4000, step:80})
          .then(()=> setTimeout(()=>{ try{ act(); }catch(_){ } }, 60));
      }
    } else {
      // 로그아웃 → 즐겨찾기 표시 초기화
      resetScrapUI();
      // 혹시 남아있을 수 있는 후속 동작도 무효화
      pendingAction = null;
    }
  }

  function wire() {
    if (wired || !hasAuth()) return;
    wired = true;
    try {
      window.firebaseAuth.onAuthStateChanged(onAuthChanged);
    } catch (e) { console.error("auth wiring error:", e); }
    paintHeaderBtn();
    onAuthChanged(user());
  }

  window.addEventListener("firebaseReady", wire);
  wire(); // 이미 준비된 경우 대비

  // 별표 UI 초기화
  function resetScrapUI() {
    const star = document.getElementById('scrapBtn');
    if (star) {
      star.classList.remove('active'); // 빨간 별 제거
      star.textContent = '☆';         // 아이콘도 원복(혹시 내부에서 바꿨을 때 대비)
    }
  }

  // 디버깅용(원하면 삭제)
  window.SoriAuth = { loggedIn, fireClick };
})();
</script>

<script>
(function(){
  const CATS=["Daily","Travel","Trendy Talk","K-Drama","Numbers"];
  const trigger=pickerTrigger, menu=pickerMenu, list=menu.querySelector('.picker-list');
  list.innerHTML='';
  CATS.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='picker-item'+(i===0?' active':''); el.textContent=c;
    el.onclick=()=>{ list.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active')); el.classList.add('active');
      trigger.textContent=c; menu.classList.remove('open');
      const key=c.toLowerCase();
      if(key==='daily') dailyBtn.click();
      else if(key==='travel') travelBtn.click();
      else if(key==='k-drama' || key==='kdrama') dramaBtn.click();
      else if(key==='numbers') numbersBtn.click();
      else trendyBtn.click();
      changeTip();
    };
    list.appendChild(el);
  });
  trigger.onclick=(e)=>{ e.stopPropagation(); menu.classList.toggle('open'); };
  document.onclick=()=>menu.classList.remove('open');
  savedBtn?.addEventListener('click',()=> savedBtnHidden?.click());

  // Saved/Daily 탭 색상 반전
  function selectSavedUI(on){
    const saved = document.getElementById('savedBtn');
    const daily = document.getElementById('pickerTrigger');
    saved?.classList.toggle('selected', !!on);
    daily?.classList.toggle('dim', !!on);
  }

  // Saved 버튼 눌렀을 때 선택 표시
  savedBtn?.addEventListener('click', () => selectSavedUI(true));

  // 다른 탭(Daily/Travel/…/Numbers)로 바뀌면 선택 해제
  ['dailyBtn','travelBtn','trendyBtn','dramaBtn','numbersBtn'].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener('click', ()=> selectSavedUI(false));
  });

  const tips=[
    "Tip: Small daily reps beat big, rare sessions.","Tip: Shadow the sound, not the spelling.",
    "Tip: Say it out loud — your mouth must learn too.","Tip: Five clean repeats > twenty sloppy ones.",
    "Tip: Record yourself and match the rhythm.","Tip: First mimic, then understand.",
    "Tip: Keep the same speed; build consistency.","Tip: Close your eyes and copy the melody.",
    "Tip: Bite-sized goals. One phrase at a time.","Tip: Revisit yesterday — retention makes speed."
  ];
  const tipEl=tipText; function changeTip(){ tipEl.textContent=tips[Math.floor(Math.random()*tips.length)]; } changeTip();
})();
</script>

<script>
(function(){
  const btn={next:nextBtn,prev:prevBtn,daily:dailyBtn,travel:travelBtn,drama:dramaBtn,trendy:trendyBtn,numbers:numbersBtn};
  const progEl=prog, badgeEl=badge; const tabs=[btn.daily,btn.travel,btn.trendy,btn.drama,btn.numbers].filter(Boolean);
  const CAT_KEY={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'drama',trendyBtn:'trendy',numbersBtn:'numbers'};
  const getActiveTab=()=> tabs.find(t=>t.classList.contains('active'))||btn.daily;
  const getActiveCatKey=()=> CAT_KEY[getActiveTab().id];
  function getProgress(){ const m=(progEl?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/); if(!m) return {i:1,total:1}; return {i:parseInt(m[1],10),total:parseInt(m[2],10)};}
  function subOrderOf(catKey){ const arr=(window.SORI_DATA&&window.SORI_DATA[catKey])||[]; const order=[]; for(const x of arr){const s=x?.sub||'Default'; if(!order.includes(s)) order.push(s);} return order;}
  const currentSubName=()=> (badgeEl?.textContent||'').trim();
  function goFirstItem(){ const {i}=getProgress(); for(let k=1;k<i;k++) btn.prev?.click(); setTimeout(()=>{ const again=getProgress().i; for(let k=1;k<again;k++) btn.prev?.click();},0); }
  function clickSubChipByName(name){ const chips=[...document.querySelectorAll('#subFilters .sub-chip')]; const t=chips.find(c=>(c.textContent||'').trim()===name)||chips.find(c=>(c.textContent||'').includes(name)); if(t) t.click(); }
  function goFirstSubAndItem(){ setTimeout(()=>{ const first=document.querySelector('#subFilters .sub-chip'); if(first) first.click(); setTimeout(goFirstItem,0); },0); }
  btn.next?.addEventListener('click',function(e){ const {i,total}=getProgress(); if(i<total) return; e.preventDefault(); e.stopImmediatePropagation();
    const subs=subOrderOf(getActiveCatKey()); const cur=currentSubName(); const idx=Math.max(0,subs.indexOf(cur));
    if(idx>-1 && idx<subs.length-1){ clickSubChipByName(subs[idx+1]); setTimeout(goFirstItem,0); return; }
    const curTab=getActiveTab(); const tIdx=tabs.indexOf(curTab); const nextIdx=(tIdx+1)%tabs.length; tabs[nextIdx].click(); goFirstSubAndItem();
  },true);
  tabs.forEach(t=> t?.addEventListener('click',()=>{ goFirstSubAndItem(); }));
})();
</script>

<script>
(function(){
  function buildPath(){
    const active=document.querySelector('.tab-button.active')?.id || 'dailyBtn';
    const catMap={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'kdrama',trendyBtn:'trendy',numbersBtn:'numbers',savedBtn:'saved'};
    const cat=catMap[active]||'daily';
    const sub=(badge?.textContent||'default').trim().replace(/\s+/g,'-').toLowerCase();
    const m=(prog?.textContent||'1 / 1').match(/(\d+)\s*\/\s*(\d+)/); const idx=m?parseInt(m[1],10):1;
    return `/${cat}/${sub}/${idx}`;
  }
  function sendPV(title){ try{ gtag('event','page_view',{page_title:title||document.title,page_location:location.href,page_path:buildPath(),send_to:'G-X1Q98DBKR5'});}catch(e){} }
  function sendSessionStart(){ try{ gtag('event','session_start',{send_to:'G-X1Q98DBKR5'});}catch(e){} }
  document.addEventListener('DOMContentLoaded',()=>{ setTimeout(()=>{ sendSessionStart(); sendPV('Sori'); },0); });
  ['dailyBtn','travelBtn','dramaBtn','trendyBtn','numbersBtn','savedBtnHidden'].forEach(id=>{ const el=document.getElementById(id); el&&el.addEventListener('click',()=> setTimeout(()=>sendPV(`Sori - ${el.textContent.trim()}`),0)); });
  const subFilters=document.getElementById('subFilters');
  subFilters&&subFilters.addEventListener('click',e=>{ const chip=e.target.closest('.sub-chip'); if(!chip) return; setTimeout(()=>sendPV(`Sori - ${chip.textContent.trim()}`),0); });
  nextBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Next'),0),true);
  prevBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Prev'),0),true);
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') setTimeout(()=>sendPV('Sori - resume'),0); });
  speed?.addEventListener('change',()=>{ gtag('event','change_speed',{value:speed.value,send_to:'G-X1Q98DBKR5'}); });
  window.buildPath = buildPath;
})();
</script>

<!-- TTS API 0.6~1.0 with toast -->
<script>
window.addEventListener('load',()=>{
  const ENDPOINT="https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
  const audio=new Audio(); let lastUrl=null;
  const speedEl=document.getElementById('speed');

  function getRate(){ const v=parseFloat(speedEl?.value||'1'); return Math.max(0.6, Math.min(1.0, v)); }
  function setAudioRate(){ audio.playbackRate=getRate(); }
  speedEl?.addEventListener('input', setAudioRate);

  async function playKo(text){
    try{ audio.pause(); }catch(_){}
    if(lastUrl){ try{ URL.revokeObjectURL(lastUrl);}catch(_){ } lastUrl=null; }
    const t=(text||'').trim(); if(!t) return;
    const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})});
    const b=await r.blob(); const url=URL.createObjectURL(b); lastUrl=url; audio.src=url; setAudioRate(); await audio.play();
  }

  document.getElementById('playBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault(); e.stopImmediatePropagation();
    const ko=(document.getElementById('korean')?.textContent||'').trim();
    await playKo(ko);

    const cntEl=document.getElementById('repCount');
    let n=parseInt(cntEl.textContent||'0',10);
    if(n<5){ n++; cntEl.textContent=String(n); }
    document.querySelectorAll('.rep-dot').forEach((d,i)=> d.classList.toggle('completed', i < n));

    if(n===5){
      const toast=document.getElementById('congrats');
      if(toast){
        toast.textContent="Nice work!";
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1800);
      }
    }
  }, true);

  if('speechSynthesis' in window){
    try{ window.speechSynthesis.speak = ()=>{}; window.speechSynthesis.cancel = ()=>{}; }catch(_){}
  }
});
</script>

<script>
(function(){
  // 명사 데이터 매핑
  const nounData = {
    '당신이 좋아요.': [{korean: '당신', english: 'you', roman: 'dangshin'}],
    '사랑해요.': [{korean: '사랑', english: 'love', roman: 'sarang'}],
    '설레어요.': [{korean: '설레', english: 'heart flutter', roman: 'seolle'}],
    '첫눈에 반했어요.': [{korean: '첫눈', english: 'first sight', roman: 'cheotnun'}],
    '보고 싶어요.': [{korean: '보고', english: 'seeing', roman: 'bogo'}],
    '같이 데이트할래요?': [{korean: '데이트', english: 'date', roman: 'deiteu'}],
    '정말 예쁘네요.': [{korean: '정말', english: 'really', roman: 'jeongmal'}],
    '정말 잘생겼어요.': [{korean: '정말', english: 'really', roman: 'jeongmal'}],
    '손 잡아도 될까요?': [{korean: '손', english: 'hand', roman: 'son'}],
    '내 마음이에요.': [{korean: '마음', english: 'heart', roman: 'maeum'}],
    '안녕하세요.': [{korean: '안녕', english: 'hello', roman: 'annyeong'}],
    '안녕!': [{korean: '안녕', english: 'hello', roman: 'annyeong'}],
    '오랜만이에요!': [{korean: '오랜만', english: 'long time', roman: 'oraenman'}],
    '잘 지냈어요?': [{korean: '지내', english: 'doing', roman: 'jinae'}],
    '저는 민우예요.': [{korean: '저', english: 'I', roman: 'jeo'}, {korean: '민우', english: 'Minwoo', roman: 'minu'}],
    '만나서 반가워요.': [{korean: '만나', english: 'meeting', roman: 'manna'}],
    '이름이 뭐예요?': [{korean: '이름', english: 'name', roman: 'ireum'}],
    '어디에서 오셨어요?': [{korean: '어디', english: 'where', roman: 'eodi'}],
    '곧 다시 봬요.': [{korean: '곧', english: 'soon', roman: 'got'}],
    '실례합니다.': [{korean: '실례', english: 'excuse', roman: 'sillye'}],
    '아메리카노 한 잔, 주세요.': [{korean: '아메리카노', english: 'americano', roman: 'amerikano'}, {korean: '잔', english: 'cup', roman: 'jan'}],
    '라지로 부탁드립니다.': [{korean: '라지', english: 'large', roman: 'raji'}],
    '포장할게요.': [{korean: '포장', english: 'packaging', roman: 'pojang'}],
    '얼음은 빼 주세요.': [{korean: '얼음', english: 'ice', roman: 'eoreum'}],
    '커피가 정말 맛있네요!': [{korean: '커피', english: 'coffee', roman: 'keopi'}, {korean: '정말', english: 'really', roman: 'jeongmal'}],
    '매장에서 먹고 갈게요.': [{korean: '매장', english: 'store', roman: 'maejang'}],
    '당도는 낮게 해 주세요.': [{korean: '당도', english: 'sweetness', roman: 'dangdo'}],
    '디카페인으로 주세요.': [{korean: '디카페인', english: 'decaf', roman: 'dikapein'}],
    '오트밀크로 바꿔 주세요.': [{korean: '오트밀크', english: 'oat milk', roman: 'oteu milkeu'}],
    '샷 하나 더 넣어 주세요.': [{korean: '샷', english: 'shot', roman: 'syat'}],
    '두 명이에요.': [{korean: '명', english: 'people', roman: 'myeong'}],
    '추천 메뉴가 있나요?': [{korean: '추천', english: 'recommendation', roman: 'chucheon'}, {korean: '메뉴', english: 'menu', roman: 'menyu'}],
    '안 매운 걸로, 주세요.': [{korean: '매운', english: 'spicy', roman: 'maeun'}],
    '물 좀 더 주시겠어요?': [{korean: '물', english: 'water', roman: 'mul'}],
    '계산서 부탁드려요.': [{korean: '계산서', english: 'check', roman: 'gyesanseo'}],
    '맵기 조절 가능해요?': [{korean: '맵기', english: 'spice level', roman: 'maepgi'}],
    
    // Travel 카테고리
    '관광하러 왔습니다.': [{korean: '관광', english: 'tourism', roman: 'gwangwang'}],
    '일주일 머물 예정입니다.': [{korean: '일주일', english: 'one week', roman: 'iljuil'}],
    '수하물이 안 나왔어요.': [{korean: '수하물', english: 'baggage', roman: 'suhamul'}],
    '공항버스는 어디에서 타요?': [{korean: '공항버스', english: 'airport bus', roman: 'gonghang beoseu'}],
    '환전은 어디서 해요?': [{korean: '환전', english: 'exchange', roman: 'hwanjeon'}],
    '예약했어요. 체크인 하고 싶어요.': [{korean: '예약', english: 'reservation', roman: 'yeyak'}, {korean: '체크인', english: 'check-in', roman: 'chekeuin'}],
    '와이파이 비밀번호가 뭐예요?': [{korean: '와이파이', english: 'WiFi', roman: 'waipai'}, {korean: '비밀번호', english: 'password', roman: 'bimilbeonho'}],
    '수건을 더 가져다 주세요.': [{korean: '수건', english: 'towel', roman: 'sugeon'}],
    '온수가 나오지 않아요.': [{korean: '온수', english: 'hot water', roman: 'onsu'}],
    '체크아웃은 몇 시예요?': [{korean: '체크아웃', english: 'check-out', roman: 'chekeuauseu'}],
    '지하철역이 어디예요?': [{korean: '지하철역', english: 'subway station', roman: 'jihacheol yeok'}],
    '이쪽으로 쭉 가세요.': [{korean: '쪽', english: 'direction', roman: 'jjok'}],
    '여기서 갈아타야 해요.': [{korean: '갈아타', english: 'transfer', roman: 'garata'}],
    '막차가 몇 시예요?': [{korean: '막차', english: 'last train', roman: 'makcha'}],
    '교통카드 충전하고 싶어요.': [{korean: '교통카드', english: 'transit card', roman: 'gyotong kadeu'}, {korean: '충전', english: 'top up', roman: 'chungjeon'}],
    '도와주세요!': [{korean: '도와', english: 'help', roman: 'dowa'}],
    '경찰을 불러 주세요.': [{korean: '경찰', english: 'police', roman: 'gyeongchal'}],
    '병원에 가야 해요.': [{korean: '병원', english: 'hospital', roman: 'byeongwon'}],
    '지갑을 잃어버렸어요.': [{korean: '지갑', english: 'wallet', roman: 'jigap'}],
    '길을 잃었어요.': [{korean: '길', english: 'road', roman: 'gil'}],
    
    // Drama 카테고리
    '너는, 내가 잃은 모든 날들이다.': [{korean: '날', english: 'day', roman: 'nal'}],
    '혼자였던 시간도, 나를 만들었어.': [{korean: '시간', english: 'time', roman: 'sigan'}],
    '널 좋아한 게, 잘못이었을까?': [{korean: '게', english: 'thing', roman: 'ge'}],
    '끝이라고 생각한 순간, 다시 시작됐어.': [{korean: '끝', english: 'end', roman: 'kkeut'}, {korean: '순간', english: 'moment', roman: 'sungan'}],
    '나는, 내 방식대로 간다.': [{korean: '방식', english: 'way', roman: 'bangsik'}],
    '숨 좀 쉬게 해줘.': [{korean: '숨', english: 'breath', roman: 'sum'}],
    '부르면 가고, 안 부르면 안 가.': [{korean: '부르', english: 'call', roman: 'bureu'}],
    '첫눈 오는 날엔, 용기가 필요해.': [{korean: '첫눈', english: 'first snow', roman: 'cheotnun'}, {korean: '용기', english: 'courage', roman: 'yonggi'}],
    '슬픈 날엔, 내 어깨 빌려줄게요.': [{korean: '어깨', english: 'shoulder', roman: 'eokkae'}],
    '오늘도 파이팅!': [{korean: '파이팅', english: 'fighting', roman: 'paiting'}],
    '밥은 꼭 챙겨 먹어.': [{korean: '밥', english: 'meal', roman: 'bap'}],
    '기러기, 토마토, 스위스, 인도인.': [{korean: '기러기', english: 'goose', roman: 'girugi'}, {korean: '토마토', english: 'tomato', roman: 'tomato'}],
    '지금 이 순간이, 전부야.': [{korean: '순간', english: 'moment', roman: 'sungan'}],
    '괜찮아. 버틸 수 있어.': [{korean: '수', english: 'ability', roman: 'su'}],
    '포기하면, 거기서 끝이야.': [{korean: '끝', english: 'end', roman: 'kkeut'}],
    
    // Trendy 카테고리
    '헐!': [{korean: '헐', english: 'OMG', roman: 'heol'}],
    '말도 안 돼!': [{korean: '말', english: 'word', roman: 'mal'}],
    '대박이다!': [{korean: '대박', english: 'awesome', roman: 'daebak'}],
    '쩐다.': [{korean: '쩐', english: 'sick', roman: 'jjeon'}],
    '진짜 웃겨!': [{korean: '진짜', english: 'really', roman: 'jinjja'}],
    '이게 실화야?': [{korean: '실화', english: 'real story', roman: 'silhwa'}],
    '뭐래?': [{korean: '뭐', english: 'what', roman: 'mwo'}],
    '그치 그치.': [{korean: '그치', english: 'right', roman: 'geuchi'}],
    '나도 그래.': [{korean: '나', english: 'I', roman: 'na'}],
    '그게 되네?': [{korean: '게', english: 'thing', roman: 'ge'}],
    '피곤해 죽겠어.': [{korean: '피곤', english: 'tired', roman: 'pigon'}],
    '귀찮아 죽겠어.': [{korean: '귀찮', english: 'bothersome', roman: 'gwichan'}],
    '답답해 미치겠어.': [{korean: '답답', english: 'stuffy', roman: 'dapdap'}],
    '노답이야.': [{korean: '답', english: 'answer', roman: 'dap'}],
    '현타 왔다.': [{korean: '현타', english: 'reality hit', roman: 'hyeonta'}],
    '킹받네.': [{korean: '킹받', english: 'annoying', roman: 'kingbad'}],
    '어쩔 수 없지.': [{korean: '수', english: 'way', roman: 'su'}],
    '완전 좋아!': [{korean: '완전', english: 'completely', roman: 'wanjeon'}],
    '답정너잖아.': [{korean: '답', english: 'answer', roman: 'dap'}],
    '긴장돼.': [{korean: '긴장', english: 'nervous', roman: 'ginjang'}],
    
    // Numbers 카테고리
    '하나, 둘, 셋, 넷, 다섯': [{korean: '하나', english: 'one', roman: 'hana'}, {korean: '둘', english: 'two', roman: 'dul'}, {korean: '셋', english: 'three', roman: 'set'}, {korean: '넷', english: 'four', roman: 'net'}, {korean: '다섯', english: 'five', roman: 'daseot'}],
    '여섯, 일곱, 여덟, 아홉, 열': [{korean: '여섯', english: 'six', roman: 'yeoseot'}, {korean: '일곱', english: 'seven', roman: 'ilgop'}, {korean: '여덟', english: 'eight', roman: 'yeodeol'}, {korean: '아홉', english: 'nine', roman: 'ahop'}, {korean: '열', english: 'ten', roman: 'yeol'}],
    '일, 이, 삼, 사, 오': [{korean: '일', english: 'one', roman: 'il'}, {korean: '이', english: 'two', roman: 'i'}, {korean: '삼', english: 'three', roman: 'sam'}, {korean: '사', english: 'four', roman: 'sa'}, {korean: '오', english: 'five', roman: 'o'}],
    '육, 칠, 팔, 구, 십': [{korean: '육', english: 'six', roman: 'yuk'}, {korean: '칠', english: 'seven', roman: 'chil'}, {korean: '팔', english: 'eight', roman: 'pal'}, {korean: '구', english: 'nine', roman: 'gu'}, {korean: '십', english: 'ten', roman: 'sip'}],
    '사과 한 개': [{korean: '사과', english: 'apple', roman: 'sagwa'}, {korean: '개', english: 'piece', roman: 'gae'}],
    '책 두 권': [{korean: '책', english: 'book', roman: 'chaek'}, {korean: '권', english: 'volume', roman: 'gwon'}],
    '컵 세 개': [{korean: '컵', english: 'cup', roman: 'keop'}, {korean: '개', english: 'piece', roman: 'gae'}],
    '티켓 네 장': [{korean: '티켓', english: 'ticket', roman: 'tiket'}, {korean: '장', english: 'sheet', roman: 'jang'}],
    '아메리카노 한 잔 주세요.': [{korean: '아메리카노', english: 'americano', roman: 'amerikano'}, {korean: '잔', english: 'cup', roman: 'jan'}],
    '라떼 두 잔 주세요.': [{korean: '라떼', english: 'latte', roman: 'latte'}, {korean: '잔', english: 'cup', roman: 'jan'}],
    '손님 한 분 오셨어요.': [{korean: '손님', english: 'guest', roman: 'sonnim'}, {korean: '분', english: 'person', roman: 'bun'}],
    '학생 다섯 명이에요.': [{korean: '학생', english: 'student', roman: 'haksaeng'}, {korean: '명', english: 'people', roman: 'myeong'}],
    '스무 살이에요.': [{korean: '살', english: 'years old', roman: 'sal'}],
    '서른한 살이에요.': [{korean: '살', english: 'years old', roman: 'sal'}],
    '지금 세 시예요.': [{korean: '시', english: 'o\'clock', roman: 'si'}],
    '네 시 반이에요.': [{korean: '시', english: 'o\'clock', roman: 'si'}, {korean: '반', english: 'thirty', roman: 'ban'}],
    '일곱 시 십오 분이에요.': [{korean: '시', english: 'o\'clock', roman: 'si'}, {korean: '분', english: 'minute', roman: 'bun'}]
  };

  const quote = s => `"${String(s||'').replace(/^"+|"+$/g,'').trim()}"`;
  let map=null, applying=false, timer=null;

  function buildMap(){
    const DB=window.SORI_DATA||{};
    const pools=[...(DB.daily||[]),...(DB.travel||[]),...(DB.drama||[]),...(DB.trendy||[]),...(DB.numbers||[])];
    const m=new Map();
    for(const o of pools){
      const k=(o.k||'').trim();
      if(k && !m.has(k)) m.set(k,{e:o.e||'',p:o.p||''});
    }
    return m;
  }
  function waitData(max=2000){
    return new Promise(res=>{
      const st=performance.now();
      (function poll(){
        if(window.SORI_DATA || performance.now()-st>max) return res(buildMap());
        setTimeout(poll,50);
      })();
    });
  }

  function hideLines(){ document.getElementById('lessonCard')?.classList.remove('lesson-ready'); }
  function showLines(){ document.getElementById('lessonCard')?.classList.add('lesson-ready'); }

  function updateNounDefinitions(koreanText) {
    const nounDefsEl = document.getElementById('nounDefinitions');
    const nounListEl = nounDefsEl?.querySelector('.noun-list');
    
    if (!nounDefsEl || !nounListEl) return;
    
    const nouns = nounData[koreanText];
    
    if (nouns && nouns.length > 0) {
      nounListEl.innerHTML = '';
      nouns.forEach(noun => {
        const nounItem = document.createElement('div');
        nounItem.className = 'noun-item';
        nounItem.innerHTML = `
          <span class="noun-korean">${noun.korean}</span>
          <span class="noun-english">${noun.english}</span>
          <span class="noun-roman">${noun.roman}</span>
        `;
        nounListEl.appendChild(nounItem);
      });
      nounDefsEl.style.display = 'block';
    } else {
      nounDefsEl.style.display = 'none';
    }
  }

  function applyOnce(){
    if(applying) return;
    const ctx=context, en=english, pr=pronunciation, koEl=korean;
    if(!ctx||!en||!pr||!koEl) return;

    const ko=(koEl.textContent||'').trim();
    const hit=map?.get(ko)||{};
    const meaning=hit.e || (ctx.textContent||'').replace(/(^"+|"+$)/g,'').trim();
    const roman  =hit.p || (pr.textContent||'').trim() || (en.textContent||'').trim();

    applying=true;
    try{
      if(meaning) ctx.textContent=quote(meaning);
      if(roman)   en.textContent=roman;
      pr.style.display='none';
      
      // 명사 정의 업데이트
      updateNounDefinitions(ko);
      
      showLines();
    }finally{
      setTimeout(()=>{ applying=false; },0);
    }
  }

  function scheduleApply(){
    hideLines();
    clearTimeout(timer);
    timer=setTimeout(applyOnce,110);
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    hideLines();
    map=await waitData();
    scheduleApply();
    const mo=new MutationObserver(()=>{ if(!applying) scheduleApply(); });
    korean && mo.observe(korean,{childList:true,characterData:true,subtree:true});
    ['nextBtn','prevBtn','dailyBtn','travelBtn','dramaBtn','trendyBtn','numbersBtn','savedBtnHidden','subFilters']
      .forEach(id=>{
        const el=(id==='subFilters')?document.getElementById(id):document.getElementById(id);
        el&&el.addEventListener('click', scheduleApply, true);
      });

    const speedEl=speed, speedLbl=speedTxt;
    const sync=()=> speedLbl.textContent=(parseFloat(speedEl.value)).toFixed(2)+'x';
    speedEl.addEventListener('input', sync); sync();
  });
})();
</script>

<!-- Threads 1-클릭: 카드 캡처(+가능하면 파일 공유) -> Threads 텍스트 열기 -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const shareBtn = document.getElementById('threadShareBtn');
  const koEl = document.getElementById('korean');
  const ctxEl = document.getElementById('context');

  async function captureCardBlob(){
    // 헤더와 lessonCard만 포함하는 모바일 최적화 컨테이너 생성
    const header = document.querySelector('.header');
    const lessonCard = document.getElementById('lessonCard');
    
    // 임시 컨테이너 생성 (모바일 최적화)
    const container = document.createElement('div');
    container.style.cssText = `
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 375px;
      max-width: 375px;
      background: #faf8ff;
      padding: 12px;
      box-sizing: border-box;
    `;
    
    // 헤더와 lessonCard 복사
    const headerClone = header.cloneNode(true);
    const lessonCardClone = lessonCard.cloneNode(true);
    
    // 모바일 스타일 적용
    headerClone.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 0;
    `;
    
    lessonCardClone.style.cssText = `
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      margin: 0;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
    `;
    
    container.appendChild(headerClone);
    container.appendChild(lessonCardClone);
    document.body.appendChild(container);
    
    // 폰트 로드 대기
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }
    
    const canvas = await html2canvas(container, {
      backgroundColor:'#faf8ff', 
      scale:2,
      useCORS: true,
      allowTaint: true,
      logging: false,
      width: 375,
      height: container.scrollHeight
    });
    
    // 임시 컨테이너 제거
    document.body.removeChild(container);
    
    return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/png'));
  }

  async function shareToThreads(){
    const ko = (koEl?.textContent||'').trim();
    const en = (ctxEl?.textContent||'').replace(/^"+|"+$/g,'').trim() || 'Learn Korean with Sori';
    const shareText = `Sori - Learn Korean by Sound\nhttp://sorikorea.com`;

    console.log('Share Text:', shareText);

    try{
      const blob = await captureCardBlob();
      
      // 방법 1: Web Share API 사용 (모바일에서 가장 확실)
      if (navigator.share) {
        try {
          console.log('Trying Web Share API');
          const file = new File([blob], 'sori-phrase.png', {type: 'image/png'});
          
          await navigator.share({
            title: 'Sori - Learn Korean by Sound',
            text: shareText,
            files: [file]
          });
          console.log('Web Share API success');
          return;
        } catch (shareError) {
          console.log('Web Share API failed:', shareError);
        }
      }

      // 방법 2: 클립보드에 텍스트 복사 + 이미지 다운로드
      try {
        await navigator.clipboard.writeText(shareText);
        console.log('Text copied to clipboard');
      } catch (clipErr) {
        console.warn('Clipboard copy failed:', clipErr);
      }

      // 이미지 다운로드
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'sori-phrase.png';
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      
      // 방법 3: 여러 Threads URL 시도
      const threadsUrls = [
        `https://threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://threads.net/new?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/new?text=${encodeURIComponent(shareText)}`
      ];
      
      console.log('Trying multiple Threads URLs:', threadsUrls);
      
      // 첫 번째 URL로 시도
      let success = false;
      for (let i = 0; i < threadsUrls.length; i++) {
        try {
          const newWindow = window.open(threadsUrls[i], '_blank', 'width=400,height=600');
          if (newWindow) {
            console.log(`Threads URL ${i+1} opened successfully`);
            success = true;
            break;
          }
        } catch (e) {
          console.log(`Threads URL ${i+1} failed:`, e);
        }
      }
      
      if (!success) {
        // 방법 4: 직접 링크로 이동
        console.log('Trying direct navigation');
        window.location.href = threadsUrls[0];
      }
      
      // 사용자에게 알림
      const t = document.getElementById('congrats');
      if (t) {
        t.textContent = '이미지 저장됨. 텍스트는 클립보드에 복사되었어요!';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      }
      
      // URL 정리
      setTimeout(() => URL.revokeObjectURL(url), 10000);
      
      try { 
        gtag('event', 'share_threads_multiple', {send_to: 'G-X1Q98DBKR5'}); 
      } catch(e) {}
      
    } catch(e) {
      console.error('Share failed:', e);
      alert('공유에 실패했습니다: ' + e.message);
    }
  }

  shareBtn && shareBtn.addEventListener('click', shareToThreads);
});
</script>

<div id="congrats" aria-live="polite"></div>
</body>
</html>
