<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sori - Learn Korean by Sound</title>
<meta name="theme-color" content="#7c3aed"/>
<!-- Webfont for consistent capture rendering -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;800;900&display=swap" rel="stylesheet">

<link rel="icon" type="image/svg+xml"
  href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="#7c3aed"/>
    <text x="32" y="42" font-family="sans-serif" font-size="24" font-weight="bold" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- Additional favicon formats for better browser compatibility -->
<link rel="icon" type="image/png" sizes="32x32" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <circle cx="16" cy="16" r="15" fill="#7c3aed"/>
    <text x="16" y="21" font-family="sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle">S</text>
  </svg>'/>
<link rel="icon" type="image/png" sizes="16x16" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <circle cx="8" cy="8" r="7" fill="#7c3aed"/>
    <text x="8" y="11" font-family="sans-serif" font-size="6" font-weight="bold" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- Apple Touch Icon for home screen -->
<link rel="apple-touch-icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 180">
    <circle cx="90" cy="90" r="85" fill="#7c3aed"/>
    <text x="90" y="118" font-family="sans-serif" font-size="68" font-weight="bold" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- Android and PWA icons -->
<link rel="icon" type="image/png" sizes="192x192" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192">
    <circle cx="96" cy="96" r="90" fill="#7c3aed"/>
    <text x="96" y="125" font-family="sans-serif" font-size="48" font-weight="bold" fill="white" text-anchor="middle">Sori</text>
  </svg>'/>
<link rel="icon" type="image/png" sizes="512x512" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <circle cx="256" cy="256" r="240" fill="#7c3aed"/>
    <text x="256" y="340" font-family="sans-serif" font-size="128" font-weight="bold" fill="white" text-anchor="middle">Sori</text>
  </svg>'/>

<!-- PWA Manifest -->
<link rel="manifest" href='data:application/json;utf8,
  {
    "name": "Sori - Learn Korean by Sound",
    "short_name": "Sori",
    "description": "Learn Korean naturally by repeating real sounds",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#faf8ff",
    "theme_color": "#7c3aed",
    "icons": [
      {
        "src": "data:image/svg+xml;utf8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22%3E%3Ccircle cx=%2296%22 cy=%2296%22 r=%2290%22 fill=%22%237c3aed%22/%3E%3Ctext x=%2296%22 y=%22125%22 font-family=%22sans-serif%22 font-size=%2248%22 font-weight=%22bold%22 fill=%22white%22 text-anchor=%22middle%22%3ESori%3C/text%3E%3C/svg%3E",
        "sizes": "192x192",
        "type": "image/svg+xml"
      },
      {
        "src": "data:image/svg+xml;utf8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22%3E%3Ccircle cx=%22256%22 cy=%22256%22 r=%22240%22 fill=%22%237c3aed%22/%3E%3Ctext x=%22256%22 y=%22340%22 font-family=%22sans-serif%22 font-size=%22128%22 font-weight=%22bold%22 fill=%22white%22 text-anchor=%22middle%22%3ESori%3C/text%3E%3C/svg%3E",
        "sizes": "512x512",
        "type": "image/svg+xml"
      }
    ]
  }'/>

<script>window.GA_ID='G-X1Q98DBKR5';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config',window.GA_ID,{send_page_view:false});
</script>

<!-- Firebase v9 모듈 방식으로 로딩 -->

<!-- html2canvas: 카드 캡처용 -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;max-width:720px;margin:0 auto;padding:16px;background:#faf8ff;min-height:100vh;color:#111827}
h1{font-size:26px;margin:0 0 4px;color:#7c3aed;font-weight:800}
.intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.top-btn{padding:8px 14px;border-radius:12px;font-size:12px;font-weight:700;border:0;cursor:pointer}
.top-btn.primary{background:#7c3aed;color:#fff}

.card{background:#fff;border-radius:18px;padding:18px;margin:10px 0;box-shadow:0 2px 12px rgba(0,0,0,.06)}

.category-bar{display:flex;align-items:center;gap:12px}
.picker-wrap{position:relative}
.picker-trigger{padding:12px 18px;border-radius:14px;background:#7c3aed;color:#fff;font-weight:800;border:0;cursor:pointer;min-width:220px;text-align:center}
.picker-menu{position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .25s ease;z-index:50}
.picker-menu.open{max-height:220px}
.picker-list{max-height:210px;overflow-y:auto;padding:6px;scrollbar-width:thin}
.picker-item{height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none}
.picker-item:hover,.picker-item.active{background:#7c3aed;color:#fff}
.saved-btn{height:44px;padding:0 18px;border-radius:12px;background:#fff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap}
.saved-btn:hover{background:#f7f2ff}

.sub-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
.sub-chip.active{background:#7c3aed;border-color:#7c3aed;color:#fff}

.row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:12px}
.icon-btn{border:none;background:transparent;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;color:#9ca3af;cursor:pointer;border-radius:8px}
.icon-btn.active{color:#e11d48}

#lessonCard .context,
#lessonCard .en{opacity:0; transition:opacity .12s ease;}
#lessonCard.lesson-ready .context,
#lessonCard.lesson-ready .en{opacity:1;}

.context{color:#6b7280;font-size:16px;text-align:center;margin:8px 0 0;font-weight:600}

.kbox{background:#f3f4f6;border-radius:16px;padding:18px 14px;margin:12px 0;text-align:center}
.ko{font-size:30px;font-weight:900;margin:0 0 8px}
.en{color:#6b7280;font-size:16px;margin:0 0 10px;font-weight:600}

.practice{background:#f9fafb;border-radius:12px;padding:12px}
.practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
.dots{display:flex;gap:10px;justify-content:center;margin-bottom:8px}
.rep-dot{width:30px;height:30px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;transition:.15s}
.rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

button.big{width:100%;padding:14px 20px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff}

.row{display:flex;align-items:center;justify-content:center;gap:12px;background:#f9fafb;border-radius:10px;padding:10px;margin-top:8px}
.speed-val{min-width:56px;text-align:left;font-variant-numeric:tabular-nums}
input[type="range"]{accent-color:#7c3aed;outline:0}
input[type="range"]::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-webkit-slider-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9;margin-top:-6px}
input[type="range"]::-moz-range-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9}

.tip-card{margin-top:10px;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
.tip-text{font-size:12px;color:#9f1239;font-weight:600}

.hidden-tabs{display:none}

.auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.45);padding:16px}
.auth.open{display:flex}
.auth-card{background:#fff;width:100%;max-width:380px;border-radius:20px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
.auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}
.gbtn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:10px 14px;border-radius:12px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;font-weight:700;cursor:pointer}
.gbtn:hover{border-color:#d8dbe2;box-shadow:0 2px 8px rgba(124,58,237,.15)}
.glogo{width:18px;height:18px;display:inline-block}

.navbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:nowrap}
.nav-center{min-width:130px;text-align:center;font-size:13px;color:#6b7280;font-weight:700}
.nav-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 28px;border-radius:14px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;cursor:pointer;font-weight:800;font-size:14px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
.nav-btn:hover{border-color:#d8dbe2}
.nav-btn .caret{font-size:15px;color:#7c3aed}
.nav-btn:disabled{opacity:.5;cursor:not-allowed}

@media (max-width:480px){
  .navbar{flex-wrap:wrap}
  .nav-btn{flex:1 1 calc(50% - 8px);min-width:140px}
  .nav-center{order:3;width:100%;margin-top:8px}
}

/* Congrats toast */
#congrats {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  padding: 10px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,.75);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
  z-index: 9999;
}
#congrats.show { opacity: 1; }

/* brand badge (included in capture) */
.brand-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:6px}
.brand{display:inline-flex;align-items:center;gap:8px;background:#f5f3ff;border:1.5px solid #e9defd;padding:6px 10px;border-radius:999px;color:#7c3aed;font-weight:800;font-size:12px}
.brand svg{display:block}
</style>
</head>
<body>
<header class="header">
  <div>
    <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
    <div class="intro">Learn Korean naturally by repeating real sounds</div>
  </div>
  <button id="loginBtn" class="top-btn primary">Login</button>
</header>

<section class="card">
  <div class="category-bar">
    <div class="picker-wrap">
      <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox" aria-expanded="false">Daily</button>
      <div id="pickerMenu" class="picker-menu"><div class="picker-list" role="listbox"></div></div>
    </div>
    <button id="savedBtn" class="saved-btn">★ Saved</button>
  </div>

  <div class="hidden-tabs" aria-hidden="true">
    <button id="dailyBtn"    class="tab-button active">Daily</button>
    <button id="travelBtn"   class="tab-button">Travel</button>
    <button id="trendyBtn"   class="tab-button">Trendy Talk</button>
    <button id="dramaBtn"    class="tab-button">K-Drama</button>
    <button id="numbersBtn"  class="tab-button">Numbers</button>
    <button id="savedBtnHidden" class="tab-button">Saved</button>
  </div>

  <div id="subFilters" class="sub-filters"></div>
</section>

<section class="card" id="lessonCard">
  <div class="row-between">
    <div id="badge" class="badge">Love</div>

    <div style="display:flex;gap:6px;align-items:center;">
      <!-- 공유 버튼 (별표와 동일한 디자인) -->
      <button id="threadShareBtn" class="icon-btn" title="Share" aria-label="Share" type="button" style="font-size:18px;">↗</button>

      <!-- 기존 별표 저장 버튼 -->
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save" style="font-size:18px;">☆</button>
    </div>
  </div>

  <div id="context" class="context">"I like you."</div>

  <div class="kbox">
    <p id="korean" class="ko">당신이 좋아요.</p>
    <p id="english" class="en">dangshini joayo</p>
    <p id="pronunciation" style="display:none">dangshini joayo</p>
  </div>

  <div class="practice">
    <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
    <div class="dots">
      <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
    </div>
  </div>

  <button id="playBtn" class="big">Listen & Repeat</button>
  <div class="row">
    <label>Speed:</label>
    <input id="speed" type="range" min="0.6" max="1.0" step="0.05" value="0.80"/>
    <span id="speedTxt" class="speed-val">0.80x</span>
  </div>

  <div class="tip-card"><div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div></div>
</section>

<section class="card">
  <div class="navbar">
    <button id="prevBtn" class="nav-btn"><span class="caret">◀</span> Previous</button>
    <div id="prog" class="nav-center">1 / 45</div>
    <button id="nextBtn" class="nav-btn">Next <span class="caret">▶</span></button>
  </div>
</section>

<div id="authModal" class="auth">
  <div class="auth-card">
    <button id="authClose" class="auth-close" aria-label="Close">×</button>
    <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
    <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
    <button class="gbtn" id="googleLoginBtn">
      <span class="glogo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><path fill="#EA4335" d="M9 7.3h8.5v3.4H9z"/><path fill="#4285F4" d="M17.6 9.2c0-.6-.1-1.2-.2-1.8H9v3.4h4.8c-.2 1-.8 1.8-1.7 2.3v1.9h2.8c1.6-1.5 2.7-3.7 2.7-5.8z"/><path fill="#FBBC05" d="M9 18c2.4 0 4.4-.8 5.9-2.2l-2.8-1.9c-.8.5-1.8.8-3.1.8-2.4 0-4.5-1.6-5.2-3.7H.9v2.3C2.4 15.9 5.4 18 9 18z"/><path fill="#34A853" d="M3.8 11c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V4.7H.9C.3 6 0 7.5 0 9s.3 3 .9 4.3L3.8 11z"/><path fill="#EB4335" d="M9 3.5c1.3 0 2.5.5 3.4 1.4l2.3-2.3C13.4.9 11.4 0 9 0 5.4 0 2.4 2.1.9 4.7L3.8 7c.7-2.1 2.8-3.5 5.2-3.5z"/></svg>
      </span>
      Continue with Google
    </button>
  </div>
</div>

<!-- data sources -->
<script defer src="data/daily.js?v=20251017"></script>
<script defer src="data/travel.js?v=20251017"></script>
<script defer src="data/drama.js?v=20251017"></script>
<script defer src="data/trendy.js?v=20251019"></script>
<script defer src="data/numbers.js?v=20251019"></script>
<script defer src="data/dataindex.js?v=20251019"></script>

<!-- app scripts -->
<script type="module" src="js/firebase-init.js?v=20251021"></script>
<script type="module" src="js/auth.js?v=20251021"></script>
<script defer src="js/state.js?v=20251017"></script>
<script defer src="js/tts.js?v=20251017"></script>
<script defer src="js/app.js?v=20251017"></script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const modal=authModal, loginBtn=document.getElementById('loginBtn'), closeBtn=authClose, googleBtn=document.getElementById('googleLoginBtn');
  const open = ()=> modal.classList.add('open');
  const close=()=> modal.classList.remove('open');
  function wireAsLogin(){ loginBtn.textContent='Login'; loginBtn.onclick=open; }
  function wireAsLogout(){ loginBtn.textContent='Logout'; loginBtn.onclick= async ()=>{ try{ await window.SoriUser?.logout?.(); }catch(e){} }; }
  closeBtn?.addEventListener('click', close);
  modal?.addEventListener('click', e=>{ if(e.target===modal) close(); });
  googleBtn?.addEventListener('click', ()=>{ window.handleGoogleLogin && window.handleGoogleLogin(); });
  
  // 즉시 로그인 버튼 활성화 (Firebase 준비와 관계없이)
  wireAsLogin();
  
  // Firebase 준비 이벤트 리스너
  window.addEventListener('firebaseReady', () => {
    console.log("Firebase 준비 완료, 인증 상태 확인 시작");
    try {
      window.firebaseAuth.onAuthStateChanged(user=>{ 
        console.log("Auth state changed:", user ? "로그인됨" : "로그아웃됨");
        user ? (close(), wireAsLogout()) : wireAsLogin(); 
      }); 
    } catch(e) {
      console.log("Auth state change error:", e);
      wireAsLogin();
    }
  });
  
  // Firebase가 준비되지 않은 경우를 위한 폴백
  setTimeout(() => {
    if (!window.firebaseAuth) {
      console.log("Firebase 준비 시간 초과, 기본 로그인 상태로 설정");
      wireAsLogin();
    }
  }, 3000);
});
</script>

<script>
(function(){
  const CATS=["Daily","Travel","Trendy Talk","K-Drama","Numbers"];
  const trigger=pickerTrigger, menu=pickerMenu, list=menu.querySelector('.picker-list');
  list.innerHTML='';
  CATS.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='picker-item'+(i===0?' active':''); el.textContent=c;
    el.onclick=()=>{ list.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active')); el.classList.add('active');
      trigger.textContent=c; menu.classList.remove('open');
      const key=c.toLowerCase();
      if(key==='daily') dailyBtn.click();
      else if(key==='travel') travelBtn.click();
      else if(key==='k-drama' || key==='kdrama') dramaBtn.click();
      else if(key==='numbers') numbersBtn.click();
      else trendyBtn.click();
      changeTip();
    };
    list.appendChild(el);
  });
  trigger.onclick=(e)=>{ e.stopPropagation(); menu.classList.toggle('open'); };
  document.onclick=()=>menu.classList.remove('open');
  savedBtn?.addEventListener('click',()=> savedBtnHidden?.click());

  const tips=[
    "Tip: Small daily reps beat big, rare sessions.","Tip: Shadow the sound, not the spelling.",
    "Tip: Say it out loud — your mouth must learn too.","Tip: Five clean repeats > twenty sloppy ones.",
    "Tip: Record yourself and match the rhythm.","Tip: First mimic, then understand.",
    "Tip: Keep the same speed; build consistency.","Tip: Close your eyes and copy the melody.",
    "Tip: Bite-sized goals. One phrase at a time.","Tip: Revisit yesterday — retention makes speed."
  ];
  const tipEl=tipText; function changeTip(){ tipEl.textContent=tips[Math.floor(Math.random()*tips.length)]; } changeTip();
})();
</script>

<script>
(function(){
  const btn={next:nextBtn,prev:prevBtn,daily:dailyBtn,travel:travelBtn,drama:dramaBtn,trendy:trendyBtn,numbers:numbersBtn};
  const progEl=prog, badgeEl=badge; const tabs=[btn.daily,btn.travel,btn.trendy,btn.drama,btn.numbers].filter(Boolean);
  const CAT_KEY={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'drama',trendyBtn:'trendy',numbersBtn:'numbers'};
  const getActiveTab=()=> tabs.find(t=>t.classList.contains('active'))||btn.daily;
  const getActiveCatKey=()=> CAT_KEY[getActiveTab().id];
  function getProgress(){ const m=(progEl?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/); if(!m) return {i:1,total:1}; return {i:parseInt(m[1],10),total:parseInt(m[2],10)};}
  function subOrderOf(catKey){ const arr=(window.SORI_DATA&&window.SORI_DATA[catKey])||[]; const order=[]; for(const x of arr){const s=x?.sub||'Default'; if(!order.includes(s)) order.push(s);} return order;}
  const currentSubName=()=> (badgeEl?.textContent||'').trim();
  function goFirstItem(){ const {i}=getProgress(); for(let k=1;k<i;k++) btn.prev?.click(); setTimeout(()=>{ const again=getProgress().i; for(let k=1;k<again;k++) btn.prev?.click();},0); }
  function clickSubChipByName(name){ const chips=[...document.querySelectorAll('#subFilters .sub-chip')]; const t=chips.find(c=>(c.textContent||'').trim()===name)||chips.find(c=>(c.textContent||'').includes(name)); if(t) t.click(); }
  function goFirstSubAndItem(){ setTimeout(()=>{ const first=document.querySelector('#subFilters .sub-chip'); if(first) first.click(); setTimeout(goFirstItem,0); },0); }
  btn.next?.addEventListener('click',function(e){ const {i,total}=getProgress(); if(i<total) return; e.preventDefault(); e.stopImmediatePropagation();
    const subs=subOrderOf(getActiveCatKey()); const cur=currentSubName(); const idx=Math.max(0,subs.indexOf(cur));
    if(idx>-1 && idx<subs.length-1){ clickSubChipByName(subs[idx+1]); setTimeout(goFirstItem,0); return; }
    const curTab=getActiveTab(); const tIdx=tabs.indexOf(curTab); const nextIdx=(tIdx+1)%tabs.length; tabs[nextIdx].click(); goFirstSubAndItem();
  },true);
  tabs.forEach(t=> t?.addEventListener('click',()=>{ goFirstSubAndItem(); }));
})();
</script>

<script>
(function(){
  function buildPath(){
    const active=document.querySelector('.tab-button.active')?.id || 'dailyBtn';
    const catMap={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'kdrama',trendyBtn:'trendy',numbersBtn:'numbers',savedBtn:'saved'};
    const cat=catMap[active]||'daily';
    const sub=(badge?.textContent||'default').trim().replace(/\s+/g,'-').toLowerCase();
    const m=(prog?.textContent||'1 / 1').match(/(\d+)\s*\/\s*(\d+)/); const idx=m?parseInt(m[1],10):1;
    return `/${cat}/${sub}/${idx}`;
  }
  function sendPV(title){ try{ gtag('event','page_view',{page_title:title||document.title,page_location:location.href,page_path:buildPath(),send_to:'G-X1Q98DBKR5'});}catch(e){} }
  function sendSessionStart(){ try{ gtag('event','session_start',{send_to:'G-X1Q98DBKR5'});}catch(e){} }
  document.addEventListener('DOMContentLoaded',()=>{ setTimeout(()=>{ sendSessionStart(); sendPV('Sori'); },0); });
  ['dailyBtn','travelBtn','dramaBtn','trendyBtn','numbersBtn','savedBtnHidden'].forEach(id=>{ const el=document.getElementById(id); el&&el.addEventListener('click',()=> setTimeout(()=>sendPV(`Sori - ${el.textContent.trim()}`),0)); });
  const subFilters=document.getElementById('subFilters');
  subFilters&&subFilters.addEventListener('click',e=>{ const chip=e.target.closest('.sub-chip'); if(!chip) return; setTimeout(()=>sendPV(`Sori - ${chip.textContent.trim()}`),0); });
  nextBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Next'),0),true);
  prevBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Prev'),0),true);
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') setTimeout(()=>sendPV('Sori - resume'),0); });
  speed?.addEventListener('change',()=>{ gtag('event','change_speed',{value:speed.value,send_to:'G-X1Q98DBKR5'}); });
  window.buildPath = buildPath;
})();
</script>

<!-- TTS API 0.6~1.0 with toast -->
<script>
window.addEventListener('load',()=>{
  const ENDPOINT="https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
  const audio=new Audio(); let lastUrl=null;
  const speedEl=document.getElementById('speed');

  function getRate(){ const v=parseFloat(speedEl?.value||'1'); return Math.max(0.6, Math.min(1.0, v)); }
  function setAudioRate(){ audio.playbackRate=getRate(); }
  speedEl?.addEventListener('input', setAudioRate);

  async function playKo(text){
    try{ audio.pause(); }catch(_){}
    if(lastUrl){ try{ URL.revokeObjectURL(lastUrl);}catch(_){ } lastUrl=null; }
    const t=(text||'').trim(); if(!t) return;
    const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})});
    const b=await r.blob(); const url=URL.createObjectURL(b); lastUrl=url; audio.src=url; setAudioRate(); await audio.play();
  }

  document.getElementById('playBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault(); e.stopImmediatePropagation();
    const ko=(document.getElementById('korean')?.textContent||'').trim();
    await playKo(ko);

    const cntEl=document.getElementById('repCount');
    let n=parseInt(cntEl.textContent||'0',10);
    if(n<5){ n++; cntEl.textContent=String(n); }
    document.querySelectorAll('.rep-dot').forEach((d,i)=> d.classList.toggle('completed', i < n));

    if(n===5){
      const toast=document.getElementById('congrats');
      if(toast){
        toast.textContent="Nice work!";
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1800);
      }
    }
  }, true);

  if('speechSynthesis' in window){
    try{ window.speechSynthesis.speak = ()=>{}; window.speechSynthesis.cancel = ()=>{}; }catch(_){}
  }
});
</script>

<script>
(function(){
  const quote = s => `"${String(s||'').replace(/^"+|"+$/g,'').trim()}"`;
  let map=null, applying=false, timer=null;

  function buildMap(){
    const DB=window.SORI_DATA||{};
    const pools=[...(DB.daily||[]),...(DB.travel||[]),...(DB.drama||[]),...(DB.trendy||[]),...(DB.numbers||[])];
    const m=new Map();
    for(const o of pools){
      const k=(o.k||'').trim();
      if(k && !m.has(k)) m.set(k,{e:o.e||'',p:o.p||''});
    }
    return m;
  }
  function waitData(max=2000){
    return new Promise(res=>{
      const st=performance.now();
      (function poll(){
        if(window.SORI_DATA || performance.now()-st>max) return res(buildMap());
        setTimeout(poll,50);
      })();
    });
  }

  function hideLines(){ document.getElementById('lessonCard')?.classList.remove('lesson-ready'); }
  function showLines(){ document.getElementById('lessonCard')?.classList.add('lesson-ready'); }

  function applyOnce(){
    if(applying) return;
    const ctx=context, en=english, pr=pronunciation, koEl=korean;
    if(!ctx||!en||!pr||!koEl) return;

    const ko=(koEl.textContent||'').trim();
    const hit=map?.get(ko)||{};
    const meaning=hit.e || (ctx.textContent||'').replace(/(^"+|"+$)/g,'').trim();
    const roman  =hit.p || (pr.textContent||'').trim() || (en.textContent||'').trim();

    applying=true;
    try{
      if(meaning) ctx.textContent=quote(meaning);
      if(roman)   en.textContent=roman;
      pr.style.display='none';
      showLines();
    }finally{
      setTimeout(()=>{ applying=false; },0);
    }
  }

  function scheduleApply(){
    hideLines();
    clearTimeout(timer);
    timer=setTimeout(applyOnce,110);
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    hideLines();
    map=await waitData();
    scheduleApply();
    const mo=new MutationObserver(()=>{ if(!applying) scheduleApply(); });
    korean && mo.observe(korean,{childList:true,characterData:true,subtree:true});
    ['nextBtn','prevBtn','dailyBtn','travelBtn','dramaBtn','trendyBtn','numbersBtn','savedBtnHidden','subFilters']
      .forEach(id=>{
        const el=(id==='subFilters')?document.getElementById(id):document.getElementById(id);
        el&&el.addEventListener('click', scheduleApply, true);
      });

    const speedEl=speed, speedLbl=speedTxt;
    const sync=()=> speedLbl.textContent=(parseFloat(speedEl.value)).toFixed(2)+'x';
    speedEl.addEventListener('input', sync); sync();
  });
})();
</script>

<!-- Threads 1-클릭: 카드 캡처(+가능하면 파일 공유) -> Threads 텍스트 열기 -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const shareBtn = document.getElementById('threadShareBtn');
  const koEl = document.getElementById('korean');
  const ctxEl = document.getElementById('context');

  async function captureCardBlob(){
    // 헤더와 lessonCard만 포함하는 모바일 최적화 컨테이너 생성
    const header = document.querySelector('.header');
    const lessonCard = document.getElementById('lessonCard');
    
    // 임시 컨테이너 생성 (모바일 최적화)
    const container = document.createElement('div');
    container.style.cssText = `
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 375px;
      max-width: 375px;
      background: #faf8ff;
      padding: 12px;
      box-sizing: border-box;
    `;
    
    // 헤더와 lessonCard 복사
    const headerClone = header.cloneNode(true);
    const lessonCardClone = lessonCard.cloneNode(true);
    
    // 모바일 스타일 적용
    headerClone.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 0;
    `;
    
    lessonCardClone.style.cssText = `
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      margin: 0;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
    `;
    
    container.appendChild(headerClone);
    container.appendChild(lessonCardClone);
    document.body.appendChild(container);
    
    // 폰트 로드 대기
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }
    
    const canvas = await html2canvas(container, {
      backgroundColor:'#faf8ff', 
      scale:2,
      useCORS: true,
      allowTaint: true,
      logging: false,
      width: 375,
      height: container.scrollHeight
    });
    
    // 임시 컨테이너 제거
    document.body.removeChild(container);
    
    return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/png'));
  }

  async function shareToThreads(){
    const ko = (koEl?.textContent||'').trim();
    const en = (ctxEl?.textContent||'').replace(/^"+|"+$/g,'').trim() || 'Learn Korean with Sori';
    const shareText = `Sori - Learn Korean by Sound\nhttp://sorikorea.com`;

    console.log('Share Text:', shareText);

    try{
      const blob = await captureCardBlob();
      
      // 방법 1: Web Share API 사용 (모바일에서 가장 확실)
      if (navigator.share) {
        try {
          console.log('Trying Web Share API');
          const file = new File([blob], 'sori-phrase.png', {type: 'image/png'});
          
          await navigator.share({
            title: 'Sori - Learn Korean by Sound',
            text: shareText,
            files: [file]
          });
          console.log('Web Share API success');
          return;
        } catch (shareError) {
          console.log('Web Share API failed:', shareError);
        }
      }

      // 방법 2: 클립보드에 텍스트 복사 + 이미지 다운로드
      try {
        await navigator.clipboard.writeText(shareText);
        console.log('Text copied to clipboard');
      } catch (clipErr) {
        console.warn('Clipboard copy failed:', clipErr);
      }

      // 이미지 다운로드
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'sori-phrase.png';
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      
      // 방법 3: 여러 Threads URL 시도
      const threadsUrls = [
        `https://threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://threads.net/new?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/new?text=${encodeURIComponent(shareText)}`
      ];
      
      console.log('Trying multiple Threads URLs:', threadsUrls);
      
      // 첫 번째 URL로 시도
      let success = false;
      for (let i = 0; i < threadsUrls.length; i++) {
        try {
          const newWindow = window.open(threadsUrls[i], '_blank', 'width=400,height=600');
          if (newWindow) {
            console.log(`Threads URL ${i+1} opened successfully`);
            success = true;
            break;
          }
        } catch (e) {
          console.log(`Threads URL ${i+1} failed:`, e);
        }
      }
      
      if (!success) {
        // 방법 4: 직접 링크로 이동
        console.log('Trying direct navigation');
        window.location.href = threadsUrls[0];
      }
      
      // 사용자에게 알림
      const t = document.getElementById('congrats');
      if (t) {
        t.textContent = '이미지 저장됨. 텍스트는 클립보드에 복사되었어요!';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      }
      
      // URL 정리
      setTimeout(() => URL.revokeObjectURL(url), 10000);
      
      try { 
        gtag('event', 'share_threads_multiple', {send_to: 'G-X1Q98DBKR5'}); 
      } catch(e) {}
      
    } catch(e) {
      console.error('Share failed:', e);
      alert('공유에 실패했습니다: ' + e.message);
    }
  }

  shareBtn && shareBtn.addEventListener('click', shareToThreads);
});
</script>

<div id="congrats" aria-live="polite"></div>
</body>
</html>
