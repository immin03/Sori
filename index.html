<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sori - Learn Korean by Sound</title>
  <meta name="theme-color" content="#7c3aed"/>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="#7c3aed" stroke="#6d28d9" stroke-width="2"/>
      <text x="16" y="40" font-family="sans-serif" font-size="22" font-weight="bold" fill="white">소</text>
    </svg>'/>

  <!-- GA -->
  <script>window.GA_ID='G-X1Q98DBKR5';</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date());
    gtag('config',window.GA_ID,{send_page_view:false});
  </script>

  <!-- Firebase compat -->
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --purple:#7c3aed;
      --purple-dark:#6d28d9;
      --chip:#e5e7eb;
      --ink:#1f2937;
      --muted:#6b7280;
      --pink:#e11d48;
      --pink-bg:#fff1f2;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      max-width:680px;margin:0 auto;padding:12px;background:#faf8ff;min-height:100vh
    }
    h1{font-size:24px;margin:0 0 4px;color:var(--purple);font-weight:800}
    .intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-btn{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:0;cursor:pointer}
    .top-btn.primary{background:var(--purple);color:#fff}

    .card{background:#fff;border-radius:16px;padding:16px;margin:8px 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}

    /* ===== Category wheel picker (3-row viewport) ===== */
    .category-bar{display:flex;align-items:center;gap:12px}
    .picker-wrap{position:relative}
    .picker-trigger{
      padding:12px 18px;border-radius:14px;background:var(--purple);color:#fff;
      font-weight:800;border:0;cursor:pointer;min-width:200px;text-align:center
    }
    .picker-menu{
      position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .25s ease;z-index:50
    }
    .picker-menu.open{max-height:156px}
    .picker-list{max-height:150px;overflow-y:auto;padding:6px;scrollbar-width:thin}
    .picker-item{
      height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;
      background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none
    }
    .picker-item:hover,.picker-item.active{background:var(--purple);color:#fff}
    .saved-btn{
      height:44px;padding:0 16px;border-radius:12px;background:#fff;color:var(--purple);
      border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap
    }
    .saved-btn:hover{background:#f7f2ff}
    .hidden-tabs{display:none} /* legacy tabs for app.js */

    /* sub chips */
    .sub-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid var(--chip);color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
    .sub-chip.active{ background:var(--purple); border-color:var(--purple); color:#fff; }

    /* lesson header row */
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{display:inline-block;background:var(--purple);color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:10px}
    .icon-btn{border:none;background:transparent;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;line-height:1;color:#9ca3af;cursor:pointer;border-radius:8px}
    .icon-btn:hover{background:#f3f4f6}
    .icon-btn.active{color:var(--pink)} /* star pink */

    /* context (영어 뜻) + tight spacing */
    .context{color:var(--muted);font-size:16px;text-align:center;margin:6px 0 2px;font-weight:600}

    .kbox{background:#f9fafb;border-radius:14px;padding:16px 12px;margin:8px 0 12px;text-align:center}
    .ko{font-size:28px;font-weight:900;color:var(--ink);margin:4px 0 6px}
    .en{color:var(--muted);font-size:16px;margin:0 0 10px;font-weight:600}

    .practice{background:#f9fafb;border-radius:10px;padding:10px}
    .practice-label{font-size:12px;font-weight:600;color:var(--muted);text-align:center;margin:0 0 8px}
    .dots{display:flex;gap:6px;justify-content:center;margin-bottom:8px}
    .rep-dot{width:32px;height:32px;border-radius:50%;border:2px solid #e5e7eb;background:#fff}
    .rep-dot.completed{background:var(--purple);border-color:var(--purple)}

    button.big{width:100%;padding:12px 18px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:var(--purple);color:#fff}
    button.big:hover{background:var(--purple-dark)}

    .row{display:flex;align-items:center;justify-content:center;gap:8px;background:#f9fafb;border-radius:8px;padding:8px;margin-top:8px}
    .row label{color:var(--purple);font-size:12px;font-weight:600}
    .row span{color:var(--purple);font-size:12px;font-weight:700;min-width:42px;text-align:right}
    /* speed slider -> star pink */
    .row input[type="range"]{accent-color:var(--pink)}

    /* Prev/Next */
    .nav { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .secondary{
      appearance:none; -webkit-appearance:none; border:0;
      background:#f9fafb; color:#374151; font-weight:800; border-radius:14px;
      padding:12px 18px; box-shadow:inset 0 0 0 1px #e5e7eb; cursor:pointer;
    }
    .secondary:hover{ background:#f3f4f6; }
    .progress{text-align:center;color:var(--purple);font-size:13px;font-weight:700;margin-top:8px}

    /* Tip (pink) */
    .tip-card{margin-top:10px;background:var(--pink-bg);border-left:3px solid var(--pink);border-radius:10px;padding:10px}
    .tip-text{font-size:12px;color:#9f1239;font-weight:600}

    /* Auth modal */
    .auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.45);padding:16px}
    .auth.open{display:flex}
    .auth-card{background:#fff;width:100%;max-width:360px;border-radius:18px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
    .auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}
    .gbtn{
      display:flex; align-items:center; justify-content:center; gap:10px;
      width:100%; padding:11px 14px; border-radius:12px;
      background:#f7f2ff; color:var(--purple); font-weight:800; cursor:pointer;
      border:2px solid #e9defd;
    }
    .gbtn:hover{ background:#ede7ff; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
      <div class="intro">Learn Korean naturally by repeating real sounds</div>
    </div>
    <button id="loginBtn" class="top-btn primary">Login</button>
  </header>

  <!-- CATEGORY: wheel picker + saved -->
  <section class="card">
    <div class="category-bar">
      <div class="picker-wrap">
        <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox" aria-expanded="false">Daily</button>
        <div id="pickerMenu" class="picker-menu">
          <div class="picker-list" role="listbox">
            <div class="picker-item active">Daily</div>
            <div class="picker-item">Travel</div>
            <div class="picker-item">K-Drama</div>
          </div>
        </div>
      </div>
      <button id="savedBtn" class="saved-btn">★ Saved</button>
    </div>

    <!-- 숨김 레거시 탭 (app.js와 호환) -->
    <div class="hidden-tabs" aria-hidden="true">
      <button id="dailyBtn"  class="tab-button active">Daily</button>
      <button id="travelBtn" class="tab-button">Travel</button>
      <button id="dramaBtn"  class="tab-button">K-Drama</button>
      <button id="savedBtnHidden" class="tab-button">Saved</button>
    </div>

    <div id="subFilters" class="sub-filters"></div>
  </section>

  <!-- LESSON -->
  <section class="card">
    <div class="row-between">
      <div id="badge" class="badge">Greeting</div>
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save">☆</button>
    </div>

    <!-- 위: 영어 뜻 -->
    <div id="context" class="context">"Hello"</div>

    <div class="kbox">
      <p id="korean" class="ko">안녕하세요.</p>
      <p id="english" class="en">annyeonghaseyo</p>
      <p id="pronunciation" style="display:none">annyeonghaseyo</p>
    </div>

    <div class="practice">
      <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
      <div class="dots">
        <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
      </div>
    </div>

    <button id="playBtn" class="big">Listen & Repeat</button>
    <div class="row">
      <label>Speed:</label>
      <input id="speed" type="range" min="0.3" max="1.0" step="0.1" value="0.75" />
      <span id="speedTxt">0.75x</span>
    </div>

    <div class="tip-card"><div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div></div>
  </section>

  <!-- NAV -->
  <section class="card">
    <div class="nav">
      <button id="prevBtn" class="secondary">◀ Previous</button>
      <button id="nextBtn" class="secondary">▶ Next</button>
    </div>
    <div id="prog" class="progress">1 / 45</div>
  </section>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth">
    <div class="auth-card">
      <button id="authClose" class="auth-close" aria-label="Close">×</button>
      <div style="font-size:24px;font-weight:800;color:var(--purple);margin-bottom:6px;">Sign in</div>
      <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
      <button id="googleBtn" class="gbtn">
        <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
          <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.3 29.3 35 24 35c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.3 0 6.3 1.2 8.6 3.3l5.7-5.7C34.7 3.1 29.7 1 24 1 16 1 8.9 5.1 6.3 14.7z"/>
          <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.8 16.4 19 13 24 13c3.3 0 6.3 1.2 8.6 3.3l5.7-5.7C34.7 3.1 29.7 1 24 1 16 1 8.9 5.1 6.3 14.7z"/>
          <path fill="#4CAF50" d="M24 45c5.2 0 10-1.7 13.6-4.7l-6.3-5.2C29.2 36.8 26.8 37.6 24 37.6c-5.2 0-9.6-3.5-11.2-8.3l-6.5 5.1C8.7 40.8 15.8 45 24 45z"/>
          <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1 3.1-3.2 5.6-5.9 7.1l6.3 5.2c-0.4 0.3 8.3-6.1 8.3-18.3 0-1.5-.2-3-.4-4.5z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  <!-- DATA -->
  <script defer src="data/daily.js?v=20251017"></script>
  <script defer src="data/travel.js?v=20251017"></script>
  <script defer src="data/drama.js?v=20251017"></script>
  <script defer src="data/dataindex.js?v=20251017"></script>

  <!-- APP SCRIPTS -->
  <script defer src="js/state.js?v=20251017"></script>
  <script defer src="js/tts.js?v=20251017"></script>
  <script defer src="js/app.js?v=20251017"></script>

  <!-- Auth wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const modal = document.getElementById('authModal');
      const loginBtn = document.getElementById('loginBtn');
      const closeBtn = document.getElementById('authClose');
      const open = ()=> modal.classList.add('open');
      const close= ()=> modal.classList.remove('open');

      function wireAsLogin(){ loginBtn.textContent='Login'; loginBtn.onclick=open; }
      function wireAsLogout(){
        loginBtn.textContent='Logout';
        loginBtn.onclick= async ()=>{ try{ await window.SoriUser?.logout?.(); }catch(e){ console.warn(e);} };
      }
      closeBtn?.addEventListener('click', close);
      modal?.addEventListener('click', e=>{ if(e.target===modal) close(); });
      document.getElementById('googleBtn')?.addEventListener('click',()=>{ window.handleGoogleLogin && window.handleGoogleLogin(); });

      try{
        const auth = window.firebase?.auth && firebase.auth();
        auth?.onAuthStateChanged(user=>{ if(user){ close(); wireAsLogout(); } else { wireAsLogin(); }});
      }catch(e){ wireAsLogin(); }
    });
  </script>

  <!-- Picker logic + tip only on category change -->
  <script>
    (function(){
      const CATEGORIES=["Daily","Travel","K-Drama"];
      const trigger=pickerTrigger, menu=pickerMenu, list=menu.querySelector('.picker-list');
      const legacy={daily:dailyBtn,travel:travelBtn,drama:dramaBtn};

      list.innerHTML='';
      CATEGORIES.forEach((c,i)=>{
        const el=document.createElement('div');
        el.className='picker-item'+(i===0?' active':''); el.textContent=c;
        el.onclick=()=>select(c,el); list.appendChild(el);
      });
      function setActive(el){ list.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); }
      function select(name,el){
        setActive(el); trigger.textContent=name; menu.classList.remove('open');
        const key=name.toLowerCase();
        if(key==='daily')  legacy.daily?.click();
        if(key==='travel') legacy.travel?.click();
        if(key.includes('drama')) legacy.drama?.click();
        changeTip();
      }
      trigger.onclick=(e)=>{ e.stopPropagation(); menu.classList.toggle('open'); };
      document.onclick=()=> menu.classList.remove('open');
      savedBtn?.addEventListener('click',()=> savedBtnHidden?.click());

      const tips=[
        "Tip: Small daily reps beat big, rare sessions.",
        "Tip: Shadow the sound, not the spelling.",
        "Tip: Say it out loud — your mouth must learn too.",
        "Tip: Five clean repeats > twenty sloppy ones.",
        "Tip: Record yourself and match the rhythm.",
        "Tip: First mimic, then understand.",
        "Tip: Keep the same speed; build consistency.",
        "Tip: Close your eyes and copy the melody.",
        "Tip: Bite-sized goals. One phrase at a time.",
        "Tip: Revisit yesterday — retention makes speed."
      ];
      function changeTip(){ const el=document.getElementById('tipText'); if(el) el.textContent=tips[Math.floor(Math.random()*tips.length)]; }
      changeTip();
    })();
  </script>

  <!-- Navigation rewrite (기존) -->
  <script>
  (function(){
    const btn={next:nextBtn,prev:prevBtn,daily:dailyBtn,travel:travelBtn,drama:dramaBtn};
    const progEl=prog, badgeEl=badge; const tabs=[btn.daily,btn.travel,btn.drama].filter(Boolean);
    const CAT_KEY={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'drama'};
    const getActiveTab=()=> tabs.find(t=>t.classList.contains('active'))||btn.daily;
    const getActiveCatKey=()=> CAT_KEY[getActiveTab().id];
    function getProgress(){ const m=(progEl?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/); if(!m) return {i:1,total:1}; return {i:parseInt(m[1],10),total:parseInt(m[2],10)};}
    function subOrderOf(catKey){ const arr=(window.SORI_DATA&&window.SORI_DATA[catKey])||[]; const order=[]; for(const x of arr){const s=x?.sub||'Default'; if(!order.includes(s)) order.push(s);} return order;}
    const currentSubName=()=> (badgeEl?.textContent||'').trim();
    function goFirstItem(){ const {i}=getProgress(); for(let k=1;k<i;k++) btn.prev?.click(); setTimeout(()=>{ const again=getProgress().i; for(let k=1;k<again;k++) btn.prev?.click();},0);}
    function clickSubChipByName(name){ const chips=[...document.querySelectorAll('#subFilters .sub-chip')]; const t=chips.find(c=>(c.textContent||'').trim()===name)||chips.find(c=>(c.textContent||'').includes(name)); if(t) t.click();}
    function goFirstSubAndItem(){ setTimeout(()=>{ const first=document.querySelector('#subFilters .sub-chip'); if(first) first.click(); setTimeout(goFirstItem,0); },0); }
    btn.next?.addEventListener('click',function(e){ const {i,total}=getProgress(); if(i<total) return; e.preventDefault(); e.stopImmediatePropagation();
      const subs=subOrderOf(getActiveCatKey()); const cur=currentSubName(); const idx=Math.max(0,subs.indexOf(cur));
      if(idx>-1 && idx<subs.length-1){ clickSubChipByName(subs[idx+1]); setTimeout(goFirstItem,0); return; }
      const curTab=getActiveTab(); const tIdx=tabs.indexOf(curTab); const nextIdx=(tIdx+1)%tabs.length; tabs[nextIdx].click(); goFirstSubAndItem();
    },true);
    tabs.forEach(t=> t?.addEventListener('click',()=>{ goFirstSubAndItem(); }));
  })();
  </script>

  <!-- Analytics wiring -->
  <script>
  (function(){
    function buildPath(){
      const active=document.querySelector('.tab-button.active')?.id || 'dailyBtn';
      const catMap={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'kdrama',savedBtn:'saved'};
      const cat=catMap[active]||'daily';
      const sub=(badge?.textContent||'default').trim().replace(/\s+/g,'-').toLowerCase();
      const m=(prog?.textContent||'1 / 1').match(/(\d+)\s*\/\s*(\d+)/); const idx=m?parseInt(m[1],10):1;
      return `/${cat}/${sub}/${idx}`;
    }
    function sendPV(title){ try{ gtag('event','page_view',{page_title:title||document.title,page_location:location.href,page_path:buildPath(),send_to:'G-X1Q98DBKR5'});}catch(e){} }
    function sendSessionStart(){ try{ gtag('event','session_start',{send_to:'G-X1Q98DBKR5'});}catch(e){} }
    document.addEventListener('DOMContentLoaded',()=>{ setTimeout(()=>{ sendSessionStart(); sendPV('Sori'); },0); });
    ['dailyBtn','travelBtn','dramaBtn','savedBtnHidden'].forEach(id=>{ const el=document.getElementById(id); el&&el.addEventListener('click',()=> setTimeout(()=>sendPV(`Sori - ${el.textContent.trim()}`),0)); });
    const subFilters=document.getElementById('subFilters');
    subFilters&&subFilters.addEventListener('click',e=>{ const chip=e.target.closest('.sub-chip'); if(!chip) return; setTimeout(()=>sendPV(`Sori - ${chip.textContent.trim()}`),0); });
    nextBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Next'),0),true);
    prevBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Prev'),0),true);
    document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') setTimeout(()=>sendPV('Sori - resume'),0); });
    speed?.addEventListener('change',()=>{ gtag('event','change_speed',{value: speed.value, send_to:'G-X1Q98DBKR5'}); });
  })();
  </script>

  <!-- TTS patch (with onstart/onend so practice dots fill) -->
  <script>
  (function(){
    const ENDPOINT="https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
    let shared=new Audio(), last=null;
    const original=speechSynthesis.speak.bind(speechSynthesis);
    const isKo=(u)=> (u.lang||'').toLowerCase().startsWith('ko') || /[가-힣]/.test((u.text||'').trim());
    const safe=(fn,ev)=>{ try{ typeof fn==='function' && fn(ev);}catch(e){} };

    async function viaApi(u){
      try{ shared.pause(); }catch(_){}
      if(last){ try{ URL.revokeObjectURL(last);}catch(_){ } last=null; }
      const text=(u.text||'').trim(); if(!text) throw new Error('empty');

      const res=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      if(!res.ok) throw new Error('TTS '+res.status);
      const blob=await res.blob(); const url=URL.createObjectURL(blob); last=url; shared.src=url;

      safe(u.onstart,new Event('start'));
      shared.onended=()=>{ safe(u.onend,new Event('end')); try{ URL.revokeObjectURL(url);}catch(_){ } if(last===url) last=null; };
      shared.onerror=()=>{ safe(u.onerror,new Event('error')); };
      await shared.play();
    }

    speechSynthesis.speak=function(u){
      try{
        if(!isKo(u)) return original(u);
        viaApi(u).catch(err=>{ console.warn('[TTS API fail]',err); original(u); });
        return;
      }catch(e){ console.warn('[TTS patch error]',e); return original(u); }
    };
  })();
  </script>

  <!-- Layout fix: 위=영어 뜻, 아래=en=발음. 캐시로 재진입/왕복 시에도 안정 -->
  <script>
  (function(){
    const q=id=>document.getElementById(id);
    const quote=s=>`"${String(s||'').replace(/^"+|"+$/g,'').trim()}"`;
    const cache=new Map(); // key: korean text → {meaning, roman}

    function swap(){
      const ko=(q('korean')?.textContent||'').trim();
      const enEl=q('english'), prEl=q('pronunciation'), ctxEl=q('context');
      if(!ko || !enEl || !ctxEl) return;

      let meaning=(enEl.textContent||'').trim();
      const romanRaw=(prEl?.textContent||'').trim();

      // 캐시에 저장 (최초 진입 또는 의미/발음이 비어있지 않을 때)
      if(meaning || romanRaw){
        const prev=cache.get(ko)||{};
        cache.set(ko,{meaning:meaning||prev.meaning, roman:romanRaw||prev.roman});
      }
      const item=cache.get(ko)||{};

      // 적용
      if(item.meaning) ctxEl.textContent = quote(item.meaning);
      if(item.roman)   enEl.textContent  = item.roman;

      if(prEl) prEl.style.display='none';
    }

    document.addEventListener('DOMContentLoaded', swap);

    // #korean, #english, #pronunciation, #context 텍스트가 바뀌면 다시 스왑
    ['korean','english','pronunciation','context'].forEach(id=>{
      const node=q(id); if(!node) return;
      const mo=new MutationObserver(()=> requestAnimationFrame(swap));
      mo.observe(node,{childList:true,subtree:true,characterData:true});
    });

    // 주요 액션 후에도 1틱 보정
    ['nextBtn','prevBtn','dailyBtn','travelBtn','dramaBtn','savedBtnHidden','subFilters'].forEach(id=>{
      const el=document.getElementById(id);
      el && el.addEventListener('click',()=> setTimeout(swap,0), true);
    });
  })();
  </script>
</body>
</html>
