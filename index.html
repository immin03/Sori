<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sori - Learn Korean by Sound</title>
  <meta name="theme-color" content="#7c3aed"/>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="#7c3aed" stroke="#6d28d9" stroke-width="2"/>
      <text x="16" y="40" font-family="sans-serif" font-size="22" font-weight="bold" fill="white">소</text>
    </svg>'/>

  <!-- GA -->
  <script> window.GA_ID = 'G-X1Q98DBKR5'; </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', window.GA_ID, { send_page_view: false });
  </script>

  <!-- Firebase compat -->
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    *{ box-sizing:border-box }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      max-width:680px;margin:0 auto;padding:12px;background:#faf8ff;min-height:100vh
    }
    h1{font-size:24px;margin:0 0 4px;color:#7c3aed;font-weight:800}
    .intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

    /* header */
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-btn{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:0;cursor:pointer}
    .top-btn.primary{background:#7c3aed;color:#fff}

    /* cards/tabs */
    .card{background:#fff;border-radius:16px;padding:16px;margin:8px 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}

    /* === CATEGORY PICKER (dropdown-style, 3-rows viewport) === */
    .category-bar{display:flex;align-items:center;gap:12px}
    .picker-wrap{position:relative}
    .picker-trigger{
      padding:12px 18px;border-radius:14px;background:#7c3aed;color:#fff;
      font-weight:800;border:0;cursor:pointer;min-width:200px;text-align:center
    }
    .picker-menu{
      position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .2s ease;z-index:20
    }
    .picker-wrap:hover .picker-menu,
    .picker-wrap:focus-within .picker-menu{ max-height:156px; } /* 3 rows * (44 + margin) 근사치 */
    .picker-list{
      max-height:150px;overflow-y:auto;padding:6px;
      scrollbar-width:thin
    }
    .picker-item{
      height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;
      background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none
    }
    .picker-item:hover,.picker-item.active{background:#7c3aed;color:#fff}
    .saved-btn{
      height:44px;padding:0 16px;border-radius:12px;background:#ffffff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap
    }
    .saved-btn:hover{background:#f7f2ff}

    /* === Sub filters (chips) === */
    .sub-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .sub-chip{
      display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none
    }
    .sub-chip.active{ background:#7c3aed; border-color:#7c3aed; color:#fff; }

    /* badge / star */
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:10px}
    .icon-btn{border:none;background:transparent;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;line-height:1;color:#9ca3af;cursor:pointer;border-radius:8px}
    .icon-btn:hover{background:#f3f4f6}
    .icon-btn.active{color:#e11d48} /* red-pink */

    /* context as English meaning */
    .context{color:#6b7280;font-size:16px;text-align:center;margin:8px 0 0;font-weight:600}

    /* main text */
    .kbox{background:#f9fafb;border-radius:14px;padding:16px 12px;margin:12px 0;text-align:center}
    .ko{font-size:28px;font-weight:900;color:#1f2937;margin:0 0 6px}
    .en{color:#6b7280;font-size:16px;margin:0 0 10px;font-weight:600}
    .pr{color:#9ca3af;font-size:13px;font-style:italic;margin:0} /* 숨김 예정 */

    /* practice */
    .practice{background:#f9fafb;border-radius:10px;padding:10px}
    .practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
    .dots{display:flex;gap:6px;justify-content:center;margin-bottom:8px}
    .rep-dot{width:32px;height:32px;border-radius:50%;border:2px solid #e5e7eb;background:#fff}
    .rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

    /* buttons */
    button.big{width:100%;padding:12px 18px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff;box-shadow:0 2px 8px rgba(124,58,237,.2)}
    button.big:hover{background:#6d28d9}
    .error{display:none;background:#fee2e2;color:#991b1b;font-size:11px;font-weight:600;padding:8px 12px;border-radius:8px;margin-top:8px}

    .row{display:flex;align-items:center;justify-content:center;gap:8px;background:#f9fafb;border-radius:8px;padding:8px;margin-top:8px}
    .row label{color:#7c3aed;font-size:12px;font-weight:600}
    .row span{color:#7c3aed;font-size:12px;font-weight:700;min-width:42px;text-align:right}

    .nav{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .secondary{background:#f9fafb;color:#6b7280;border:0;padding:12px 18px;border-radius:14px;font-weight:800}
    .secondary:hover{background:#f3f4f6}
    .progress{text-align:center;color:#7c3aed;font-size:13px;font-weight:700;margin-top:8px}

    .cong{display:none;margin:8px 0;text-align:center;background:linear-gradient(135deg,#ffe4e6 0%,#fecdd3 100%);border-radius:10px;padding:12px}
    .cong.show{display:block}

    /* Tip box: pink theme */
    .tip-card{margin-top:10px;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
    .tip-text{font-size:12px;color:#9f1239;font-weight:600}

    /* 호환용 숨김 탭 (app.js 기존 의존성) */
    .hidden-tabs{display:none}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
      <div class="intro">Learn Korean naturally by repeating real sounds</div>
    </div>
    <div>
      <button id="loginBtn" class="top-btn primary">Login</button>
    </div>
  </header>

  <!-- CATEGORY -->
  <section class="card">
    <div class="category-bar">
      <div class="picker-wrap">
        <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox" aria-expanded="false">Daily</button>
        <div id="pickerMenu" class="picker-menu">
          <div class="picker-list" role="listbox">
            <div class="picker-item active" role="option">Daily</div>
            <div class="picker-item" role="option">Travel</div>
            <div class="picker-item" role="option">K-Drama</div>
          </div>
        </div>
      </div>
      <button id="savedBtn" class="saved-btn">★ Saved</button>
    </div>

    <!-- 호환용 숨김 탭 -->
    <div class="hidden-tabs" aria-hidden="true">
      <button id="dailyBtn"  class="tab-button active">Daily</button>
      <button id="travelBtn" class="tab-button">Travel</button>
      <button id="dramaBtn"  class="tab-button">K-Drama</button>
      <button id="savedBtnHidden" class="tab-button">Saved</button>
    </div>

    <!-- app.js가 여기에 .sub-chip 버튼들을 주입 -->
    <div id="subFilters" class="sub-filters"></div>
  </section>

  <!-- LESSON -->
  <section class="card">
    <div class="row-between">
      <div id="badge" class="badge">Greeting</div>
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save">☆</button>
    </div>

    <!-- 영어 뜻 표시 (따옴표 포함) -->
    <div id="context" class="context">"Hello"</div>

    <div class="kbox">
      <p id="korean" class="ko">안녕하세요.</p>
      <p id="english" class="en">annyeonghaseyo</p>
      <p id="pronunciation" class="pr" style="display:none">annyeonghaseyo</p>
    </div>

    <div class="practice">
      <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
      <div class="dots">
        <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
      </div>
    </div>

    <div id="congrats" class="cong">Great job!</div>

    <button id="playBtn" class="big">Listen & Repeat</button>
    <div id="errorMsg" class="error"></div>

    <div class="row">
      <label for="speed">Speed:</label>
      <input id="speed" type="range" min="0.3" max="1.0" step="0.1" value="0.75" />
      <span id="speedTxt">0.75x</span>
    </div>

    <!-- Tip -->
    <div id="tipBox" class="tip-card">
      <div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div>
    </div>
  </section>

  <!-- NAV -->
  <section class="card">
    <div class="nav">
      <button id="prevBtn" class="secondary">◀ Previous</button>
      <button id="nextBtn" class="secondary">▶ Next</button>
    </div>
    <div id="prog" class="progress">1 / 30</div>
  </section>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth hidden">
    <div class="auth-card">
      <button id="authClose" class="auth-close" aria-label="Close">×</button>
      <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
      <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
      <button class="gbtn" onclick="window.handleGoogleLogin && window.handleGoogleLogin()">Continue with Google</button>
    </div>
  </div>

  <!-- DATA -->
  <script defer src="data/daily.js?v=20251017"></script>
  <script defer src="data/travel.js?v=20251017"></script>
  <script defer src="data/drama.js?v=20251017"></script>
  <script defer src="data/dataindex.js?v=20251017"></script>

  <!-- APP SCRIPTS -->
  <script defer src="js/state.js?v=20251017"></script>
  <script defer src="js/tts.js?v=20251017"></script>
  <script defer src="js/app.js?v=20251017"></script>

  <!-- Header auth wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('authModal');
      const loginBtn = document.getElementById('loginBtn');

      loginBtn?.addEventListener('click', async () => {
        try {
          const u = (window.firebase?.auth && firebase.auth().currentUser) || null;
          if (u && window.SoriUser?.logout) {
            await window.SoriUser.logout();
          } else {
            modal?.classList.remove('hidden');
          }
        } catch (e) { console.warn(e); }
      });

      document.getElementById('authClose')?.addEventListener('click', () => {
        modal?.classList.add('hidden');
      });
    });
  </script>

  <!-- Picker logic + legacy compatibility + Tip on category change -->
  <script>
    (function(){
      // 3개 고정
      const CATEGORIES = ["Daily","Travel","K-Drama"];

      // 숨김 레거시 탭 (app.js 연동)
      const legacy = {
        daily:  document.getElementById('dailyBtn'),
        travel: document.getElementById('travelBtn'),
        drama:  document.getElementById('dramaBtn')
      };

      const trigger = document.getElementById('pickerTrigger');
      const menu    = document.getElementById('pickerMenu');
      const list    = menu.querySelector('.picker-list');

      // 초기 렌더(안전하게 다시 세팅)
      list.innerHTML = '';
      CATEGORIES.forEach((c,i)=>{
        const el = document.createElement('div');
        el.className = 'picker-item' + (i===0?' active':'');
        el.textContent = c;
        el.setAttribute('role','option');
        el.addEventListener('click', ()=> selectCategory(c, el));
        list.appendChild(el);
      });

      function setActive(el){
        list.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
      }

      function selectCategory(name, el){
        setActive(el);
        trigger.textContent = name;
        trigger.setAttribute('aria-expanded','false');
        menu.style.maxHeight = '0';

        // 레거시 탭 가상 클릭(서브칩/컨텐츠 렌더를 기존 로직대로)
        const key = name.toLowerCase();
        if(key==='daily')  legacy.daily?.click();
        if(key==='travel') legacy.travel?.click();
        if(key==='k-drama' || key==='kdrama' || key==='drama') legacy.drama?.click();

        // 카테고리 전환시에만 Tip 변경
        changeTip();
      }

      trigger.addEventListener('click', ()=>{
        const expanded = trigger.getAttribute('aria-expanded') === 'true';
        trigger.setAttribute('aria-expanded', String(!expanded));
        // CSS가 열고 닫는 건 hover/focus가 담당, 클릭은 접근성 보조
      });

      // Saved 버튼 → 기존 saved 동작 유지
      document.getElementById('savedBtn')?.addEventListener('click', () => {
        const savedHidden = document.getElementById('savedBtnHidden');
        savedHidden && savedHidden.click();
      });

      // ===== Tip (카테고리 전환시에만 랜덤 교체) =====
      const tips = [
        "Tip: Small daily reps beat big, rare sessions.",
        "Tip: Shadow the sound, not the spelling.",
        "Tip: Say it out loud — your mouth must learn too.",
        "Tip: Five clean repeats > twenty sloppy ones.",
        "Tip: Record yourself and match the rhythm.",
        "Tip: First mimic, then understand.",
        "Tip: Keep the same speed; build consistency.",
        "Tip: Close your eyes and copy the melody.",
        "Tip: Bite-sized goals. One phrase at a time.",
        "Tip: Revisit yesterday — retention makes speed."
      ];
      const tipEl = document.getElementById('tipText');
      function changeTip(){
        if(!tipEl) return;
        tipEl.textContent = tips[Math.floor(Math.random()*tips.length)];
      }

      // 최초 진입은 Daily로 맞추고 Tip 한 번만 세팅
      changeTip();
    })();
  </script>

  <!-- Navigation rewrite (기존 코드 유지) -->
  <script>
  (function(){
    const btn = {
      next: document.getElementById('nextBtn'),
      prev: document.getElementById('prevBtn'),
      daily: document.getElementById('dailyBtn'),
      travel: document.getElementById('travelBtn'),
      drama: document.getElementById('dramaBtn'),
    };
    const progEl  = document.getElementById('prog');
    const badgeEl = document.getElementById('badge');
    const tabs = [btn.daily, btn.travel, btn.drama].filter(Boolean);

    const CAT_KEY = { dailyBtn:'daily', travelBtn:'travel', dramaBtn:'drama' };

    function getActiveTab(){ return tabs.find(t => t.classList.contains('active')) || btn.daily; }
    function getActiveCatKey(){ return CAT_KEY[getActiveTab().id]; }

    function getProgress(){
      const m = (progEl?.textContent || '').match(/(\d+)\s*\/\s*(\d+)/);
      if(!m) return {i:1,total:1};
      return { i: parseInt(m[1],10), total: parseInt(m[2],10) };
    }

    function subOrderOf(catKey){
      const arr = (window.SORI_DATA && window.SORI_DATA[catKey]) || [];
      const order = [];
      for(const x of arr){
        const s = x?.sub || 'Default';
        if(!order.includes(s)) order.push(s);
      }
      return order;
    }

    function currentSubName(){ return (badgeEl?.textContent || '').trim(); }

    function goFirstItem(){
      const {i} = getProgress();
      for(let k=1; k<i; k++) btn.prev?.click();
      setTimeout(()=>{
        const again = getProgress().i;
        for(let k=1; k<again; k++) btn.prev?.click();
      }, 0);
    }

    function clickSubChipByName(name){
      const chips = Array.from(document.querySelectorAll('#subFilters .sub-chip'));
      const target = chips.find(c => (c.textContent || '').trim() === name)
               || chips.find(c => (c.textContent || '').includes(name));
      if(target) target.click();
    }

    function goFirstSubAndItem(){
      setTimeout(()=>{
        const firstChip = document.querySelector('#subFilters .sub-chip');
        if(firstChip) firstChip.click();
        setTimeout(goFirstItem, 0);
      }, 0);
    }

    btn.next?.addEventListener('click', function onNext(e){
      const {i, total} = getProgress();
      if(i < total) return;

      e.preventDefault();
      e.stopImmediatePropagation();

      const catKey = getActiveCatKey();
      const subs = subOrderOf(catKey);
      const curSub = currentSubName();
      const curSubIdx = Math.max(0, subs.indexOf(curSub));

      if(curSubIdx > -1 && curSubIdx < subs.length - 1){
        const nextSubName = subs[curSubIdx + 1];
        clickSubChipByName(nextSubName);
        setTimeout(goFirstItem, 0);
        return;
      }

      const curTab = getActiveTab();
      const idx = tabs.indexOf(curTab);
      const nextIdx = (idx + 1) % tabs.length;
      tabs[nextIdx].click();
      goFirstSubAndItem();
    }, true);

    tabs.forEach(t=>{
      t?.addEventListener('click', ()=>{ goFirstSubAndItem(); });
    });
  })();
  </script>

  <!-- Analytics wiring -->
  <script>
  (function(){
    function buildPath(){
      const activeTab = document.querySelector('.tab-button.active')?.id || 'dailyBtn';
      const catMap = { dailyBtn:'daily', travelBtn:'travel', dramaBtn:'kdrama', savedBtn:'saved' };
      const cat = catMap[activeTab] || 'daily';

      const sub = (document.getElementById('badge')?.textContent || 'default')
        .trim().replace(/\s+/g,'-').toLowerCase();

      const progText = document.getElementById('prog')?.textContent || '1 / 1';
      const m = progText.match(/(\d+)\s*\/\s*(\d+)/);
      const idx = m ? parseInt(m[1],10) : 1;

      return `/${cat}/${sub}/${idx}`;
    }

    function sendPV(title){
      try{
        const path = buildPath();
        gtag('event', 'page_view', {
          page_title: title || document.title,
          page_location: location.href,
          page_path: path,
          send_to: 'G-X1Q98DBKR5'
        });
      }catch(e){}
    }

    function sendSessionStart(){ try{ gtag('event', 'session_start', { send_to: 'G-X1Q98DBKR5' }); }catch(e){} }

    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(()=> { sendSessionStart(); sendPV('Sori'); }, 0);
    });

    ['dailyBtn','travelBtn','dramaBtn','savedBtnHidden'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', ()=> { setTimeout(()=> sendPV(`Sori - ${el.textContent.trim()}`), 0); });
    });

    const subFilters = document.getElementById('subFilters');
    if(subFilters){
      subFilters.addEventListener('click', (e)=>{
        const chip = e.target.closest('.sub-chip');
        if(!chip) return;
        setTimeout(()=> sendPV(`Sori - ${chip.textContent.trim()}`), 0);
      });
    }

    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    nextBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Next'), 0), true);
    prevBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Prev'), 0), true);

    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){
        setTimeout(()=> sendPV('Sori - resume'), 0);
      }
    });

    const speed = document.getElementById('speed');
    speed?.addEventListener('change', ()=>{
      gtag('event', 'change_speed', { value: speed.value, send_to: 'G-X1Q98DBKR5' });
    });
  })();
  </script>

  <!-- TTS patch -->
  <script>
  (function(){
    const ENDPOINT = "https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
    let sharedAudio = new Audio();
    let lastUrl = null;
    const originalSpeak = speechSynthesis.speak.bind(speechSynthesis);
    function isKorean(utter){ const lang=(utter.lang||"").toLowerCase(); const text=(utter.text||"").trim(); return (lang.startsWith("ko")||/[가-힣]/.test(text)); }
    function safeCall(fn,arg){ try{ typeof fn==="function" && fn(arg); }catch(e){ console.warn(e); } }
    async function playViaApi(utter){
      try{ sharedAudio.pause(); }catch(_){}
      if(lastUrl){ try{ URL.revokeObjectURL(lastUrl); }catch(_){} lastUrl=null; }
      const text=(utter.text||"").trim(); if(!text) throw new Error("empty text");
      const res=await fetch(ENDPOINT,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({ text })});
      if(!res.ok) throw new Error("TTS HTTP "+res.status);
      const blob=await res.blob();
      const url=URL.createObjectURL(blob); lastUrl=url; sharedAudio.src=url;
      safeCall(utter.onstart,new Event("start"));
      sharedAudio.onended=()=>{ safeCall(utter.onend,new Event("end")); try{ URL.revokeObjectURL(url); }catch(_){} if(lastUrl===url) lastUrl=null; };
      sharedAudio.onerror=()=>{ safeCall(utter.onerror,new Event("error")); };
      await sharedAudio.play();
    }
    speechSynthesis.speak=function(utter){
      try{
        if(!isKorean(utter)) return originalSpeak(utter);
        playViaApi(utter).catch(err=>{ console.warn("[Sori TTS] API failed, fallback:", err); originalSpeak(utter); });
        return;
      }catch(e){ console.warn("[Sori TTS] patch error, fallback:", e); return originalSpeak(utter); }
    };
    window.SoriTTSApi={ useWebSpeechOnce(utter){ originalSpeak(utter); } };
  })();
  </script>

  <!-- Layout fix: keep context as English, en as pronunciation; DO NOT rotate tips here -->
  <script>
    (function(){
      function applyLayoutOnce(){
        const ctx = document.getElementById('context');
        const en  = document.getElementById('english');
        const pr  = document.getElementById('pronunciation');
        if(!ctx || !en) return;

        // ctx = 영어 뜻 (따옴표 유지)
        // en  = 발음
        if(pr){ pr.style.display='none'; }
      }

      document.addEventListener('DOMContentLoaded', applyLayoutOnce);

      // Next/Prev/서브 전환 시에도 영어/발음 구조 깨지지 않도록 보정
      const mo = new MutationObserver(()=>{
        clearTimeout(window.__soriFixTimer);
        window.__soriFixTimer = setTimeout(applyLayoutOnce, 30);
      });
      mo.observe(document.body, { childList:true, subtree:true, characterData:true });

      ['nextBtn','prevBtn','dailyBtn','travelBtn','dramaBtn','savedBtnHidden'].forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('click', ()=> setTimeout(applyLayoutOnce, 0), true);
      });
    })();
  </script>
</body>
</html>
