<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sori - Learn Korean</title>

  <!-- head -->
<script>
  window.GA_ID = 'G-X1Q98DBKR5';           /* << Ìïú Í≥≥ÏóêÏÑú Í¥ÄÎ¶¨ */
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', window.GA_ID, { send_page_view: false });
</script>




  <!-- Firebase compat (state.jsÍ∞Ä compat Í∏∞Ï§Ä) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    *{ box-sizing:border-box }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      max-width:680px;margin:0 auto;padding:12px;background:#faf8ff;min-height:100vh
    }
    h1{font-size:24px;margin:0 0 4px;color:#7c3aed;font-weight:800}
    .intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

    /* header */
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-btn{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:700;border:0;cursor:pointer}
    .top-btn.primary{background:#7c3aed;color:#fff}

    /* cards/tabs */
    .card{background:#fff;border-radius:16px;padding:16px;margin:8px 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .category-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
    .tab-button{padding:10px 14px;border:2px solid #f3f4f6;border-radius:14px;background:#f9fafb;color:#9ca3af;font-size:13px;font-weight:700;cursor:pointer;transition:.2s}
    .tab-button:hover{background:#f3f4f6}
    .tab-button.active{background:#7c3aed;color:#fff;border-color:#7c3aed;box-shadow:0 2px 8px rgba(124,58,237,.2)}

    /* === Sub filters (chips) === */
    .sub-filters{
      display:none;             /* Í∏∞Î≥∏ÏùÄ Ïà®ÍπÄ, app.jsÏóêÏÑú ÌïÑÏöî Ïãú ÌëúÏãú */
      margin-top:8px;
      padding:8px;
      background:#f9fafb;
      border-radius:10px;
      gap:8px;
      flex-wrap:wrap;
    }
    .sub-chip{
      display:inline-flex;      /* ÏïÑÏù¥ÏΩò-ÌÖçÏä§Ìä∏ Ìïú Ï§Ñ Ï†ïÎ†¨ */
      align-items:center;       /* ÏàòÏßÅ ÏÑºÌÑ∞ */
      gap:6px;
      padding:6px 12px;
      border-radius:14px;
      background:#fff;
      border:2px solid #e5e7eb;
      color:#374151;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      line-height:1;            /* ÏïÑÏù¥ÏΩò Îì§Ïç©ÏûÑ Î∞©ÏßÄ */
      transition:background .15s, border-color .15s, color .15s;
    }
    .sub-chip:hover{ background:#f3f4f6; }
    .sub-chip.active{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    .sub-chip .sub-icon{
      font-size:14px;           /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ ÌÜµÏùº */
      line-height:1;
      transform: translateY(0.5px); /* ÎØ∏ÏÑ∏ Î≥¥Ï†ï */
    }
    .sub-chip .sub-label{ line-height:1; }

    /* badge / star */
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:10px}
    .icon-btn{border:none;background:transparent;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;line-height:1;color:#9ca3af;cursor:pointer;border-radius:8px}
    .icon-btn:hover{background:#f3f4f6}
    .icon-btn.active{color:#d97706}

    .context{background:#f9fafb;border-radius:8px;padding:6px 10px;margin-top:8px;color:#6b7280;font-size:12px;font-weight:600}

    /* main text */
    .kbox{background:#f9fafb;border-radius:14px;padding:16px 12px;margin:12px 0}
    .ko{font-size:28px;font-weight:900;color:#1f2937;text-align:center;margin:0 0 6px}
    .en{color:#6b7280;font-size:16px;text-align:center;margin:0 0 10px;font-weight:600}
    .pr{color:#9ca3af;font-size:13px;font-style:italic;text-align:center;margin:0}

    /* practice */
    .practice{background:#f9fafb;border-radius:10px;padding:10px}
    .practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
    .dots{display:flex;gap:6px;justify-content:center;margin-bottom:8px}
    .rep-dot{width:32px;height:32px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center}
    .rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

    /* buttons */
    button.big{width:100%;padding:12px 18px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff;box-shadow:0 2px 8px rgba(124,58,237,.2)}
    button.big:hover{background:#6d28d9}
    .error{display:none;background:#fee2e2;color:#991b1b;font-size:11px;font-weight:600;padding:8px 12px;border-radius:8px;margin-top:8px}

    .row{display:flex;align-items:center;justify-content:center;gap:8px;background:#f9fafb;border-radius:8px;padding:8px;margin-top:8px}
    .row label{color:#7c3aed;font-size:12px;font-weight:600}
    .row span{color:#7c3aed;font-size:12px;font-weight:700;min-width:42px;text-align:right}

    .nav{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .secondary{background:#f9fafb;color:#6b7280;border:0;padding:12px 18px;border-radius:14px;font-weight:800}
    .secondary:hover{background:#f3f4f6}
    .progress{text-align:center;color:#7c3aed;font-size:13px;font-weight:700;margin-top:8px}

    .cong{display:none;margin:8px 0;text-align:center;background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);border-radius:10px;padding:12px}
    .cong.show{display:block}

    /* auth modal */
    .auth{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:9999;padding:16px}
    .auth:not(.hidden){display:flex}
    .auth-card{background:#fff;width:100%;max-width:360px;border-radius:18px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
    .auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}

    @media (max-width:640px){ .category-tabs{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div>
      <h1>Sori <span style="font-size:14px;color:#9ca3af;font-weight:600;">(beta)</span></h1>
      <div class="intro">Master Korean with K-Drama lines and daily conversations</div>
    </div>
    <div>
      <button id="loginBtn" class="top-btn primary">Login</button>
    </div>
  </header>

  <!-- TABS -->
  <section class="card">
    <div class="category-tabs" role="tablist" aria-label="Categories">
      <button id="dailyBtn"  class="tab-button active" role="tab" aria-selected="true">Daily</button>
      <button id="travelBtn" class="tab-button" role="tab" aria-selected="false">Travel</button>
      <button id="dramaBtn"  class="tab-button" role="tab" aria-selected="false">K-Drama</button>
      <button id="savedBtn"  class="tab-button" role="tab" aria-selected="false">‚òÖ Saved</button>
    </div>
    <!-- app.jsÍ∞Ä Ïó¨Í∏∞Ïóê .sub-chip Î≤ÑÌäºÎì§ÏùÑ Ï£ºÏûÖ -->
    <div id="subFilters" class="sub-filters"></div>
  </section>

  <!-- LESSON -->
  <section class="card">
    <div class="row-between">
      <div id="badge" class="badge">Greeting</div>
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save">‚òÜ</button>
    </div>

    <div id="context" class="context">Conversation: First meeting</div>

    <div class="kbox">
      <p id="korean" class="ko">ÏïàÎÖïÌïòÏÑ∏Ïöî.</p>
      <p id="english" class="en">"Hello"</p>
      <p id="pronunciation" class="pr">annyeonghaseyo</p>
    </div>

    <div class="practice">
      <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
      <div class="dots">
        <div class="rep-dot"></div>
        <div class="rep-dot"></div>
        <div class="rep-dot"></div>
        <div class="rep-dot"></div>
        <div class="rep-dot"></div>
      </div>
    </div>

    <div id="congrats" class="cong">üéâ Great job!</div>

    <button id="playBtn" class="big">Listen & Repeat</button>
    <div id="errorMsg" class="error"></div>

    <div class="row">
      <label for="speed">Speed:</label>
      <input id="speed" type="range" min="0.3" max="1.0" step="0.1" value="0.75" />
      <span id="speedTxt">0.75x</span>
    </div>

    <div class="card" style="margin-top:10px; background:#fffbeb; border-left:3px solid #f59e0b;">
      <div style="font-size:12px; color:#92400e; font-weight:500;">
        Tip: Listen carefully and repeat multiple times. Consistency is key.
      </div>
    </div>
  </section>

  <!-- NAV -->
  <section class="card">
    <div class="nav">
      <button id="prevBtn" class="secondary">‚óÄ Previous</button>
      <button id="nextBtn" class="secondary">‚ñ∂ Next</button>
    </div>
    <div id="prog" class="progress">1 / 30</div>
  </section>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth hidden">
    <div class="auth-card">
      <button id="authClose" class="auth-close" aria-label="Close">√ó</button>
      <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
      <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
      <button class="gbtn" onclick="window.handleGoogleLogin && window.handleGoogleLogin()">Continue with Google</button>
    </div>
  </div>

  <!-- DATA (Î¨¥Ï°∞Í±¥ Ïï± Î°úÏßÅÎ≥¥Îã§ Î®ºÏ†Ä) -->
  <script defer src="data/daily.js?v=20251017"></script>
  <script defer src="data/travel.js?v=20251017"></script>
  <script defer src="data/drama.js?v=20251017"></script>
  <script defer src="data/dataindex.js?v=20251017"></script>

  <!-- APP SCRIPTS (ÏàúÏÑú Ï§ëÏöî: state -> tts -> app) -->
  <script defer src="js/state.js?v=20251017"></script>
  <script defer src="js/tts.js?v=20251017"></script>
  <script defer src="js/app.js?v=20251017"></script>

  <!-- Ìó§Îçî: Î°úÍ∑∏Ïù∏/Î™®Îã¨Îßå -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('authModal');
      const loginBtn = document.getElementById('loginBtn');

      loginBtn?.addEventListener('click', async () => {
        try {
          const u = (window.firebase?.auth && firebase.auth().currentUser) || null;
          if (u && window.SoriUser?.logout) {
            await window.SoriUser.logout();
          } else {
            modal?.classList.remove('hidden');
          }
        } catch (e) { console.warn(e); }
      });

      document.getElementById('authClose')?.addEventListener('click', () => {
        modal?.classList.add('hidden');
      });
    });
  </script>

 <script>
/* ===== Sori Navigation Rewrite: items ‚Üí sub ‚Üí category ===== */
(function(){
  const btn = {
    next: document.getElementById('nextBtn'),
    prev: document.getElementById('prevBtn'),
    daily: document.getElementById('dailyBtn'),
    travel: document.getElementById('travelBtn'),
    drama: document.getElementById('dramaBtn'),
  };
  const progEl  = document.getElementById('prog');
  const badgeEl = document.getElementById('badge');     // ÏÑúÎ∏åÏπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ ÌëúÏãú(Greeting Îì±)
  const tabs = [btn.daily, btn.travel, btn.drama].filter(Boolean);

  // ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨ id ‚Üí SORI_DATA ÌÇ§ Îß§Ìïë
  const CAT_KEY = {
    dailyBtn:  'daily',
    travelBtn: 'travel',
    dramaBtn:  'drama'
  };

  function getActiveTab(){
    return tabs.find(t => t.classList.contains('active')) || btn.daily;
  }
  function getActiveCatKey(){
    const tab = getActiveTab();
    return CAT_KEY[tab.id];
  }

  function getProgress(){
    // "3 / 5" ‚Üí {i:3,total:5}
    const m = (progEl?.textContent || '').match(/(\d+)\s*\/\s*(\d+)/);
    if(!m) return {i:1,total:1};
    return { i: parseInt(m[1],10), total: parseInt(m[2],10) };
  }

  // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÏÑúÎ∏åÏπ¥ÌÖåÍ≥†Î¶¨ ÏàúÏÑúÎ•º Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏÇ∞Ï∂ú
  function subOrderOf(catKey){
    const arr = (window.SORI_DATA && window.SORI_DATA[catKey]) || [];
    const order = [];
    for(const x of arr){
      const s = x?.sub || 'Default';
      if(!order.includes(s)) order.push(s);
    }
    return order;
  }

  // ÌòÑÏû¨ ÌôîÎ©¥Ïùò ÏÑúÎ∏åÏπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ
  function currentSubName(){
    return (badgeEl?.textContent || '').trim();
  }

  // Î†åÎçî ÌõÑ Ï≤´ ÏïÑÏù¥ÌÖúÏúºÎ°ú Ïù¥ÎèôÌïòÎäî Î≥¥Ï†ï
  function goFirstItem(){
    // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ iÎ•º ÏùΩÏñ¥ i>1Ïù¥Î©¥ prevÎ•º i-1Î≤à ÎàåÎü¨ 1/Î°ú ÎßûÏ∂òÎã§
    const {i} = getProgress();
    for(let k=1; k<i; k++) btn.prev?.click();
    // Î†åÎçî ÌÉÄÏù¥Î∞ç Î≥¥Ï†ï
    setTimeout(()=>{
      const again = getProgress().i;
      for(let k=1; k<again; k++) btn.prev?.click();
    }, 0);
  }

  // ÏÑúÎ∏åÏπ© ÌÅ¥Î¶≠ Ïú†Ìã∏
  function clickSubChipByName(name){
    const chips = Array.from(document.querySelectorAll('#subFilters .sub-chip'));
    const target = chips.find(c => (c.textContent || '').trim() === name)
                || chips.find(c => (c.textContent || '').includes(name));
    if(target) target.click();
  }

  // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò "Ï≤´ ÏÑúÎ∏åÏπ© ‚Üí Ï≤´ ÏïÑÏù¥ÌÖú"ÏúºÎ°ú Ïù¥Îèô
  function goFirstSubAndItem(){
    // ÏÑúÎ∏åÏπ©Ïù¥ Î†åÎçîÎêòÍ∏∞ ÏßÅÌõÑÎ•º Í≥†Î†§Ìï¥ Îëê Îã®Í≥ÑÎ°ú Î≥¥Ï†ï
    setTimeout(()=>{
      const firstChip = document.querySelector('#subFilters .sub-chip');
      if(firstChip) firstChip.click();
      setTimeout(goFirstItem, 0);
    }, 0);
  }

  // 1) Next Î≤ÑÌäº Ïû¨Ï†ïÏùò: ÏïÑÏù¥ÌÖú ÎÅù ‚Üí Îã§Ïùå ÏÑúÎ∏å ‚Üí Îã§Ïùå Ïπ¥ÌÖåÍ≥†Î¶¨
  btn.next?.addEventListener('click', function onNext(e){
    const {i, total} = getProgress();
    if(i < total) return; // ÏïÑÏßÅ ÏÑúÎ∏å ÎÇ¥ ÏïÑÏù¥ÌÖú ÎÇ®ÏïÑÏûàÏúºÎ©¥ Í∏∞Î≥∏ ÎèôÏûë

    // Ïó¨Í∏∞ ÎèÑÎã¨ÌïòÎ©¥ "ÏÑúÎ∏åÏùò ÎßàÏßÄÎßâ ÏïÑÏù¥ÌÖú" ÏÉÅÌÉú
    e.preventDefault();
    e.stopImmediatePropagation();

    const catKey = getActiveCatKey();
    const subs = subOrderOf(catKey);
    const curSub = currentSubName();
    const curSubIdx = Math.max(0, subs.indexOf(curSub));

    // Îã§Ïùå ÏÑúÎ∏åÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í±∏Î°ú
    if(curSubIdx > -1 && curSubIdx < subs.length - 1){
      const nextSubName = subs[curSubIdx + 1];
      clickSubChipByName(nextSubName);
      setTimeout(goFirstItem, 0);
      return;
    }

    // ÏÑúÎ∏åÎèÑ ÎßàÏßÄÎßâÏù¥Î©¥ Îã§Ïùå ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú
    const curTab = getActiveTab();
    const idx = tabs.indexOf(curTab);
    const nextIdx = (idx + 1) % tabs.length;
    tabs[nextIdx].click();
    // ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ÏóêÏÑú Ï≤´ ÏÑúÎ∏åÏùò Ï≤´ ÏïÑÏù¥ÌÖú
    goFirstSubAndItem();
  }, true); // captureÎ°ú Îì±Î°ùÌï¥ Í∏∞Ï°¥ Ìï∏Îì§Îü¨Î≥¥Îã§ Ïö∞ÏÑ†

  // 2) ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÉ≠ÏùÑ ÏßÅÏ†ë ÎàåÎü¨ÎèÑ Ìï≠ÏÉÅ Ï≤´ ÏÑúÎ∏å 1/Î∂ÄÌÑ∞
  tabs.forEach(t=>{
    t?.addEventListener('click', ()=>{
      goFirstSubAndItem();
    });
  });

})();
</script>

<script>
(function(){
  // --------- Helpers ----------
  function buildPath(){
    const activeTab = document.querySelector('.tab-button.active')?.id || 'dailyBtn';
    const catMap = { dailyBtn:'daily', travelBtn:'travel', dramaBtn:'kdrama', savedBtn:'saved' };
    const cat = catMap[activeTab] || 'daily';

    const sub = (document.getElementById('badge')?.textContent || 'default')
      .trim().replace(/\s+/g,'-').toLowerCase();

    const progText = document.getElementById('prog')?.textContent || '1 / 1';
    const m = progText.match(/(\d+)\s*\/\s*(\d+)/);
    const idx = m ? parseInt(m[1],10) : 1;

    return `/${cat}/${sub}/${idx}`;
  }

  function sendPV(title){
    try{
      const path = buildPath();
      gtag('event', 'page_view', {
        page_title: title || document.title,
        page_location: location.href,
        page_path: path,
        send_to: 'G-X1Q98DBKR5'
      });
      // console.log('[GA] page_view', path);
    }catch(e){}
  }

  // Í∂åÏû•: ÏÑ∏ÏÖò ÏãúÏûë Ïù¥Î≤§Ìä∏(Ï¥àÍ∏∞ 1Ìöå)
  function sendSessionStart(){
    try{
      gtag('event', 'session_start', { send_to: 'G-X1Q98DBKR5' });
    }catch(e){}
  }

  // --------- Wiring ----------
  // ÏµúÏ¥à ÏßÑÏûÖ: session_start + page_view (Î†åÎçî ÏôÑÎ£å ÌõÑ Ìïú Ìã± ÏßÄÏó∞)
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(()=> {
      sendSessionStart();
      sendPV('Sori');
    }, 0);
  });

  // ÌÉ≠ Ï†ÑÌôò
  ['dailyBtn','travelBtn','dramaBtn','savedBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('click', ()=> {
      setTimeout(()=> sendPV(`Sori - ${el.textContent.trim()}`), 0);
    });
  });

  // ÏÑúÎ∏åÏπ© Ï†ÑÌôò
  const subFilters = document.getElementById('subFilters');
  if(subFilters){
    subFilters.addEventListener('click', (e)=>{
      const chip = e.target.closest('.sub-chip');
      if(!chip) return;
      setTimeout(()=> sendPV(`Sori - ${chip.textContent.trim()}`), 0);
    });
  }

  // Next / Prev
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  nextBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Next'), 0), true);
  prevBtn?.addEventListener('click', ()=> setTimeout(()=> sendPV('Sori - Prev'), 0), true);

  // (ÏÑ†ÌÉù) Ìè¨Ïª§Ïä§ Î≥µÍ∑Ä ÏãúÎèÑ Ïãú Ìïú Î≤à Îçî page_view
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState === 'visible'){
      setTimeout(()=> sendPV('Sori - resume'), 0);
    }
  });

  // ÏÜçÎèÑ Î≥ÄÍ≤Ω ÏòàÏãú(Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏)
  const speed = document.getElementById('speed');
  speed?.addEventListener('change', ()=>{
    gtag('event', 'change_speed', { value: speed.value, send_to: 'G-X1Q98DBKR5' });
  });
})();
</script>

<script>
/* Sori WebSpeech Enhancer (no data/HTML changes)
   - iOS/Android ÌïúÍµ≠Ïñ¥ Ïó¨ÏÑ± Î≥¥Ïù¥Ïä§ ÏûêÎèô ÏÑ†ÌÉù
   - ÏßàÎ¨∏ ÏñµÏñëÏù¥Î©¥ pitch ÏÇ¥Ïßù ‚Üë
   - #speed Ïä¨ÎùºÏù¥Îçî Í∞í Ïó∞Îèô
   - Í∏∞Ï°¥ Ìï∏Îì§Îü¨/ÏΩòÌÖêÏ∏†/Îç∞Ïù¥ÌÑ∞Îäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
*/

(function(){
  let SELECTED_VOICE = null;

  // ÌîåÎû´Ìèº Í∞êÏßÄ(Í∞ÑÎã®)
  const UA = navigator.userAgent || "";
  const IS_APPLE = /iPhone|iPad|iPod|Macintosh/.test(UA);
  const IS_ANDROID = /Android/.test(UA);

  // Î≥¥Ïù¥Ïä§ Î°úÎî© ÎåÄÍ∏∞(iOS Ï≤´ Î°úÎìú Îπà Î∞∞Ïó¥ ÎåÄÏùë)
  function loadVoicesReady() {
    return new Promise(resolve => {
      const list = speechSynthesis.getVoices();
      if (list && list.length) return resolve(list);
      let done = false;
      speechSynthesis.onvoiceschanged = () => {
        if (done) return;
        done = true;
        resolve(speechSynthesis.getVoices());
      };
      // tick
      try { speechSynthesis.cancel(); } catch(_) {}
      setTimeout(() => {
        if (done) return;
        done = true;
        resolve(speechSynthesis.getVoices());
      }, 800);
    });
  }

  // ÌïúÍµ≠Ïñ¥ Ïó¨ÏÑ± Î≥¥Ïù¥Ïä§ Ï∂îÏ†ï ÏÑ†ÌÉù
  function pickBestKoreanVoice(voices) {
    const ko = voices.filter(v => (v.lang||"").toLowerCase().startsWith("ko"));
    const pool = ko.length ? ko : voices;
    const bankApple = ["yuna","kyung","eun","seoyeon","narae"];
    const bankAndroid = ["wavenet","standard","female","woman","google","ko-kr"];
    const bankCommon = ["female","woman","yuna","seoyeon","wavenet","standard"];
    const bank = IS_APPLE ? bankApple : (IS_ANDROID ? bankAndroid : bankCommon);

    function score(v){
      const name = (v.name||"").toLowerCase();
      let s = 0;
      if ((v.lang||"").toLowerCase().startsWith("ko")) s += 10;
      if (/female|woman|Ïó¨ÏÑ±/.test(name)) s += 3;
      bank.forEach((p,i)=>{ if (name.includes(p)) s += (bank.length - i); });
      return s;
    }
    return (pool.sort((a,b)=>score(b)-score(a))[0]) || null;
  }

  // ÏßàÎ¨∏ ÏñµÏñë ÌåêÎã®
  function isQuestionTone(text){
    const t = (text||"").trim();
    return /[?Ôºü]$/.test(t) || /(ÎÇòÏöî|ÍπåÏöî|ÏúºÏÑ∏Ïöî|ÏóêÏöî|ÏòàÏöî)\s*$/.test(t);
  }

  // ÏÜçÎèÑ Ïä¨ÎùºÏù¥Îçî(#speed) ‚Üí rate
  function getDesiredRate(defaultRate=0.98){
    try {
      const el = document.getElementById('speed');
      if (!el) return defaultRate;
      const v = parseFloat(el.value);
      if (Number.isFinite(v)) return Math.min(2, Math.max(0.2, v));
    } catch(_) {}
    return defaultRate;
  }

  // --- ÌïµÏã¨: speak() Ìå®Ïπò (Í∏∞Ï°¥ ÏΩîÎìú ÌùêÎ¶Ñ Î≥¥Ï°¥) ---
  const originalSpeak = speechSynthesis.speak.bind(speechSynthesis);
  speechSynthesis.speak = function(utter){
    try {
      // Î≥¥Ïù¥Ïä§ ÏûêÎèô ÏÑ†ÌÉù(ÏÇ¨Ïö©ÏûêÍ∞Ä ÎØ∏Î¶¨ ÏßÄÏ†ïÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ÏóêÎßå)
      if (!utter.voice && SELECTED_VOICE) {
        utter.voice = SELECTED_VOICE;
        if (!utter.lang) utter.lang = SELECTED_VOICE.lang || "ko-KR";
      }
      // ÌïúÍµ≠Ïñ¥Î©¥ ÏñµÏñë/ÏÜçÎèÑ Î≥¥Ï†ï
      const isKorean = (utter.lang||"").toLowerCase().startsWith("ko");
      if (isKorean) {
        // ÏÜçÎèÑ: #speed Î∞òÏòÅ (Í∏∞Ï°¥ Í∞íÏù¥ ÏûàÏúºÎ©¥ Ï°¥Ï§ë, ÏóÜÏúºÎ©¥ ÎåÄÏûÖ)
        if (!(utter.rate > 0)) utter.rate = getDesiredRate(0.98);

        // ÏßàÎ¨∏ ÏñµÏñë: Í∏∞Ï°¥ pitchÎ•º Ìï¥ÏπòÏßÄ ÏïäÎêò, ÎÇÆÏùÑ Í≤ΩÏö∞Îßå ÏÇ¥Ïßù Ïò¨Î¶º
        const q = isQuestionTone(utter.text || "");
        const targetPitch = q ? 1.18 : 1.0;
        if (!(utter.pitch > 0)) {
          utter.pitch = targetPitch;
        } else if (q && utter.pitch < 1.1) {
          utter.pitch = targetPitch;
        }
      }
    } catch (e) {
      console.warn("[Sori] speak patch warn:", e);
    }
    // ÏõêÎûò ÎèôÏûë Ìò∏Ï∂ú (Í∏∞Ï°¥ Î°úÏßÅ/Ïù¥Î≤§Ìä∏ Î≥¥Ï°¥)
    return originalSpeak(utter);
  };

  // Ï¥àÍ∏∞Ìôî: Î≥¥Ïù¥Ïä§ ÏÑ†ÌÉù ÌõÑ Ìå®Ïπò ÌôúÏÑ±
  (async function init(){
    try {
      const voices = await loadVoicesReady();
      SELECTED_VOICE = pickBestKoreanVoice(voices);
      // ÌïÑÏöîÏãú Ïù¥Î¶Ñ Í≥†Ï†ï ÏõêÌïòÎ©¥ Ïó¨Í∏∞ÏÑú SELECTED_VOICE = voices.find(v=>v.name==='ÏõêÌïòÎäîÏù¥Î¶Ñ')
      // console.log("[Sori] voice ->", SELECTED_VOICE && SELECTED_VOICE.name);
    } catch (e) {
      console.warn("[Sori] voice init failed:", e);
    }
  })();

  // Ïô∏Î∂ÄÏóêÏÑú ÏùåÏÑ± ÏÑ§Ï†ï Î∞îÍæ∏Í≥† Ïã∂ÏùÑ Îïå Ïì∏ Ïàò ÏûàÍ≤å ÎÖ∏Ï∂ú(ÏÑ†ÌÉù)
  window.SoriTTS = {
    setVoiceByName(name){
      try {
        const all = speechSynthesis.getVoices();
        const v = all.find(x => (x.name||"") === name);
        if (v) SELECTED_VOICE = v;
      } catch(_) {}
    },
    getVoice(){ return SELECTED_VOICE; }
  };
})();
</script>

  
</body>
</html>








