<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sori - Learn Korean by Sound</title>
<meta name="theme-color" content="#7c3aed"/>
<!-- Webfont for consistent capture rendering -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;800;900&display=swap" rel="stylesheet">

<!-- Favicon / Shortcut icon -->
<link rel="icon" type="image/svg+xml"
  href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="#7c3aed"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>
<link rel="shortcut icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="#7c3aed"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- PNG fallbacks for older browsers -->
<link rel="icon" type="image/png" sizes="32x32" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <circle cx="16" cy="16" r="15" fill="#7c3aed"/>
    <text x="16" y="21" font-family="Arial, Helvetica, sans-serif" font-size="14" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>
<link rel="icon" type="image/png" sizes="16x16" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <circle cx="8" cy="8" r="7" fill="#7c3aed"/>
    <text x="8" y="11" font-family="Arial, Helvetica, sans-serif" font-size="7" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- Safari pinned tab (ì„ íƒ) -->
<link rel="mask-icon" color="#7c3aed" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="30" fill="black"/>
    <text x="32" y="42" font-family="Arial, Helvetica, sans-serif" font-size="28" font-weight="700" fill="white" text-anchor="middle">S</text>
  </svg>'/>

<!-- iOS home screen icon -->
<link rel="apple-touch-icon" sizes="180x180" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 180">
    <rect width="180" height="180" rx="36" ry="36" fill="#7c3aed"/>
    <text x="90" y="118" font-family="Arial, Helvetica, sans-serif" font-size="64" font-weight="800" fill="white" text-anchor="middle">Sori</text>
  </svg>'/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Sori">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.webmanifest">

<script>window.GA_ID='G-X1Q98DBKR5';</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1Q98DBKR5"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config',window.GA_ID,{send_page_view:false});
</script>

<!-- Firebase v9 ëª¨ë“ˆ ë°©ì‹ìœ¼ë¡œ ë¡œë”© -->

<!-- html2canvas: ì¹´ë“œ ìº¡ì²˜ìš© -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;max-width:720px;margin:0 auto;padding:16px;background:#faf8ff;min-height:100vh;color:#111827}
h1{font-size:26px;margin:0 0 4px;color:#7c3aed;font-weight:800}
.intro{color:#9ca3af;font-size:12px;margin-bottom:10px;line-height:1.3;font-weight:500}

.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;position:relative}
.header::before{content:'beta';position:absolute;left:0px;top:-6px;font-size:8px;font-weight:900;color:#fff;background:#7c3aed;padding:1px 4px;border-radius:3px;text-transform:uppercase;letter-spacing:0.5px;z-index:1}
.top-btn{padding:8px 14px;border-radius:12px;font-size:12px;font-weight:700;border:0;cursor:pointer}
.top-btn.primary{background:#7c3aed;color:#fff}

.card{background:#fff;border-radius:18px;padding:18px;margin:10px 0;box-shadow:0 2px 12px rgba(0,0,0,.06)}

.category-bar{display:flex;align-items:center;gap:12px}
.picker-wrap{position:relative}
.picker-trigger{padding:12px 18px;border-radius:14px;background:#7c3aed;color:#fff;font-weight:800;border:0;cursor:pointer;min-width:220px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px}
.picker-trigger::after{content:'â–¼';font-size:10px;color:#fff}
.picker-menu{position:absolute;top:100%;left:0;right:0;margin-top:6px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;max-height:0;transition:max-height .25s ease;z-index:50}
.picker-menu.open{max-height:220px}
.picker-list{max-height:210px;overflow-y:auto;padding:6px;scrollbar-width:thin;position:relative}
.picker-list::after{content:'';position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(transparent, #fff);pointer-events:none;z-index:1}
.picker-list::before{content:'';position:absolute;top:0;left:0;right:0;height:20px;background:linear-gradient(#fff, transparent);pointer-events:none;z-index:1}
.picker-list::-webkit-scrollbar{width:6px}
.picker-list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}
.picker-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}
.picker-list::-webkit-scrollbar-thumb:hover{background:#a8a8a8}
.picker-item{height:44px;line-height:44px;border-radius:12px;margin:6px 4px;text-align:center;background:#f6f6ff;color:#5b5b72;font-weight:700;cursor:pointer;user-select:none}
.picker-item:hover,.picker-item.active{background:#7c3aed;color:#fff}
.saved-btn{height:44px;padding:0 14px;border-radius:12px;background:#fff;color:#7c3aed;border:2px solid #e9defd;font-weight:800;cursor:pointer;white-space:nowrap;font-size:13px;flex:1}
.saved-btn:hover{background:#f7f2ff}
.saved-btn.selected{background:#7c3aed;color:#fff;border-color:#7c3aed}
.picker-trigger.dim{background:#ede9fe;color:#6b21a8}

.sub-filters{display:none;gap:8px;flex-wrap:wrap;margin-top:12px;transition:opacity 0.2s ease;}
.sub-filters.visible{display:flex}
.sub-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:14px;background:#fff;border:2px solid #e5e7eb;color:#374151;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
.sub-chip.active{background:#7c3aed;border-color:#7c3aed;color:#fff}
.sub-chip-toggle{width:100%;padding:8px 12px;border-radius:12px;background:#f3f4f6;color:#6b7280;font-size:12px;font-weight:700;border:2px solid #e5e7eb;cursor:pointer;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:4px}
.sub-chip-toggle::after{content:'â–¼';font-size:10px;transition:all 0.2s ease}
.sub-chip-toggle.expanded::after{content:'â–²';font-size:10px}

.row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{display:inline-block;background:#7c3aed;color:#fff;font-size:11px;font-weight:800;padding:5px 10px;border-radius:12px}
.icon-btn{border:none;background:transparent;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;color:#9ca3af;cursor:pointer;border-radius:8px}
.icon-btn svg{display:block}
.icon-btn.active{color:#e11d48}

#lessonCard .context,
#lessonCard .en{opacity:0; transition:opacity .12s ease;}
#lessonCard.lesson-ready .context,
#lessonCard.lesson-ready .en{opacity:1;}

.context{color:#6b7280;font-size:16px;text-align:center;margin:8px 0 0;font-weight:600}

.kbox{background:#f3f4f6;border-radius:16px;padding:18px 14px;margin:10px 0;text-align:center}
.ko{font-size:30px;font-weight:900;margin:0 0 8px}
.en{color:#6b7280;font-size:16px;margin:0 0 10px;font-weight:600}

.practice{background:#f9fafb;border-radius:12px;padding:12px;margin:10px 0}
.practice-label{font-size:12px;font-weight:600;color:#6b7280;text-align:center;margin:0 0 8px}
.dots{display:flex;gap:10px;justify-content:center;margin-bottom:8px}
.rep-dot{width:30px;height:30px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;transition:.15s}
.rep-dot.completed{background:#7c3aed;border-color:#7c3aed}

button.big{width:100%;padding:14px 20px;border-radius:14px;border:0;cursor:pointer;font-weight:800;font-size:15px;background:#7c3aed;color:#fff;margin:10px 0}

.row{display:flex;align-items:center;justify-content:center;gap:12px;background:#f9fafb;border-radius:10px;padding:10px;margin:10px 0}
.speed-val{min-width:56px;text-align:left;font-variant-numeric:tabular-nums}
input[type="range"]{accent-color:#7c3aed;outline:0}
input[type="range"]::-webkit-slider-runnable-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-webkit-slider-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9;margin-top:-6px}
input[type="range"]::-moz-range-track{height:6px;border-radius:999px;background:#e9defd}
input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#7c3aed;border:2px solid #6d28d9}

.tip-card{margin:10px 0;background:#fff1f2;border-left:3px solid #e11d48;border-radius:10px;padding:10px}
.tip-text{font-size:12px;color:#9f1239;font-weight:600}

/* ëª…ì‚¬ ëœ» í‘œì‹œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
.noun-definitions{background:#f8f9fa;border-radius:12px;padding:12px;margin:10px 0}
.noun-list{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.noun-item{display:flex;align-items:center;gap:6px;background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;font-weight:600}
.noun-korean{color:#7c3aed;font-weight:800}
.noun-english{color:#6b7280}
.noun-roman{color:#9ca3af;font-size:11px}

.hidden-tabs{display:none}

.auth{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,.45);padding:16px}
.auth.open{display:flex}
.auth-card{background:#fff;width:100%;max-width:380px;border-radius:20px;padding:24px;box-shadow:0 18px 50px rgba(0,0,0,.35);text-align:center;position:relative}
.auth-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:22px;color:#9ca3af;cursor:pointer}
.gbtn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:10px 14px;border-radius:12px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;font-weight:700;cursor:pointer}
.gbtn:hover{border-color:#d8dbe2;box-shadow:0 2px 8px rgba(124,58,237,.15)}
.glogo{width:18px;height:18px;display:inline-block}

.navbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:nowrap}
.nav-center{min-width:130px;text-align:center;font-size:13px;color:#6b7280;font-weight:700}
.nav-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 28px;border-radius:14px;border:1.5px solid #e5e7eb;background:#fff;color:#111827;cursor:pointer;font-weight:800;font-size:14px;box-shadow:0 1px 6px rgba(0,0,0,.05)}
.nav-btn:hover{border-color:#d8dbe2}
.nav-btn .caret{font-size:15px;color:#7c3aed}
.nav-btn:disabled{opacity:.5;cursor:not-allowed}

@media (max-width:480px){
  .navbar{flex-wrap:wrap}
  .nav-btn{flex:1 1 calc(50% - 8px);min-width:140px}
  .nav-center{order:3;width:100%;margin-top:8px}
}

/* Congrats toast */
#congrats {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  padding: 10px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,.75);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
  z-index: 9999;
}
#congrats.show { opacity: 1; }

/* brand badge (included in capture) */
.brand-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:6px}
.brand{display:inline-flex;align-items:center;gap:8px;background:#f5f3ff;border:1.5px solid #e9defd;padding:6px 10px;border-radius:999px;color:#7c3aed;font-weight:800;font-size:12px}
.brand svg{display:block}

/* speech level tags - ì¹´í…Œê³ ë¦¬ íƒœê·¸ì™€ ë³„ë„ë¡œ ë‚˜ë€íˆ ë°°ì¹˜ */
.speech-level-tag {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 8px;
  vertical-align: middle;
  height: 28px;
  line-height: 18px;
  position: relative;
  z-index: 1;
}
.speech-level-tag.polite {
  background: #EDE9FE;
  color: #7C3AED;
}
.speech-level-tag.casual {
  background: #F3F4F6;
  color: #4B5563;
}

/* ì¹´í…Œê³ ë¦¬ íƒœê·¸ì™€ ê²½ì–´/ë°˜ë§ íƒœê·¸ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜ */
.badge-container {
  display: flex;
  align-items: center;
  gap: 3px;
}

.badge {
  display: inline-block;
  background: #7c3aed;
  color: #fff;
  font-size: 11px;
  font-weight: 800;
  padding: 5px 10px;
  border-radius: 12px;
}

/* Footer */
#appFooter {
  max-width: 720px;
  margin: 40px auto 0;
  padding: 20px 0;
  background: #fff;
  border-top: 1px solid #e5e7eb;
  box-shadow: 0 -2px 12px rgba(0,0,0,.04);
}

.footer-content {
  max-width: 720px;
  margin: 0 auto;
  padding: 0 16px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  text-align: center;
}

.footer-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.footer-title {
  font-size: 12px;
  font-weight: 800;
  color: #7c3aed;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.footer-text {
  font-size: 11px;
  color: #6b7280;
  margin: 0;
  line-height: 1.5;
}

.footer-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #6b7280;
  text-decoration: none;
  font-size: 11px;
  transition: color 0.2s ease;
}

.footer-link:hover {
  color: #7c3aed;
}

.footer-link svg {
  flex-shrink: 0;
}

.footer-copyright {
  grid-column: 1 / -1;
  font-size: 10px;
  color: #9ca3af;
  margin-top: 8px;
  padding-top: 16px;
  border-top: 1px solid #f3f4f6;
}

@media (max-width: 600px) {
  #appFooter {
    margin: 30px 16px 0;
  }
  
  .footer-content {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .footer-section {
    text-align: left;
  }
}

</style>

<link rel="stylesheet" href="css/sidebar.css">
<link rel="stylesheet" href="css/quiz.css">
<link rel="stylesheet" href="css/announcement.css">
</head>
<body>
<header class="header">
  <div>
    <h1 class="logo-home" style="cursor: pointer;">Sori <span style="font-size:14px;color:#111827;font-weight:600;">ì†Œë¦¬</span></h1>
    <div class="intro">Learn Korean naturally by repeating real sounds</div>
  </div>
  <div class="header-actions">
    <button id="openLogin" class="top-btn primary">Login</button>
    <button id="menuToggle" class="menu-btn" aria-label="Menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
  </div>
</header>

<div class="main-content" id="mainContent">
<section class="card">
  <div class="category-bar">
    <div class="picker-wrap">
      <button id="pickerTrigger" class="picker-trigger" aria-haspopup="listbox" aria-expanded="false">Daily</button>
      <div id="pickerMenu" class="picker-menu"><div class="picker-list" role="listbox"></div></div>
    </div>
    <button id="savedBtn" class="saved-btn">â˜… Saved</button>
  </div>

  <div class="hidden-tabs" aria-hidden="true">
    <button id="dailyBtn"    class="tab-button active">Daily</button>
    <button id="travelBtn"   class="tab-button">Travel</button>
    <button id="trendyBtn"   class="tab-button">Trendy Talk</button>
    <button id="dramaBtn"    class="tab-button">K-Drama</button>
    <button id="numbersBtn"  class="tab-button">Numbers</button>
    <button id="savedBtnHidden" class="tab-button">Saved</button>
  </div>

  <div id="subFilters" class="sub-filters"></div>
  <button id="subFiltersToggle" class="sub-chip-toggle" style="display:none;">
    <span>View Categories</span>
  </button>
</section>

<section class="card" id="lessonCard">
  <div class="row-between">
    <div class="badge-container">
      <div id="badge" class="badge">Love</div>
    </div>

    <div style="display:flex;gap:6px;align-items:center;">
      <!-- ê³µìœ  ë²„íŠ¼ (ë³„í‘œì™€ ë™ì¼í•œ ë””ìì¸) -->
      <button id="threadShareBtn" class="icon-btn" title="Share" aria-label="Share" type="button">
        <svg aria-hidden="true" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <!-- ë°”ê¹¥ ë„¤ëª¨ (ì¢Œí•˜ë‹¨ ì—´ë¦° ë°•ìŠ¤) -->
          <path d="M4 9a3 3 0 0 1 3-3h5v2H7a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-5h2v5a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V9z"/>
          <!-- ë°”ê¹¥ìœ¼ë¡œ ë‚˜ê°€ëŠ” í™”ì‚´í‘œ (ìš°ìƒí–¥) -->
          <path d="M14 3h7v7h-2V6.414l-8.293 8.293-1.414-1.414L17.586 5H14V3z"/>
        </svg>
      </button>

      <!-- ê¸°ì¡´ ë³„í‘œ ì €ì¥ ë²„íŠ¼ -->
      <button id="scrapBtn" class="icon-btn" title="Save this phrase" aria-label="Save" style="font-size:18px;">â˜†</button>
    </div>
  </div>

  <div id="context" class="context">"I like you."</div>

  <div class="kbox">
    <p id="korean" class="ko">ë‹¹ì‹ ì´ ì¢‹ì•„ìš”.</p>
    <p id="english" class="en">dangshini joayo</p>
    <p id="pronunciation" style="display:none">dangshini joayo</p>
  </div>

  <!-- ëª…ì‚¬ ëœ» í‘œì‹œ ì˜ì—­ -->
  <div id="nounDefinitions" class="noun-definitions" style="display:none;">
    <div class="noun-list"></div>
  </div>

  <div class="practice">
    <p class="practice-label">Practice Count: <span id="repCount">0</span> / 5</p>
    <div class="dots">
      <div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div><div class="rep-dot"></div>
    </div>
  </div>

  <button id="playBtn" class="big">Listen & Repeat</button>
  <div class="row">
    <label>Speed:</label>
    <input id="speed" type="range" min="0.6" max="1.0" step="0.05" value="0.80"/>
    <span id="speedTxt" class="speed-val">0.80x</span>
  </div>

  <div class="tip-card"><div id="tipText" class="tip-text">Tip: Listen carefully and repeat multiple times. Consistency is key.</div></div>
</section>

<section class="card">
  <div class="navbar">
    <button id="prevBtn" class="nav-btn"><span class="caret">â—€</span> Previous</button>
    <div id="prog" class="nav-center">1 / 45</div>
    <button id="nextBtn" class="nav-btn">Next <span class="caret">â–¶</span></button>
  </div>
</section>
</div>

<div id="quizView" class="newsletter-view" style="display: none; padding-top: 0;">
  <section class="card">
    <div class="quiz-content">
      <div class="quiz-header">
        <div>
          <h2 class="quiz-title">Daily Quiz</h2>
          <p class="quiz-description">Test your Korean knowledge</p>
        </div>
        <div class="quiz-stats">
          <div class="quiz-streak">
            ğŸ”¥ <span id="quizStreak">0</span>
          </div>
          <div class="quiz-progress">
            <p>Score: <span id="quizScore">0</span> / <span id="quizTotal">5</span></p>
          </div>
        </div>
      </div>
      
      <div class="quiz-category-selector">
        <p class="quiz-category-label">Category:</p>
        <button class="quiz-category active" data-category="daily">Daily</button>
        <button class="quiz-category" data-category="travel">Travel</button>
        <button class="quiz-category" data-category="trendy">Trendy Talk</button>
        <button class="quiz-category" data-category="drama">K-Drama</button>
        <button class="quiz-category" data-category="numbers">Numbers</button>
      </div>
      
      <div class="quiz-question-container">
        <div class="quiz-question">
          <button id="quizPlayBtn" class="quiz-play-btn"></button>
          <p class="quiz-korean">ì•ˆë…•í•˜ì„¸ìš”</p>
        </div>
        
        <div class="quiz-actions-top">
          <button id="quizFavoriteBtn" class="quiz-favorite-btn">
            <span class="quiz-favorite-text">â˜†</span>
            <span class="quiz-info-badge">?</span>
            <span class="quiz-tooltip">Click to save for review in Saved</span>
          </button>
        </div>
        
        <div class="quiz-speed-control">
          <label>Speed:</label>
          <input id="quizSpeed" type="range" min="0.6" max="1.0" step="0.05" value="0.80"/>
          <span id="quizSpeedVal" class="speed-val">0.80x</span>
        </div>
      </div>
      
      <div class="quiz-options">
        <button class="quiz-option">Hello</button>
        <button class="quiz-option">Goodbye</button>
        <button class="quiz-option">Thank you</button>
        <button class="quiz-option">See you</button>
      </div>
      
      <button class="quiz-submit" disabled>Check Answer</button>
      
      <div class="quiz-actions">
        <button id="quizPrevBtn" class="quiz-nav-btn" disabled>â—€ Previous</button>
        <button id="quizNextBtn" class="quiz-nav-btn">Next â–¶</button>
      </div>
    </div>
  </section>
</div>

<div id="newsletterView" class="newsletter-view" style="display: none;">
  <section class="card">
    <div class="korea101-content">
      <h2 class="korea101-title">Korea101</h2>
      <p class="korea101-description">A newsletter delivering Korean news, information, and insights.</p>
      <p class="korea101-subtitle">Coming soon</p>
    </div>
  </section>
</div>

<!-- Quiz Announcement Popup -->
<div id="announcementOverlay" class="announcement-overlay"></div>
<div id="announcementPopup" class="announcement-popup">
  <div class="announcement-content">
    <div class="announcement-icon">ğŸ‰</div>
    <h2 class="announcement-title">New Feature</h2>
    <p class="announcement-message">
      Quiz is now available!<br>
      Check it out in the top right menu.
    </p>
    <div class="announcement-actions">
      <button class="announcement-btn primary announcement-close">Got it</button>
      <label class="announcement-dismiss">
        <input type="checkbox" id="announcementDontShow" style="margin-right: 4px;">
        Don't show for 24 hours
      </label>
    </div>
  </div>
</div>

<div id="authModal" class="auth">
  <div class="auth-card">
    <button id="authClose" class="auth-close" aria-label="Close">Ã—</button>
    <div style="font-size:24px;font-weight:800;color:#7c3aed;margin-bottom:6px;">Sign in</div>
    <div style="font-size:13px;color:#9ca3af;margin-bottom:18px;">Use your Google account</div>
    <button class="gbtn" id="googleLogin">
      <span class="glogo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18"><path fill="#EA4335" d="M9 7.3h8.5v3.4H9z"/><path fill="#4285F4" d="M17.6 9.2c0-.6-.1-1.2-.2-1.8H9v3.4h4.8c-.2 1-.8 1.8-1.7 2.3v1.9h2.8c1.6-1.5 2.7-3.7 2.7-5.8z"/><path fill="#FBBC05" d="M9 18c2.4 0 4.4-.8 5.9-2.2l-2.8-1.9c-.8.5-1.8.8-3.1.8-2.4 0-4.5-1.6-5.2-3.7H.9v2.3C2.4 15.9 5.4 18 9 18z"/><path fill="#34A853" d="M3.8 11c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V4.7H.9C.3 6 0 7.5 0 9s.3 3 .9 4.3L3.8 11z"/><path fill="#EB4335" d="M9 3.5c1.3 0 2.5.5 3.4 1.4l2.3-2.3C13.4.9 11.4 0 9 0 5.4 0 2.4 2.1.9 4.7L3.8 7c.7-2.1 2.8-3.5 5.2-3.5z"/></svg>
      </span>
      Continue with Google
    </button>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <h2 class="sidebar-title">Menu</h2>
    <button id="sidebarClose" class="sidebar-close" aria-label="Close">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>
  <div class="sidebar-menu">
    <button class="menu-item active" data-view="listen">Listen & Repeat</button>
    <button class="menu-item" data-view="quiz">Daily Quiz</button>
    <button class="menu-item" data-view="newsletter">Korea101</button>
  </div>
</div>

<!-- data sources -->
<script defer src="data/daily.js?v=20251017"></script>
<script defer src="data/travel.js?v=20251017"></script>
<script defer src="data/drama.js?v=20251017"></script>
<script defer src="data/trendy.js?v=20251019"></script>
<script defer src="data/numbers.js?v=20251019"></script>
<script defer src="data/dataindex.js?v=20251019"></script>
<script defer src="data/nouns.js?v=20251019"></script>
<script defer src="data/speech-level.js?v=20251028"></script>
<script defer src="data/data-processor.js?v=20251019"></script>

<!-- app scripts -->
<script type="module" src="/js/firebase-init.js" defer></script>
<script type="module" src="/js/auth.js" defer></script>
<script defer src="js/state.js?v=20251017"></script>
<script defer src="js/tts.js?v=20251017"></script>
<script defer src="js/app.js?v=20251017"></script>
<script defer src="js/sidebar.js"></script>
<script defer src="js/quiz.js"></script>
<script defer src="js/announcement.js"></script>

<script>
/* Sori Auth â€” final stable gate (popupâ†’redirect, no alerts) */
(function () {
  const $ = (id) => document.getElementById(id);

  // DOM
  const modal = $("authModal");
  const btnOpen = $("openLogin");
  const btnClose = $("authClose");
  const btnGoogle = $("googleLogin");
  const btnScrap = $("scrapBtn");
  const btnSaved = $("savedBtn");
  const btnSavedHidden = $("savedBtnHidden");

  // modal
  const openModal  = () => modal?.classList.add("open");
  const closeModal = () => modal?.classList.remove("open");
  btnClose?.addEventListener("click", closeModal);
  modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  // state / utils
  const now = () => Date.now();
  let wired = false;
  let isLoggingOut = false;
  let suppressAutoModalUntil = 0; // ë¡œê·¸ì•„ì›ƒ ì§í›„ ìë™ ëª¨ë‹¬ ë°©ì§€
  let pendingAction = null;       // ë¡œê·¸ì¸ ì„±ê³µ í›„ 1íšŒ ì¬ì‹œë„
  let bypassGate = false;         // ì¬ì‹œë„ í´ë¦­ì´ ê²Œì´íŠ¸ì— ë‹¤ì‹œ ê±¸ë¦¬ì§€ ì•Šê²Œ

  const hasAuth   = () => !!window.firebaseAuth;
  const user      = () => (window.firebaseAuth ? window.firebaseAuth.currentUser : null);
  const loggedIn  = () => !!user();
  const hasLoginAPI = () => !!(window.SoriUser &&
                              (window.SoriUser.loginWithPopup ||
                               window.SoriUser.loginRedirect ||
                               window.SoriUser.login));

  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function waitUntil(cond, {timeout=12000, step=60}={}) {
    const t0 = now();
    while (!cond()) {
      if (now()-t0 > timeout) return false;
      await wait(step);
    }
    return true;
  }

  // header button
  function paintHeaderBtn() {
    if (!btnOpen) return;
    if (loggedIn()) {
      btnOpen.textContent = "Logout";
      btnOpen.onclick = async (ev) => {
        ev?.preventDefault?.();
        ev?.stopPropagation?.();
        try {
          isLoggingOut = true;
          pendingAction = null;        // ë¡œê·¸ì•„ì›ƒ ì‹œì‘ ì‹œ ì¦‰ì‹œ ì·¨ì†Œ
          suppressAutoModalUntil = now() + 2500;
          await window.SoriUser?.logout?.();
        } finally {
          // ì•½ê°„ì˜ ì—¬ìœ ë¥¼ ë‘ê³  í”Œë˜ê·¸ í•´ì œ
          setTimeout(()=>{ isLoggingOut = false; }, 600);
        }
      };
    } else {
      btnOpen.textContent = "Login";
      btnOpen.onclick = (ev) => {
        ev?.preventDefault?.();
        // ë¡œê·¸ì•„ì›ƒ ì§í›„ ê°™ì€ í´ë¦­ì´ ì—¬ê¸°ë¡œ ë“¤ì–´ì™€ë„ ë¬´ì‹œ
        if (now() < suppressAutoModalUntil || isLoggingOut) return;
        openModal();
      };
    }
  }

  // ê²Œì´íŠ¸: ë¡œê·¸ì¸ ì•ˆë¼ ìˆìœ¼ë©´ ëª¨ë‹¬ë§Œ ë„ìš°ê³  ì› í´ë¦­ì€ ì°¨ë‹¨
  function guard(el, action) {
    if (!el) return;
    el.addEventListener("click", (e) => {
      if (bypassGate || loggedIn()) return; // ì¬ì‹œë„ or ë¡œê·¸ì¸ ìƒíƒœë©´ í†µê³¼
      e.stopImmediatePropagation();
      e.preventDefault();
      pendingAction = action;
      // ë¡œê·¸ì•„ì›ƒ ì§í›„ ìë™ ëª¨ë‹¬ ê¸ˆì§€
      if (now() >= suppressAutoModalUntil) openModal();
    }, true); // captureì—ì„œ ë¨¼ì € ë§‰ê¸°
  }

  // ì‹¤ì œ ë¦¬ìŠ¤ë„ˆë§Œ íƒœìš°ëŠ” synthetic click (ê²Œì´íŠ¸ëŠ” ê±´ë„ˆë›°ê¸°)
  function fireClick(el) {
    if (!el) return;
    bypassGate = true;
    try {
      const evt = new MouseEvent("click", {bubbles:true, cancelable:true});
      el.dispatchEvent(evt);
    } finally {
      // ë‹¤ìŒ í‹±ì— í•´ì œ(í˜¹ì‹œ ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ì—ì„œ ë˜ í´ë¦­ì„ ë§Œë“œëŠ” ê²½ìš° ë°©ì§€)
      setTimeout(()=>{ bypassGate = false; }, 0);
    }
  }

  guard(btnScrap, () => fireClick(btnScrap));
  guard(btnSaved, () => fireClick(btnSavedHidden));

  // Google sign-in: redirectë§Œ ì‚¬ìš© (COOP ê²½ê³  ì œê±°)
  async function doSignIn() {
    const ready = await waitUntil(()=> hasAuth() && hasLoginAPI());
    if (!ready) return; // ì¡°ìš©íˆ í¬ê¸°(ë‹¤ìŒ í´ë¦­ì—ì„œ ë‹¤ì‹œ ì‹œë„)

    const S = window.SoriUser;
    if (S?.loginRedirect) return S.loginRedirect();  // <- ë¬´ì¡°ê±´ redirect
    if (S?.login)         return S.login();
  }

  btnGoogle?.addEventListener("click", (e) => {
    e?.preventDefault?.();
    doSignIn();
  });

  // auth wiring
  function onAuthChanged(u) {
    paintHeaderBtn();

    if (u) {
      // ë¡œê·¸ì¸ í™•ì •
      closeModal();
      if (pendingAction) {
        const act = pendingAction; pendingAction = null;
        // currentUser ì „íŒŒê°€ ëª¨ë‘ ëë‚œ ë’¤ 1íšŒë§Œ ì¬ì‹œë„
        waitUntil(()=>loggedIn(), {timeout:4000, step:80})
          .then(()=> setTimeout(()=>{ try{ act(); }catch(_){ } }, 60));
      }
    } else {
      // ë¡œê·¸ì•„ì›ƒ â†’ ì¦ê²¨ì°¾ê¸° í‘œì‹œ ì´ˆê¸°í™”
      resetScrapUI();
      // í˜¹ì‹œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆëŠ” í›„ì† ë™ì‘ë„ ë¬´íš¨í™”
      pendingAction = null;
    }
  }

  function wire() {
    if (wired || !hasAuth()) return;
    wired = true;
    try {
      window.firebaseAuth.onAuthStateChanged(onAuthChanged);
    } catch (e) { console.error("auth wiring error:", e); }
    paintHeaderBtn();
    onAuthChanged(user());
  }

  window.addEventListener("firebaseReady", wire);
  wire(); // ì´ë¯¸ ì¤€ë¹„ëœ ê²½ìš° ëŒ€ë¹„

  // ë³„í‘œ UI ì´ˆê¸°í™”
  function resetScrapUI() {
    const star = document.getElementById('scrapBtn');
    if (star) {
      star.classList.remove('active'); // ë¹¨ê°„ ë³„ ì œê±°
      star.textContent = 'â˜†';         // ì•„ì´ì½˜ë„ ì›ë³µ(í˜¹ì‹œ ë‚´ë¶€ì—ì„œ ë°”ê¿¨ì„ ë•Œ ëŒ€ë¹„)
    }
  }

  // ë””ë²„ê¹…ìš©(ì›í•˜ë©´ ì‚­ì œ)
  window.SoriAuth = { loggedIn, fireClick };
})();
</script>

<script>
(function(){
  const CATS=["Daily","Travel","Trendy Talk","K-Drama","Numbers"];
  const trigger=pickerTrigger, menu=pickerMenu, list=menu.querySelector('.picker-list');
  list.innerHTML='';
  CATS.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='picker-item'+(i===0?' active':''); el.textContent=c;
    el.onclick=()=>{ list.querySelectorAll('.picker-item').forEach(n=>n.classList.remove('active')); el.classList.add('active');
      trigger.textContent=c; menu.classList.remove('open');
      const key=c.toLowerCase();
      if(key==='daily') dailyBtn.click();
      else if(key==='travel') travelBtn.click();
      else if(key==='k-drama' || key==='kdrama') dramaBtn.click();
      else if(key==='numbers') numbersBtn.click();
      else trendyBtn.click();
      changeTip();
    };
    list.appendChild(el);
  });
  trigger.onclick=(e)=>{ e.stopPropagation(); menu.classList.toggle('open'); };
  document.onclick=()=>menu.classList.remove('open');
  savedBtn?.addEventListener('click',()=> savedBtnHidden?.click());

  // Saved/Daily íƒ­ ìƒ‰ìƒ ë°˜ì „
  function selectSavedUI(on){
    const saved = document.getElementById('savedBtn');
    const daily = document.getElementById('pickerTrigger');
    saved?.classList.toggle('selected', !!on);
    daily?.classList.toggle('dim', !!on);
  }

  // Saved ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì„ íƒ í‘œì‹œ
  savedBtn?.addEventListener('click', () => selectSavedUI(true));

  // ë‹¤ë¥¸ íƒ­(Daily/Travel/â€¦/Numbers)ë¡œ ë°”ë€Œë©´ ì„ íƒ í•´ì œ
  ['dailyBtn','travelBtn','trendyBtn','dramaBtn','numbersBtn'].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener('click', ()=> selectSavedUI(false));
  });

  const tips=[
    "Tip: Small daily reps beat big, rare sessions.","Tip: Shadow the sound, not the spelling.",
    "Tip: Say it out loud â€” your mouth must learn too.","Tip: Five clean repeats > twenty sloppy ones.",
    "Tip: Record yourself and match the rhythm.","Tip: First mimic, then understand.",
    "Tip: Keep the same speed; build consistency.","Tip: Close your eyes and copy the melody.",
    "Tip: Bite-sized goals. One phrase at a time.","Tip: Revisit yesterday â€” retention makes speed."
  ];
  const tipEl=tipText; function changeTip(){ tipEl.textContent=tips[Math.floor(Math.random()*tips.length)]; } changeTip();

  // ì¹´í…Œê³ ë¦¬ í† ê¸€ ê¸°ëŠ¥
  const subFiltersToggle = document.getElementById('subFiltersToggle');
  const subFilters = document.getElementById('subFilters');
  if (subFiltersToggle && subFilters) {
    subFiltersToggle.addEventListener('click', () => {
      subFilters.classList.toggle('visible');
      subFiltersToggle.classList.toggle('expanded');
      subFiltersToggle.querySelector('span').textContent = 
        subFilters.classList.contains('visible') ? 'Hide Categories' : 'View Categories';
    });
    
    // subFiltersê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ìë™ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬
    // app.jsì—ì„œ displayë¥¼ flexë¡œ ì„¤ì •í•  ë•Œ í† ê¸€ ë²„íŠ¼ë„ í‘œì‹œ
    const observer = new MutationObserver(() => {
      if (subFilters.innerHTML.trim() !== '') {
        subFiltersToggle.style.display = 'block';
      }
    });
    observer.observe(subFilters, { childList: true, subtree: true });
  }
})();
</script>

<script>
(function(){
  const btn={next:nextBtn,prev:prevBtn,daily:dailyBtn,travel:travelBtn,drama:dramaBtn,trendy:trendyBtn,numbers:numbersBtn};
  const progEl=prog, badgeEl=badge; const tabs=[btn.daily,btn.travel,btn.trendy,btn.drama,btn.numbers].filter(Boolean);
  const CAT_KEY={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'drama',trendyBtn:'trendy',numbersBtn:'numbers'};
  const getActiveTab=()=> tabs.find(t=>t.classList.contains('active'))||btn.daily;
  const getActiveCatKey=()=> CAT_KEY[getActiveTab().id];
  function getProgress(){ const m=(progEl?.textContent||'').match(/(\d+)\s*\/\s*(\d+)/); if(!m) return {i:1,total:1}; return {i:parseInt(m[1],10),total:parseInt(m[2],10)};}
  function subOrderOf(catKey){ const arr=(window.SORI_DATA&&window.SORI_DATA[catKey])||[]; const order=[]; for(const x of arr){const s=x?.sub||'Default'; if(!order.includes(s)) order.push(s);} return order;}
  const currentSubName=()=> (badgeEl?.textContent||'').trim();
  function goFirstItem(){ const {i}=getProgress(); for(let k=1;k<i;k++) btn.prev?.click(); setTimeout(()=>{ const again=getProgress().i; for(let k=1;k<again;k++) btn.prev?.click();},0); }
  function clickSubChipByName(name){ const chips=[...document.querySelectorAll('#subFilters .sub-chip')]; const t=chips.find(c=>(c.textContent||'').trim()===name)||chips.find(c=>(c.textContent||'').includes(name)); if(t) t.click(); }
  function goFirstSubAndItem(){ setTimeout(()=>{ const first=document.querySelector('#subFilters .sub-chip'); if(first) first.click(); setTimeout(goFirstItem,0); },0); }
  btn.next?.addEventListener('click',function(e){ const {i,total}=getProgress(); if(i<total) return; e.preventDefault(); e.stopImmediatePropagation();
    const subs=subOrderOf(getActiveCatKey()); const cur=currentSubName(); const idx=Math.max(0,subs.indexOf(cur));
    if(idx>-1 && idx<subs.length-1){ clickSubChipByName(subs[idx+1]); setTimeout(goFirstItem,0); return; }
    const curTab=getActiveTab(); const tIdx=tabs.indexOf(curTab); const nextIdx=(tIdx+1)%tabs.length; tabs[nextIdx].click(); goFirstSubAndItem();
  },true);
  tabs.forEach(t=> t?.addEventListener('click',()=>{ goFirstSubAndItem(); }));
})();
</script>

<script>
(function(){
  function buildPath(){
    const active=document.querySelector('.tab-button.active')?.id || 'dailyBtn';
    const catMap={dailyBtn:'daily',travelBtn:'travel',dramaBtn:'kdrama',trendyBtn:'trendy',numbersBtn:'numbers',savedBtn:'saved'};
    const cat=catMap[active]||'daily';
    const sub=(badge?.textContent||'default').trim().replace(/\s+/g,'-').toLowerCase();
    const m=(prog?.textContent||'1 / 1').match(/(\d+)\s*\/\s*(\d+)/); const idx=m?parseInt(m[1],10):1;
    return `/${cat}/${sub}/${idx}`;
  }
  function sendPV(title){ try{ gtag('event','page_view',{page_title:title||document.title,page_location:location.href,page_path:buildPath(),send_to:'G-X1Q98DBKR5'});}catch(e){} }
  function sendSessionStart(){ try{ gtag('event','session_start',{send_to:'G-X1Q98DBKR5'});}catch(e){} }
  document.addEventListener('DOMContentLoaded',()=>{ setTimeout(()=>{ sendSessionStart(); sendPV('Sori'); },0); });
  ['dailyBtn','travelBtn','dramaBtn','trendyBtn','numbersBtn','savedBtnHidden'].forEach(id=>{ const el=document.getElementById(id); el&&el.addEventListener('click',()=> setTimeout(()=>sendPV(`Sori - ${el.textContent.trim()}`),0)); });
  const subFilters=document.getElementById('subFilters');
  subFilters&&subFilters.addEventListener('click',e=>{ const chip=e.target.closest('.sub-chip'); if(!chip) return; setTimeout(()=>sendPV(`Sori - ${chip.textContent.trim()}`),0); });
  nextBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Next'),0),true);
  prevBtn?.addEventListener('click',()=> setTimeout(()=>sendPV('Sori - Prev'),0),true);
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') setTimeout(()=>sendPV('Sori - resume'),0); });
  speed?.addEventListener('change',()=>{ gtag('event','change_speed',{value:speed.value,send_to:'G-X1Q98DBKR5'}); });
  window.buildPath = buildPath;
})();
</script>

<!-- TTS API 0.6~1.0 with toast -->
<script>
window.addEventListener('load',()=>{
  const ENDPOINT="https://asia-northeast3-sori-tts.cloudfunctions.net/tts";
  const audio=new Audio(); let lastUrl=null;
  const speedEl=document.getElementById('speed');

  function getRate(){ const v=parseFloat(speedEl?.value||'1'); return Math.max(0.6, Math.min(1.0, v)); }
  function setAudioRate(){ audio.playbackRate=getRate(); }
  speedEl?.addEventListener('input', setAudioRate);

  async function playKo(text){
    try{ audio.pause(); }catch(_){}
    if(lastUrl){ try{ URL.revokeObjectURL(lastUrl);}catch(_){ } lastUrl=null; }
    const t=(text||'').trim(); if(!t) return;
    const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})});
    const b=await r.blob(); const url=URL.createObjectURL(b); lastUrl=url; audio.src=url; setAudioRate(); await audio.play();
  }

  document.getElementById('playBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault(); e.stopImmediatePropagation();
    const ko=(document.getElementById('korean')?.textContent||'').trim();
    await playKo(ko);

    const cntEl=document.getElementById('repCount');
    let n=parseInt(cntEl.textContent||'0',10);
    if(n<5){ n++; cntEl.textContent=String(n); }
    document.querySelectorAll('.rep-dot').forEach((d,i)=> d.classList.toggle('completed', i < n));

    if(n===5){
      const toast=document.getElementById('congrats');
      if(toast){
        toast.textContent="Nice work!";
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1800);
      }
    }
  }, true);

  if('speechSynthesis' in window){
    try{ window.speechSynthesis.speak = ()=>{}; window.speechSynthesis.cancel = ()=>{}; }catch(_){}
  }
});
</script>


<!-- Threads 1-í´ë¦­: ì¹´ë“œ ìº¡ì²˜(+ê°€ëŠ¥í•˜ë©´ íŒŒì¼ ê³µìœ ) -> Threads í…ìŠ¤íŠ¸ ì—´ê¸° -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const shareBtn = document.getElementById('threadShareBtn');
  const koEl = document.getElementById('korean');
  const ctxEl = document.getElementById('context');

  async function captureCardBlob(){
    // í—¤ë”ì™€ lessonCardë§Œ í¬í•¨í•˜ëŠ” ëª¨ë°”ì¼ ìµœì í™” ì»¨í…Œì´ë„ˆ ìƒì„±
    const header = document.querySelector('.header');
    const lessonCard = document.getElementById('lessonCard');
    
    // ì„ì‹œ ì»¨í…Œì´ë„ˆ ìƒì„± (ëª¨ë°”ì¼ ìµœì í™”)
    const container = document.createElement('div');
    container.style.cssText = `
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 375px;
      max-width: 375px;
      background: #faf8ff;
      padding: 12px;
      box-sizing: border-box;
    `;
    
    // í—¤ë”ì™€ lessonCard ë³µì‚¬
    const headerClone = header.cloneNode(true);
    const lessonCardClone = lessonCard.cloneNode(true);
    
    // ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì ìš©
    headerClone.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 0;
    `;
    
    lessonCardClone.style.cssText = `
      background: #fff;
      border-radius: 18px;
      padding: 16px;
      margin: 0;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
    `;
    
    container.appendChild(headerClone);
    container.appendChild(lessonCardClone);
    document.body.appendChild(container);
    
    // í°íŠ¸ ë¡œë“œ ëŒ€ê¸°
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    }
    
    const canvas = await html2canvas(container, {
      backgroundColor:'#faf8ff', 
      scale:2,
      useCORS: true,
      allowTaint: true,
      logging: false,
      width: 375,
      height: container.scrollHeight
    });
    
    // ì„ì‹œ ì»¨í…Œì´ë„ˆ ì œê±°
    document.body.removeChild(container);
    
    return new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/png'));
  }

  async function shareToThreads(){
    const ko = (koEl?.textContent||'').trim();
    const en = (ctxEl?.textContent||'').replace(/^"+|"+$/g,'').trim() || 'Learn Korean with Sori';
    const shareText = `Sori - Learn Korean by Sound\nhttp://sorikorea.com`;

    console.log('Share Text:', shareText);

    try{
      const blob = await captureCardBlob();
      
      // ë°©ë²• 1: Web Share API ì‚¬ìš© (ëª¨ë°”ì¼ì—ì„œ ê°€ì¥ í™•ì‹¤)
      if (navigator.share) {
        try {
          console.log('Trying Web Share API');
          const file = new File([blob], 'sori-phrase.png', {type: 'image/png'});
          
          await navigator.share({
            title: 'Sori - Learn Korean by Sound',
            text: shareText,
            files: [file]
          });
          console.log('Web Share API success');
          return;
        } catch (shareError) {
          console.log('Web Share API failed:', shareError);
        }
      }

      // ë°©ë²• 2: í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬ + ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      try {
        await navigator.clipboard.writeText(shareText);
        console.log('Text copied to clipboard');
      } catch (clipErr) {
        console.warn('Clipboard copy failed:', clipErr);
      }

      // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'sori-phrase.png';
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      
      // ë°©ë²• 3: ì—¬ëŸ¬ Threads URL ì‹œë„
      const threadsUrls = [
        `https://threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/intent/post?text=${encodeURIComponent(shareText)}`,
        `https://threads.net/new?text=${encodeURIComponent(shareText)}`,
        `https://www.threads.net/new?text=${encodeURIComponent(shareText)}`
      ];
      
      console.log('Trying multiple Threads URLs:', threadsUrls);
      
      // ì²« ë²ˆì§¸ URLë¡œ ì‹œë„
      let success = false;
      for (let i = 0; i < threadsUrls.length; i++) {
        try {
          const newWindow = window.open(threadsUrls[i], '_blank', 'width=400,height=600');
          if (newWindow) {
            console.log(`Threads URL ${i+1} opened successfully`);
            success = true;
            break;
          }
        } catch (e) {
          console.log(`Threads URL ${i+1} failed:`, e);
        }
      }
      
      if (!success) {
        // ë°©ë²• 4: ì§ì ‘ ë§í¬ë¡œ ì´ë™
        console.log('Trying direct navigation');
        window.location.href = threadsUrls[0];
      }
      
      // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
      const t = document.getElementById('congrats');
      if (t) {
        t.textContent = 'ì´ë¯¸ì§€ ì €ì¥ë¨. í…ìŠ¤íŠ¸ëŠ” í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆì–´ìš”!';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      }
      
      // URL ì •ë¦¬
      setTimeout(() => URL.revokeObjectURL(url), 10000);
      
      try { 
        gtag('event', 'share_threads_multiple', {send_to: 'G-X1Q98DBKR5'}); 
      } catch(e) {}
      
    } catch(e) {
      console.error('Share failed:', e);
      // alert ì œê±°ë¨
    }
  }

  shareBtn && shareBtn.addEventListener('click', shareToThreads);
});
</script>

<div id="congrats" aria-live="polite"></div>

<footer id="appFooter">
  <div class="footer-content">
    <div class="footer-section">
      <h3 class="footer-title">About Sori</h3>
      <p class="footer-text">Sori helps people around the world feel closer to Korea through sound and stories.<br>
      Made in Seoul, for everyone who loves Korea.</p>
    </div>
    
    <div class="footer-section">
      <h3 class="footer-title">Contact</h3>
      <a href="mailto:sori.korea.official@gmail.com" class="footer-link">sori.korea.official@gmail.com</a>
    </div>
    
    <div class="footer-section">
      <h3 class="footer-title">Follow Us</h3>
      <a href="https://www.threads.com/@sori_by_minwoo" target="_blank" rel="noopener noreferrer" class="footer-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 2a8 8 0 110 16 8 8 0 010-16zm0 2a6 6 0 000 12 6 6 0 000-12z"/>
        </svg>
        @sori_by_minwoo
      </a>
    </div>
    
    <div class="footer-copyright">
      Â© 2025 Sori. All rights reserved.
    </div>
  </div>
</footer>

</body>
</html>
